{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar tinycolor = require('tinycolor2');\n\nvar Registry = require('../../registry');\n\nvar Lib = require('../../lib');\n\nvar strTranslate = Lib.strTranslate;\nvar _ = Lib._;\n\nvar Color = require('../../components/color');\n\nvar Drawing = require('../../components/drawing');\n\nvar setConvert = require('../cartesian/set_convert');\n\nvar extendFlat = require('../../lib/extend').extendFlat;\n\nvar Plots = require('../plots');\n\nvar Axes = require('../cartesian/axes');\n\nvar dragElement = require('../../components/dragelement');\n\nvar Fx = require('../../components/fx');\n\nvar dragHelpers = require('../../components/dragelement/helpers');\n\nvar freeMode = dragHelpers.freeMode;\nvar rectMode = dragHelpers.rectMode;\n\nvar Titles = require('../../components/titles');\n\nvar prepSelect = require('../cartesian/select').prepSelect;\n\nvar selectOnClick = require('../cartesian/select').selectOnClick;\n\nvar clearSelect = require('../cartesian/select').clearSelect;\n\nvar clearSelectionsCache = require('../cartesian/select').clearSelectionsCache;\n\nvar constants = require('../cartesian/constants');\n\nfunction Ternary(options, fullLayout) {\n  this.id = options.id;\n  this.graphDiv = options.graphDiv;\n  this.init(fullLayout);\n  this.makeFramework(fullLayout); // unfortunately, we have to keep track of some axis tick settings\n  // as ternary subplots do not implement the 'ticks' editType\n\n  this.aTickLayout = null;\n  this.bTickLayout = null;\n  this.cTickLayout = null;\n}\n\nmodule.exports = Ternary;\nvar proto = Ternary.prototype;\n\nproto.init = function (fullLayout) {\n  this.container = fullLayout._ternarylayer;\n  this.defs = fullLayout._defs;\n  this.layoutId = fullLayout._uid;\n  this.traceHash = {};\n  this.layers = {};\n};\n\nproto.plot = function (ternaryCalcData, fullLayout) {\n  var _this = this;\n\n  var ternaryLayout = fullLayout[_this.id];\n  var graphSize = fullLayout._size;\n  _this._hasClipOnAxisFalse = false;\n\n  for (var i = 0; i < ternaryCalcData.length; i++) {\n    var trace = ternaryCalcData[i][0].trace;\n\n    if (trace.cliponaxis === false) {\n      _this._hasClipOnAxisFalse = true;\n      break;\n    }\n  }\n\n  _this.updateLayers(ternaryLayout);\n\n  _this.adjustLayout(ternaryLayout, graphSize);\n\n  Plots.generalUpdatePerTraceModule(_this.graphDiv, _this, ternaryCalcData, ternaryLayout);\n\n  _this.layers.plotbg.select('path').call(Color.fill, ternaryLayout.bgcolor);\n};\n\nproto.makeFramework = function (fullLayout) {\n  var _this = this;\n\n  var gd = _this.graphDiv;\n  var ternaryLayout = fullLayout[_this.id];\n  var clipId = _this.clipId = 'clip' + _this.layoutId + _this.id;\n  var clipIdRelative = _this.clipIdRelative = 'clip-relative' + _this.layoutId + _this.id; // clippath for this ternary subplot\n\n  _this.clipDef = Lib.ensureSingleById(fullLayout._clips, 'clipPath', clipId, function (s) {\n    s.append('path').attr('d', 'M0,0Z');\n  }); // 'relative' clippath (i.e. no translation) for this ternary subplot\n\n  _this.clipDefRelative = Lib.ensureSingleById(fullLayout._clips, 'clipPath', clipIdRelative, function (s) {\n    s.append('path').attr('d', 'M0,0Z');\n  }); // container for everything in this ternary subplot\n\n  _this.plotContainer = Lib.ensureSingle(_this.container, 'g', _this.id);\n\n  _this.updateLayers(ternaryLayout);\n\n  Drawing.setClipUrl(_this.layers.backplot, clipId, gd);\n  Drawing.setClipUrl(_this.layers.grids, clipId, gd);\n};\n\nproto.updateLayers = function (ternaryLayout) {\n  var _this = this;\n\n  var layers = _this.layers; // inside that container, we have one container for the data, and\n  // one each for the three axes around it.\n\n  var plotLayers = ['draglayer', 'plotbg', 'backplot', 'grids'];\n\n  if (ternaryLayout.aaxis.layer === 'below traces') {\n    plotLayers.push('aaxis', 'aline');\n  }\n\n  if (ternaryLayout.baxis.layer === 'below traces') {\n    plotLayers.push('baxis', 'bline');\n  }\n\n  if (ternaryLayout.caxis.layer === 'below traces') {\n    plotLayers.push('caxis', 'cline');\n  }\n\n  plotLayers.push('frontplot');\n\n  if (ternaryLayout.aaxis.layer === 'above traces') {\n    plotLayers.push('aaxis', 'aline');\n  }\n\n  if (ternaryLayout.baxis.layer === 'above traces') {\n    plotLayers.push('baxis', 'bline');\n  }\n\n  if (ternaryLayout.caxis.layer === 'above traces') {\n    plotLayers.push('caxis', 'cline');\n  }\n\n  var toplevel = _this.plotContainer.selectAll('g.toplevel').data(plotLayers, String);\n\n  var grids = ['agrid', 'bgrid', 'cgrid'];\n  toplevel.enter().append('g').attr('class', function (d) {\n    return 'toplevel ' + d;\n  }).each(function (d) {\n    var s = d3.select(this);\n    layers[d] = s; // containers for different trace types.\n    // NOTE - this is different from cartesian, where all traces\n    // are in front of grids. Here I'm putting maps behind the grids\n    // so the grids will always be visible if they're requested.\n    // Perhaps we want that for cartesian too?\n\n    if (d === 'frontplot') {\n      s.append('g').classed('scatterlayer', true);\n    } else if (d === 'backplot') {\n      s.append('g').classed('maplayer', true);\n    } else if (d === 'plotbg') {\n      s.append('path').attr('d', 'M0,0Z');\n    } else if (d === 'aline' || d === 'bline' || d === 'cline') {\n      s.append('path');\n    } else if (d === 'grids') {\n      grids.forEach(function (d) {\n        layers[d] = s.append('g').classed('grid ' + d, true);\n      });\n    }\n  });\n  toplevel.order();\n};\n\nvar whRatio = Math.sqrt(4 / 3);\n\nproto.adjustLayout = function (ternaryLayout, graphSize) {\n  var _this = this;\n\n  var domain = ternaryLayout.domain;\n  var xDomainCenter = (domain.x[0] + domain.x[1]) / 2;\n  var yDomainCenter = (domain.y[0] + domain.y[1]) / 2;\n  var xDomain = domain.x[1] - domain.x[0];\n  var yDomain = domain.y[1] - domain.y[0];\n  var wmax = xDomain * graphSize.w;\n  var hmax = yDomain * graphSize.h;\n  var sum = ternaryLayout.sum;\n  var amin = ternaryLayout.aaxis.min;\n  var bmin = ternaryLayout.baxis.min;\n  var cmin = ternaryLayout.caxis.min;\n  var x0, y0, w, h, xDomainFinal, yDomainFinal;\n\n  if (wmax > whRatio * hmax) {\n    h = hmax;\n    w = h * whRatio;\n  } else {\n    w = wmax;\n    h = w / whRatio;\n  }\n\n  xDomainFinal = xDomain * w / wmax;\n  yDomainFinal = yDomain * h / hmax;\n  x0 = graphSize.l + graphSize.w * xDomainCenter - w / 2;\n  y0 = graphSize.t + graphSize.h * (1 - yDomainCenter) - h / 2;\n  _this.x0 = x0;\n  _this.y0 = y0;\n  _this.w = w;\n  _this.h = h;\n  _this.sum = sum; // set up the x and y axis objects we'll use to lay out the points\n\n  _this.xaxis = {\n    type: 'linear',\n    range: [amin + 2 * cmin - sum, sum - amin - 2 * bmin],\n    domain: [xDomainCenter - xDomainFinal / 2, xDomainCenter + xDomainFinal / 2],\n    _id: 'x'\n  };\n  setConvert(_this.xaxis, _this.graphDiv._fullLayout);\n\n  _this.xaxis.setScale();\n\n  _this.xaxis.isPtWithinRange = function (d) {\n    return d.a >= _this.aaxis.range[0] && d.a <= _this.aaxis.range[1] && d.b >= _this.baxis.range[1] && d.b <= _this.baxis.range[0] && d.c >= _this.caxis.range[1] && d.c <= _this.caxis.range[0];\n  };\n\n  _this.yaxis = {\n    type: 'linear',\n    range: [amin, sum - bmin - cmin],\n    domain: [yDomainCenter - yDomainFinal / 2, yDomainCenter + yDomainFinal / 2],\n    _id: 'y'\n  };\n  setConvert(_this.yaxis, _this.graphDiv._fullLayout);\n\n  _this.yaxis.setScale();\n\n  _this.yaxis.isPtWithinRange = function () {\n    return true;\n  }; // set up the modified axes for tick drawing\n\n\n  var yDomain0 = _this.yaxis.domain[0]; // aaxis goes up the left side. Set it up as a y axis, but with\n  // fictitious angles and domain, but then rotate and translate\n  // it into place at the end\n\n  var aaxis = _this.aaxis = extendFlat({}, ternaryLayout.aaxis, {\n    range: [amin, sum - bmin - cmin],\n    side: 'left',\n    // tickangle = 'auto' means 0 anyway for a y axis, need to coerce to 0 here\n    // so we can shift by 30.\n    tickangle: (+ternaryLayout.aaxis.tickangle || 0) - 30,\n    domain: [yDomain0, yDomain0 + yDomainFinal * whRatio],\n    anchor: 'free',\n    position: 0,\n    _id: 'y',\n    _length: w\n  });\n  setConvert(aaxis, _this.graphDiv._fullLayout);\n  aaxis.setScale(); // baxis goes across the bottom (backward). We can set it up as an x axis\n  // without any enclosing transformation.\n\n  var baxis = _this.baxis = extendFlat({}, ternaryLayout.baxis, {\n    range: [sum - amin - cmin, bmin],\n    side: 'bottom',\n    domain: _this.xaxis.domain,\n    anchor: 'free',\n    position: 0,\n    _id: 'x',\n    _length: w\n  });\n  setConvert(baxis, _this.graphDiv._fullLayout);\n  baxis.setScale(); // caxis goes down the right side. Set it up as a y axis, with\n  // post-transformation similar to aaxis\n\n  var caxis = _this.caxis = extendFlat({}, ternaryLayout.caxis, {\n    range: [sum - amin - bmin, cmin],\n    side: 'right',\n    tickangle: (+ternaryLayout.caxis.tickangle || 0) + 30,\n    domain: [yDomain0, yDomain0 + yDomainFinal * whRatio],\n    anchor: 'free',\n    position: 0,\n    _id: 'y',\n    _length: w\n  });\n  setConvert(caxis, _this.graphDiv._fullLayout);\n  caxis.setScale();\n  var triangleClip = 'M' + x0 + ',' + (y0 + h) + 'h' + w + 'l-' + w / 2 + ',-' + h + 'Z';\n\n  _this.clipDef.select('path').attr('d', triangleClip);\n\n  _this.layers.plotbg.select('path').attr('d', triangleClip);\n\n  var triangleClipRelative = 'M0,' + h + 'h' + w + 'l-' + w / 2 + ',-' + h + 'Z';\n\n  _this.clipDefRelative.select('path').attr('d', triangleClipRelative);\n\n  var plotTransform = strTranslate(x0, y0);\n\n  _this.plotContainer.selectAll('.scatterlayer,.maplayer').attr('transform', plotTransform);\n\n  _this.clipDefRelative.select('path').attr('transform', null); // TODO: shift axes to accommodate linewidth*sin(30) tick mark angle\n  // TODO: there's probably an easier way to handle these translations/offsets now...\n\n\n  var bTransform = strTranslate(x0 - baxis._offset, y0 + h);\n\n  _this.layers.baxis.attr('transform', bTransform);\n\n  _this.layers.bgrid.attr('transform', bTransform);\n\n  var aTransform = strTranslate(x0 + w / 2, y0) + 'rotate(30)' + strTranslate(0, -aaxis._offset);\n\n  _this.layers.aaxis.attr('transform', aTransform);\n\n  _this.layers.agrid.attr('transform', aTransform);\n\n  var cTransform = strTranslate(x0 + w / 2, y0) + 'rotate(-30)' + strTranslate(0, -caxis._offset);\n\n  _this.layers.caxis.attr('transform', cTransform);\n\n  _this.layers.cgrid.attr('transform', cTransform);\n\n  _this.drawAxes(true);\n\n  _this.layers.aline.select('path').attr('d', aaxis.showline ? 'M' + x0 + ',' + (y0 + h) + 'l' + w / 2 + ',-' + h : 'M0,0').call(Color.stroke, aaxis.linecolor || '#000').style('stroke-width', (aaxis.linewidth || 0) + 'px');\n\n  _this.layers.bline.select('path').attr('d', baxis.showline ? 'M' + x0 + ',' + (y0 + h) + 'h' + w : 'M0,0').call(Color.stroke, baxis.linecolor || '#000').style('stroke-width', (baxis.linewidth || 0) + 'px');\n\n  _this.layers.cline.select('path').attr('d', caxis.showline ? 'M' + (x0 + w / 2) + ',' + y0 + 'l' + w / 2 + ',' + h : 'M0,0').call(Color.stroke, caxis.linecolor || '#000').style('stroke-width', (caxis.linewidth || 0) + 'px');\n\n  if (!_this.graphDiv._context.staticPlot) {\n    _this.initInteractions();\n  }\n\n  Drawing.setClipUrl(_this.layers.frontplot, _this._hasClipOnAxisFalse ? null : _this.clipId, _this.graphDiv);\n};\n\nproto.drawAxes = function (doTitles) {\n  var _this = this;\n\n  var gd = _this.graphDiv;\n  var titlesuffix = _this.id.substr(7) + 'title';\n  var layers = _this.layers;\n  var aaxis = _this.aaxis;\n  var baxis = _this.baxis;\n  var caxis = _this.caxis;\n\n  _this.drawAx(aaxis);\n\n  _this.drawAx(baxis);\n\n  _this.drawAx(caxis);\n\n  if (doTitles) {\n    var apad = Math.max(aaxis.showticklabels ? aaxis.tickfont.size / 2 : 0, (caxis.showticklabels ? caxis.tickfont.size * 0.75 : 0) + (caxis.ticks === 'outside' ? caxis.ticklen * 0.87 : 0));\n    var bpad = (baxis.showticklabels ? baxis.tickfont.size : 0) + (baxis.ticks === 'outside' ? baxis.ticklen : 0) + 3;\n    layers['a-title'] = Titles.draw(gd, 'a' + titlesuffix, {\n      propContainer: aaxis,\n      propName: _this.id + '.aaxis.title',\n      placeholder: _(gd, 'Click to enter Component A title'),\n      attributes: {\n        x: _this.x0 + _this.w / 2,\n        y: _this.y0 - aaxis.title.font.size / 3 - apad,\n        'text-anchor': 'middle'\n      }\n    });\n    layers['b-title'] = Titles.draw(gd, 'b' + titlesuffix, {\n      propContainer: baxis,\n      propName: _this.id + '.baxis.title',\n      placeholder: _(gd, 'Click to enter Component B title'),\n      attributes: {\n        x: _this.x0 - bpad,\n        y: _this.y0 + _this.h + baxis.title.font.size * 0.83 + bpad,\n        'text-anchor': 'middle'\n      }\n    });\n    layers['c-title'] = Titles.draw(gd, 'c' + titlesuffix, {\n      propContainer: caxis,\n      propName: _this.id + '.caxis.title',\n      placeholder: _(gd, 'Click to enter Component C title'),\n      attributes: {\n        x: _this.x0 + _this.w + bpad,\n        y: _this.y0 + _this.h + caxis.title.font.size * 0.83 + bpad,\n        'text-anchor': 'middle'\n      }\n    });\n  }\n};\n\nproto.drawAx = function (ax) {\n  var _this = this;\n\n  var gd = _this.graphDiv;\n  var axName = ax._name;\n  var axLetter = axName.charAt(0);\n  var axId = ax._id;\n  var axLayer = _this.layers[axName];\n  var counterAngle = 30;\n  var stashKey = axLetter + 'tickLayout';\n  var newTickLayout = strTickLayout(ax);\n\n  if (_this[stashKey] !== newTickLayout) {\n    axLayer.selectAll('.' + axId + 'tick').remove();\n    _this[stashKey] = newTickLayout;\n  }\n\n  ax.setScale();\n  var vals = Axes.calcTicks(ax);\n  var valsClipped = Axes.clipEnds(ax, vals);\n  var transFn = Axes.makeTransTickFn(ax);\n  var tickSign = Axes.getTickSigns(ax)[2];\n  var caRad = Lib.deg2rad(counterAngle);\n  var pad = tickSign * (ax.linewidth || 1) / 2;\n  var len = tickSign * ax.ticklen;\n  var w = _this.w;\n  var h = _this.h;\n  var tickPath = axLetter === 'b' ? 'M0,' + pad + 'l' + Math.sin(caRad) * len + ',' + Math.cos(caRad) * len : 'M' + pad + ',0l' + Math.cos(caRad) * len + ',' + -Math.sin(caRad) * len;\n  var gridPath = {\n    a: 'M0,0l' + h + ',-' + w / 2,\n    b: 'M0,0l-' + w / 2 + ',-' + h,\n    c: 'M0,0l-' + h + ',' + w / 2\n  }[axLetter];\n  Axes.drawTicks(gd, ax, {\n    vals: ax.ticks === 'inside' ? valsClipped : vals,\n    layer: axLayer,\n    path: tickPath,\n    transFn: transFn,\n    crisp: false\n  });\n  Axes.drawGrid(gd, ax, {\n    vals: valsClipped,\n    layer: _this.layers[axLetter + 'grid'],\n    path: gridPath,\n    transFn: transFn,\n    crisp: false\n  });\n  Axes.drawLabels(gd, ax, {\n    vals: vals,\n    layer: axLayer,\n    transFn: transFn,\n    labelFns: Axes.makeLabelFns(ax, 0, counterAngle)\n  });\n};\n\nfunction strTickLayout(axLayout) {\n  return axLayout.ticks + String(axLayout.ticklen) + String(axLayout.showticklabels);\n} // hard coded paths for zoom corners\n// uses the same sizing as cartesian, length is MINZOOM/2, width is 3px\n\n\nvar CLEN = constants.MINZOOM / 2 + 0.87;\nvar BLPATH = 'm-0.87,.5h' + CLEN + 'v3h-' + (CLEN + 5.2) + 'l' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) + 'l2.6,1.5l-' + CLEN / 2 + ',' + CLEN * 0.87 + 'Z';\nvar BRPATH = 'm0.87,.5h-' + CLEN + 'v3h' + (CLEN + 5.2) + 'l-' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) + 'l-2.6,1.5l' + CLEN / 2 + ',' + CLEN * 0.87 + 'Z';\nvar TOPPATH = 'm0,1l' + CLEN / 2 + ',' + CLEN * 0.87 + 'l2.6,-1.5l-' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) + 'l-' + (CLEN / 2 + 2.6) + ',' + (CLEN * 0.87 + 4.5) + 'l2.6,1.5l' + CLEN / 2 + ',-' + CLEN * 0.87 + 'Z';\nvar STARTMARKER = 'm0.5,0.5h5v-2h-5v-5h-2v5h-5v2h5v5h2Z'; // I guess this could be shared with cartesian... but for now it's separate.\n\nvar SHOWZOOMOUTTIP = true;\n\nproto.clearSelect = function () {\n  clearSelectionsCache(this.dragOptions);\n  clearSelect(this.dragOptions.gd);\n};\n\nproto.initInteractions = function () {\n  var _this = this;\n\n  var dragger = _this.layers.plotbg.select('path').node();\n\n  var gd = _this.graphDiv;\n  var zoomLayer = gd._fullLayout._zoomlayer;\n  var scaleX;\n  var scaleY; // use plotbg for the main interactions\n\n  this.dragOptions = {\n    element: dragger,\n    gd: gd,\n    plotinfo: {\n      id: _this.id,\n      domain: gd._fullLayout[_this.id].domain,\n      xaxis: _this.xaxis,\n      yaxis: _this.yaxis\n    },\n    subplot: _this.id,\n    prepFn: function (e, startX, startY) {\n      // these aren't available yet when initInteractions\n      // is called\n      _this.dragOptions.xaxes = [_this.xaxis];\n      _this.dragOptions.yaxes = [_this.yaxis];\n      scaleX = gd._fullLayout._invScaleX;\n      scaleY = gd._fullLayout._invScaleY;\n      var dragModeNow = _this.dragOptions.dragmode = gd._fullLayout.dragmode;\n      if (freeMode(dragModeNow)) _this.dragOptions.minDrag = 1;else _this.dragOptions.minDrag = undefined;\n\n      if (dragModeNow === 'zoom') {\n        _this.dragOptions.moveFn = zoomMove;\n        _this.dragOptions.clickFn = clickZoomPan;\n        _this.dragOptions.doneFn = zoomDone;\n        zoomPrep(e, startX, startY);\n      } else if (dragModeNow === 'pan') {\n        _this.dragOptions.moveFn = plotDrag;\n        _this.dragOptions.clickFn = clickZoomPan;\n        _this.dragOptions.doneFn = dragDone;\n        panPrep();\n\n        _this.clearSelect(gd);\n      } else if (rectMode(dragModeNow) || freeMode(dragModeNow)) {\n        prepSelect(e, startX, startY, _this.dragOptions, dragModeNow);\n      }\n    }\n  };\n  var x0, y0, mins0, span0, mins, lum, path0, dimmed, zb, corners;\n\n  function makeUpdate(_mins) {\n    var attrs = {};\n    attrs[_this.id + '.aaxis.min'] = _mins.a;\n    attrs[_this.id + '.baxis.min'] = _mins.b;\n    attrs[_this.id + '.caxis.min'] = _mins.c;\n    return attrs;\n  }\n\n  function clickZoomPan(numClicks, evt) {\n    var clickMode = gd._fullLayout.clickmode;\n    removeZoombox(gd);\n\n    if (numClicks === 2) {\n      gd.emit('plotly_doubleclick', null);\n      Registry.call('_guiRelayout', gd, makeUpdate({\n        a: 0,\n        b: 0,\n        c: 0\n      }));\n    }\n\n    if (clickMode.indexOf('select') > -1 && numClicks === 1) {\n      selectOnClick(evt, gd, [_this.xaxis], [_this.yaxis], _this.id, _this.dragOptions);\n    }\n\n    if (clickMode.indexOf('event') > -1) {\n      Fx.click(gd, evt, _this.id);\n    }\n  }\n\n  function zoomPrep(e, startX, startY) {\n    var dragBBox = dragger.getBoundingClientRect();\n    x0 = startX - dragBBox.left;\n    y0 = startY - dragBBox.top;\n\n    gd._fullLayout._calcInverseTransform(gd);\n\n    var inverse = gd._fullLayout._invTransform;\n    var transformedCoords = Lib.apply3DTransform(inverse)(x0, y0);\n    x0 = transformedCoords[0];\n    y0 = transformedCoords[1];\n    mins0 = {\n      a: _this.aaxis.range[0],\n      b: _this.baxis.range[1],\n      c: _this.caxis.range[1]\n    };\n    mins = mins0;\n    span0 = _this.aaxis.range[1] - mins0.a;\n    lum = tinycolor(_this.graphDiv._fullLayout[_this.id].bgcolor).getLuminance();\n    path0 = 'M0,' + _this.h + 'L' + _this.w / 2 + ', 0L' + _this.w + ',' + _this.h + 'Z';\n    dimmed = false;\n    zb = zoomLayer.append('path').attr('class', 'zoombox').attr('transform', strTranslate(_this.x0, _this.y0)).style({\n      'fill': lum > 0.2 ? 'rgba(0,0,0,0)' : 'rgba(255,255,255,0)',\n      'stroke-width': 0\n    }).attr('d', path0);\n    corners = zoomLayer.append('path').attr('class', 'zoombox-corners').attr('transform', strTranslate(_this.x0, _this.y0)).style({\n      fill: Color.background,\n      stroke: Color.defaultLine,\n      'stroke-width': 1,\n      opacity: 0\n    }).attr('d', 'M0,0Z');\n\n    _this.clearSelect(gd);\n  }\n\n  function getAFrac(x, y) {\n    return 1 - y / _this.h;\n  }\n\n  function getBFrac(x, y) {\n    return 1 - (x + (_this.h - y) / Math.sqrt(3)) / _this.w;\n  }\n\n  function getCFrac(x, y) {\n    return (x - (_this.h - y) / Math.sqrt(3)) / _this.w;\n  }\n\n  function zoomMove(dx0, dy0) {\n    var x1 = x0 + dx0 * scaleX;\n    var y1 = y0 + dy0 * scaleY;\n    var afrac = Math.max(0, Math.min(1, getAFrac(x0, y0), getAFrac(x1, y1)));\n    var bfrac = Math.max(0, Math.min(1, getBFrac(x0, y0), getBFrac(x1, y1)));\n    var cfrac = Math.max(0, Math.min(1, getCFrac(x0, y0), getCFrac(x1, y1)));\n    var xLeft = (afrac / 2 + cfrac) * _this.w;\n    var xRight = (1 - afrac / 2 - bfrac) * _this.w;\n    var xCenter = (xLeft + xRight) / 2;\n    var xSpan = xRight - xLeft;\n    var yBottom = (1 - afrac) * _this.h;\n    var yTop = yBottom - xSpan / whRatio;\n\n    if (xSpan < constants.MINZOOM) {\n      mins = mins0;\n      zb.attr('d', path0);\n      corners.attr('d', 'M0,0Z');\n    } else {\n      mins = {\n        a: mins0.a + afrac * span0,\n        b: mins0.b + bfrac * span0,\n        c: mins0.c + cfrac * span0\n      };\n      zb.attr('d', path0 + 'M' + xLeft + ',' + yBottom + 'H' + xRight + 'L' + xCenter + ',' + yTop + 'L' + xLeft + ',' + yBottom + 'Z');\n      corners.attr('d', 'M' + x0 + ',' + y0 + STARTMARKER + 'M' + xLeft + ',' + yBottom + BLPATH + 'M' + xRight + ',' + yBottom + BRPATH + 'M' + xCenter + ',' + yTop + TOPPATH);\n    }\n\n    if (!dimmed) {\n      zb.transition().style('fill', lum > 0.2 ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.3)').duration(200);\n      corners.transition().style('opacity', 1).duration(200);\n      dimmed = true;\n    }\n\n    gd.emit('plotly_relayouting', makeUpdate(mins));\n  }\n\n  function zoomDone() {\n    removeZoombox(gd);\n    if (mins === mins0) return;\n    Registry.call('_guiRelayout', gd, makeUpdate(mins));\n\n    if (SHOWZOOMOUTTIP && gd.data && gd._context.showTips) {\n      Lib.notifier(_(gd, 'Double-click to zoom back out'), 'long');\n      SHOWZOOMOUTTIP = false;\n    }\n  }\n\n  function panPrep() {\n    mins0 = {\n      a: _this.aaxis.range[0],\n      b: _this.baxis.range[1],\n      c: _this.caxis.range[1]\n    };\n    mins = mins0;\n  }\n\n  function plotDrag(dx, dy) {\n    var dxScaled = dx / _this.xaxis._m;\n    var dyScaled = dy / _this.yaxis._m;\n    mins = {\n      a: mins0.a - dyScaled,\n      b: mins0.b + (dxScaled + dyScaled) / 2,\n      c: mins0.c - (dxScaled - dyScaled) / 2\n    };\n    var minsorted = [mins.a, mins.b, mins.c].sort(Lib.sorterAsc);\n    var minindices = {\n      a: minsorted.indexOf(mins.a),\n      b: minsorted.indexOf(mins.b),\n      c: minsorted.indexOf(mins.c)\n    };\n\n    if (minsorted[0] < 0) {\n      if (minsorted[1] + minsorted[0] / 2 < 0) {\n        minsorted[2] += minsorted[0] + minsorted[1];\n        minsorted[0] = minsorted[1] = 0;\n      } else {\n        minsorted[2] += minsorted[0] / 2;\n        minsorted[1] += minsorted[0] / 2;\n        minsorted[0] = 0;\n      }\n\n      mins = {\n        a: minsorted[minindices.a],\n        b: minsorted[minindices.b],\n        c: minsorted[minindices.c]\n      };\n      dy = (mins0.a - mins.a) * _this.yaxis._m;\n      dx = (mins0.c - mins.c - mins0.b + mins.b) * _this.xaxis._m;\n    } // move the data (translate, don't redraw)\n\n\n    var plotTransform = strTranslate(_this.x0 + dx, _this.y0 + dy);\n\n    _this.plotContainer.selectAll('.scatterlayer,.maplayer').attr('transform', plotTransform);\n\n    var plotTransform2 = strTranslate(-dx, -dy);\n\n    _this.clipDefRelative.select('path').attr('transform', plotTransform2); // move the ticks\n\n\n    _this.aaxis.range = [mins.a, _this.sum - mins.b - mins.c];\n    _this.baxis.range = [_this.sum - mins.a - mins.c, mins.b];\n    _this.caxis.range = [_this.sum - mins.a - mins.b, mins.c];\n\n    _this.drawAxes(false);\n\n    if (_this._hasClipOnAxisFalse) {\n      _this.plotContainer.select('.scatterlayer').selectAll('.trace').call(Drawing.hideOutsideRangePoints, _this);\n    }\n\n    gd.emit('plotly_relayouting', makeUpdate(mins));\n  }\n\n  function dragDone() {\n    Registry.call('_guiRelayout', gd, makeUpdate(mins));\n  } // finally, set up hover and click\n  // these event handlers must already be set before dragElement.init\n  // so it can stash them and override them.\n\n\n  dragger.onmousemove = function (evt) {\n    Fx.hover(gd, evt, _this.id);\n    gd._fullLayout._lasthover = dragger;\n    gd._fullLayout._hoversubplot = _this.id;\n  };\n\n  dragger.onmouseout = function (evt) {\n    if (gd._dragging) return;\n    dragElement.unhover(gd, evt);\n  };\n\n  dragElement.init(this.dragOptions);\n};\n\nfunction removeZoombox(gd) {\n  d3.select(gd).selectAll('.zoombox,.js-zoombox-backdrop,.js-zoombox-menu,.zoombox-corners').remove();\n}","map":{"version":3,"sources":["C:/Users/mikke/VSC/fantasy-django-react/fantasy-django/fantasy-react-app/node_modules/plotly.js/src/plots/ternary/ternary.js"],"names":["d3","require","tinycolor","Registry","Lib","strTranslate","_","Color","Drawing","setConvert","extendFlat","Plots","Axes","dragElement","Fx","dragHelpers","freeMode","rectMode","Titles","prepSelect","selectOnClick","clearSelect","clearSelectionsCache","constants","Ternary","options","fullLayout","id","graphDiv","init","makeFramework","aTickLayout","bTickLayout","cTickLayout","module","exports","proto","prototype","container","_ternarylayer","defs","_defs","layoutId","_uid","traceHash","layers","plot","ternaryCalcData","_this","ternaryLayout","graphSize","_size","_hasClipOnAxisFalse","i","length","trace","cliponaxis","updateLayers","adjustLayout","generalUpdatePerTraceModule","plotbg","select","call","fill","bgcolor","gd","clipId","clipIdRelative","clipDef","ensureSingleById","_clips","s","append","attr","clipDefRelative","plotContainer","ensureSingle","setClipUrl","backplot","grids","plotLayers","aaxis","layer","push","baxis","caxis","toplevel","selectAll","data","String","enter","d","each","classed","forEach","order","whRatio","Math","sqrt","domain","xDomainCenter","x","yDomainCenter","y","xDomain","yDomain","wmax","w","hmax","h","sum","amin","min","bmin","cmin","x0","y0","xDomainFinal","yDomainFinal","l","t","xaxis","type","range","_id","_fullLayout","setScale","isPtWithinRange","a","b","c","yaxis","yDomain0","side","tickangle","anchor","position","_length","triangleClip","triangleClipRelative","plotTransform","bTransform","_offset","bgrid","aTransform","agrid","cTransform","cgrid","drawAxes","aline","showline","stroke","linecolor","style","linewidth","bline","cline","_context","staticPlot","initInteractions","frontplot","doTitles","titlesuffix","substr","drawAx","apad","max","showticklabels","tickfont","size","ticks","ticklen","bpad","draw","propContainer","propName","placeholder","attributes","title","font","ax","axName","_name","axLetter","charAt","axId","axLayer","counterAngle","stashKey","newTickLayout","strTickLayout","remove","vals","calcTicks","valsClipped","clipEnds","transFn","makeTransTickFn","tickSign","getTickSigns","caRad","deg2rad","pad","len","tickPath","sin","cos","gridPath","drawTicks","path","crisp","drawGrid","drawLabels","labelFns","makeLabelFns","axLayout","CLEN","MINZOOM","BLPATH","BRPATH","TOPPATH","STARTMARKER","SHOWZOOMOUTTIP","dragOptions","dragger","node","zoomLayer","_zoomlayer","scaleX","scaleY","element","plotinfo","subplot","prepFn","e","startX","startY","xaxes","yaxes","_invScaleX","_invScaleY","dragModeNow","dragmode","minDrag","undefined","moveFn","zoomMove","clickFn","clickZoomPan","doneFn","zoomDone","zoomPrep","plotDrag","dragDone","panPrep","mins0","span0","mins","lum","path0","dimmed","zb","corners","makeUpdate","_mins","attrs","numClicks","evt","clickMode","clickmode","removeZoombox","emit","indexOf","click","dragBBox","getBoundingClientRect","left","top","_calcInverseTransform","inverse","_invTransform","transformedCoords","apply3DTransform","getLuminance","background","defaultLine","opacity","getAFrac","getBFrac","getCFrac","dx0","dy0","x1","y1","afrac","bfrac","cfrac","xLeft","xRight","xCenter","xSpan","yBottom","yTop","transition","duration","showTips","notifier","dx","dy","dxScaled","_m","dyScaled","minsorted","sort","sorterAsc","minindices","plotTransform2","hideOutsideRangePoints","onmousemove","hover","_lasthover","_hoversubplot","onmouseout","_dragging","unhover"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar d3 = require('@plotly/d3');\r\nvar tinycolor = require('tinycolor2');\r\n\r\nvar Registry = require('../../registry');\r\nvar Lib = require('../../lib');\r\nvar strTranslate = Lib.strTranslate;\r\nvar _ = Lib._;\r\nvar Color = require('../../components/color');\r\nvar Drawing = require('../../components/drawing');\r\nvar setConvert = require('../cartesian/set_convert');\r\nvar extendFlat = require('../../lib/extend').extendFlat;\r\nvar Plots = require('../plots');\r\nvar Axes = require('../cartesian/axes');\r\nvar dragElement = require('../../components/dragelement');\r\nvar Fx = require('../../components/fx');\r\nvar dragHelpers = require('../../components/dragelement/helpers');\r\nvar freeMode = dragHelpers.freeMode;\r\nvar rectMode = dragHelpers.rectMode;\r\nvar Titles = require('../../components/titles');\r\nvar prepSelect = require('../cartesian/select').prepSelect;\r\nvar selectOnClick = require('../cartesian/select').selectOnClick;\r\nvar clearSelect = require('../cartesian/select').clearSelect;\r\nvar clearSelectionsCache = require('../cartesian/select').clearSelectionsCache;\r\nvar constants = require('../cartesian/constants');\r\n\r\nfunction Ternary(options, fullLayout) {\r\n    this.id = options.id;\r\n    this.graphDiv = options.graphDiv;\r\n    this.init(fullLayout);\r\n    this.makeFramework(fullLayout);\r\n\r\n    // unfortunately, we have to keep track of some axis tick settings\r\n    // as ternary subplots do not implement the 'ticks' editType\r\n    this.aTickLayout = null;\r\n    this.bTickLayout = null;\r\n    this.cTickLayout = null;\r\n}\r\n\r\nmodule.exports = Ternary;\r\n\r\nvar proto = Ternary.prototype;\r\n\r\nproto.init = function(fullLayout) {\r\n    this.container = fullLayout._ternarylayer;\r\n    this.defs = fullLayout._defs;\r\n    this.layoutId = fullLayout._uid;\r\n    this.traceHash = {};\r\n    this.layers = {};\r\n};\r\n\r\nproto.plot = function(ternaryCalcData, fullLayout) {\r\n    var _this = this;\r\n    var ternaryLayout = fullLayout[_this.id];\r\n    var graphSize = fullLayout._size;\r\n\r\n    _this._hasClipOnAxisFalse = false;\r\n    for(var i = 0; i < ternaryCalcData.length; i++) {\r\n        var trace = ternaryCalcData[i][0].trace;\r\n\r\n        if(trace.cliponaxis === false) {\r\n            _this._hasClipOnAxisFalse = true;\r\n            break;\r\n        }\r\n    }\r\n\r\n    _this.updateLayers(ternaryLayout);\r\n    _this.adjustLayout(ternaryLayout, graphSize);\r\n    Plots.generalUpdatePerTraceModule(_this.graphDiv, _this, ternaryCalcData, ternaryLayout);\r\n    _this.layers.plotbg.select('path').call(Color.fill, ternaryLayout.bgcolor);\r\n};\r\n\r\nproto.makeFramework = function(fullLayout) {\r\n    var _this = this;\r\n    var gd = _this.graphDiv;\r\n    var ternaryLayout = fullLayout[_this.id];\r\n\r\n    var clipId = _this.clipId = 'clip' + _this.layoutId + _this.id;\r\n    var clipIdRelative = _this.clipIdRelative = 'clip-relative' + _this.layoutId + _this.id;\r\n\r\n    // clippath for this ternary subplot\r\n    _this.clipDef = Lib.ensureSingleById(fullLayout._clips, 'clipPath', clipId, function(s) {\r\n        s.append('path').attr('d', 'M0,0Z');\r\n    });\r\n\r\n    // 'relative' clippath (i.e. no translation) for this ternary subplot\r\n    _this.clipDefRelative = Lib.ensureSingleById(fullLayout._clips, 'clipPath', clipIdRelative, function(s) {\r\n        s.append('path').attr('d', 'M0,0Z');\r\n    });\r\n\r\n    // container for everything in this ternary subplot\r\n    _this.plotContainer = Lib.ensureSingle(_this.container, 'g', _this.id);\r\n    _this.updateLayers(ternaryLayout);\r\n\r\n    Drawing.setClipUrl(_this.layers.backplot, clipId, gd);\r\n    Drawing.setClipUrl(_this.layers.grids, clipId, gd);\r\n};\r\n\r\nproto.updateLayers = function(ternaryLayout) {\r\n    var _this = this;\r\n    var layers = _this.layers;\r\n\r\n    // inside that container, we have one container for the data, and\r\n    // one each for the three axes around it.\r\n\r\n    var plotLayers = ['draglayer', 'plotbg', 'backplot', 'grids'];\r\n\r\n    if(ternaryLayout.aaxis.layer === 'below traces') {\r\n        plotLayers.push('aaxis', 'aline');\r\n    }\r\n    if(ternaryLayout.baxis.layer === 'below traces') {\r\n        plotLayers.push('baxis', 'bline');\r\n    }\r\n    if(ternaryLayout.caxis.layer === 'below traces') {\r\n        plotLayers.push('caxis', 'cline');\r\n    }\r\n\r\n    plotLayers.push('frontplot');\r\n\r\n    if(ternaryLayout.aaxis.layer === 'above traces') {\r\n        plotLayers.push('aaxis', 'aline');\r\n    }\r\n    if(ternaryLayout.baxis.layer === 'above traces') {\r\n        plotLayers.push('baxis', 'bline');\r\n    }\r\n    if(ternaryLayout.caxis.layer === 'above traces') {\r\n        plotLayers.push('caxis', 'cline');\r\n    }\r\n\r\n    var toplevel = _this.plotContainer.selectAll('g.toplevel')\r\n        .data(plotLayers, String);\r\n\r\n    var grids = ['agrid', 'bgrid', 'cgrid'];\r\n\r\n    toplevel.enter().append('g')\r\n        .attr('class', function(d) { return 'toplevel ' + d; })\r\n        .each(function(d) {\r\n            var s = d3.select(this);\r\n            layers[d] = s;\r\n\r\n            // containers for different trace types.\r\n            // NOTE - this is different from cartesian, where all traces\r\n            // are in front of grids. Here I'm putting maps behind the grids\r\n            // so the grids will always be visible if they're requested.\r\n            // Perhaps we want that for cartesian too?\r\n            if(d === 'frontplot') {\r\n                s.append('g').classed('scatterlayer', true);\r\n            } else if(d === 'backplot') {\r\n                s.append('g').classed('maplayer', true);\r\n            } else if(d === 'plotbg') {\r\n                s.append('path').attr('d', 'M0,0Z');\r\n            } else if(d === 'aline' || d === 'bline' || d === 'cline') {\r\n                s.append('path');\r\n            } else if(d === 'grids') {\r\n                grids.forEach(function(d) {\r\n                    layers[d] = s.append('g').classed('grid ' + d, true);\r\n                });\r\n            }\r\n        });\r\n\r\n    toplevel.order();\r\n};\r\n\r\nvar whRatio = Math.sqrt(4 / 3);\r\n\r\nproto.adjustLayout = function(ternaryLayout, graphSize) {\r\n    var _this = this;\r\n    var domain = ternaryLayout.domain;\r\n    var xDomainCenter = (domain.x[0] + domain.x[1]) / 2;\r\n    var yDomainCenter = (domain.y[0] + domain.y[1]) / 2;\r\n    var xDomain = domain.x[1] - domain.x[0];\r\n    var yDomain = domain.y[1] - domain.y[0];\r\n    var wmax = xDomain * graphSize.w;\r\n    var hmax = yDomain * graphSize.h;\r\n    var sum = ternaryLayout.sum;\r\n    var amin = ternaryLayout.aaxis.min;\r\n    var bmin = ternaryLayout.baxis.min;\r\n    var cmin = ternaryLayout.caxis.min;\r\n\r\n    var x0, y0, w, h, xDomainFinal, yDomainFinal;\r\n\r\n    if(wmax > whRatio * hmax) {\r\n        h = hmax;\r\n        w = h * whRatio;\r\n    } else {\r\n        w = wmax;\r\n        h = w / whRatio;\r\n    }\r\n\r\n    xDomainFinal = xDomain * w / wmax;\r\n    yDomainFinal = yDomain * h / hmax;\r\n\r\n    x0 = graphSize.l + graphSize.w * xDomainCenter - w / 2;\r\n    y0 = graphSize.t + graphSize.h * (1 - yDomainCenter) - h / 2;\r\n\r\n    _this.x0 = x0;\r\n    _this.y0 = y0;\r\n    _this.w = w;\r\n    _this.h = h;\r\n    _this.sum = sum;\r\n\r\n    // set up the x and y axis objects we'll use to lay out the points\r\n    _this.xaxis = {\r\n        type: 'linear',\r\n        range: [amin + 2 * cmin - sum, sum - amin - 2 * bmin],\r\n        domain: [\r\n            xDomainCenter - xDomainFinal / 2,\r\n            xDomainCenter + xDomainFinal / 2\r\n        ],\r\n        _id: 'x'\r\n    };\r\n    setConvert(_this.xaxis, _this.graphDiv._fullLayout);\r\n    _this.xaxis.setScale();\r\n    _this.xaxis.isPtWithinRange = function(d) {\r\n        return (\r\n            d.a >= _this.aaxis.range[0] &&\r\n            d.a <= _this.aaxis.range[1] &&\r\n            d.b >= _this.baxis.range[1] &&\r\n            d.b <= _this.baxis.range[0] &&\r\n            d.c >= _this.caxis.range[1] &&\r\n            d.c <= _this.caxis.range[0]\r\n        );\r\n    };\r\n\r\n    _this.yaxis = {\r\n        type: 'linear',\r\n        range: [amin, sum - bmin - cmin],\r\n        domain: [\r\n            yDomainCenter - yDomainFinal / 2,\r\n            yDomainCenter + yDomainFinal / 2\r\n        ],\r\n        _id: 'y'\r\n    };\r\n    setConvert(_this.yaxis, _this.graphDiv._fullLayout);\r\n    _this.yaxis.setScale();\r\n    _this.yaxis.isPtWithinRange = function() { return true; };\r\n\r\n    // set up the modified axes for tick drawing\r\n    var yDomain0 = _this.yaxis.domain[0];\r\n\r\n    // aaxis goes up the left side. Set it up as a y axis, but with\r\n    // fictitious angles and domain, but then rotate and translate\r\n    // it into place at the end\r\n    var aaxis = _this.aaxis = extendFlat({}, ternaryLayout.aaxis, {\r\n        range: [amin, sum - bmin - cmin],\r\n        side: 'left',\r\n        // tickangle = 'auto' means 0 anyway for a y axis, need to coerce to 0 here\r\n        // so we can shift by 30.\r\n        tickangle: (+ternaryLayout.aaxis.tickangle || 0) - 30,\r\n        domain: [yDomain0, yDomain0 + yDomainFinal * whRatio],\r\n        anchor: 'free',\r\n        position: 0,\r\n        _id: 'y',\r\n        _length: w\r\n    });\r\n    setConvert(aaxis, _this.graphDiv._fullLayout);\r\n    aaxis.setScale();\r\n\r\n    // baxis goes across the bottom (backward). We can set it up as an x axis\r\n    // without any enclosing transformation.\r\n    var baxis = _this.baxis = extendFlat({}, ternaryLayout.baxis, {\r\n        range: [sum - amin - cmin, bmin],\r\n        side: 'bottom',\r\n        domain: _this.xaxis.domain,\r\n        anchor: 'free',\r\n        position: 0,\r\n        _id: 'x',\r\n        _length: w\r\n    });\r\n    setConvert(baxis, _this.graphDiv._fullLayout);\r\n    baxis.setScale();\r\n\r\n    // caxis goes down the right side. Set it up as a y axis, with\r\n    // post-transformation similar to aaxis\r\n    var caxis = _this.caxis = extendFlat({}, ternaryLayout.caxis, {\r\n        range: [sum - amin - bmin, cmin],\r\n        side: 'right',\r\n        tickangle: (+ternaryLayout.caxis.tickangle || 0) + 30,\r\n        domain: [yDomain0, yDomain0 + yDomainFinal * whRatio],\r\n        anchor: 'free',\r\n        position: 0,\r\n        _id: 'y',\r\n        _length: w\r\n    });\r\n    setConvert(caxis, _this.graphDiv._fullLayout);\r\n    caxis.setScale();\r\n\r\n    var triangleClip = 'M' + x0 + ',' + (y0 + h) + 'h' + w + 'l-' + (w / 2) + ',-' + h + 'Z';\r\n    _this.clipDef.select('path').attr('d', triangleClip);\r\n    _this.layers.plotbg.select('path').attr('d', triangleClip);\r\n\r\n    var triangleClipRelative = 'M0,' + h + 'h' + w + 'l-' + (w / 2) + ',-' + h + 'Z';\r\n    _this.clipDefRelative.select('path').attr('d', triangleClipRelative);\r\n\r\n    var plotTransform = strTranslate(x0, y0);\r\n    _this.plotContainer.selectAll('.scatterlayer,.maplayer')\r\n        .attr('transform', plotTransform);\r\n\r\n    _this.clipDefRelative.select('path').attr('transform', null);\r\n\r\n    // TODO: shift axes to accommodate linewidth*sin(30) tick mark angle\r\n\r\n    // TODO: there's probably an easier way to handle these translations/offsets now...\r\n    var bTransform = strTranslate(x0 - baxis._offset, y0 + h);\r\n\r\n    _this.layers.baxis.attr('transform', bTransform);\r\n    _this.layers.bgrid.attr('transform', bTransform);\r\n\r\n    var aTransform = strTranslate(x0 + w / 2, y0) +\r\n        'rotate(30)' + strTranslate(0, -aaxis._offset);\r\n    _this.layers.aaxis.attr('transform', aTransform);\r\n    _this.layers.agrid.attr('transform', aTransform);\r\n\r\n    var cTransform = strTranslate(x0 + w / 2, y0) +\r\n        'rotate(-30)' + strTranslate(0, -caxis._offset);\r\n    _this.layers.caxis.attr('transform', cTransform);\r\n    _this.layers.cgrid.attr('transform', cTransform);\r\n\r\n    _this.drawAxes(true);\r\n\r\n    _this.layers.aline.select('path')\r\n        .attr('d', aaxis.showline ?\r\n            'M' + x0 + ',' + (y0 + h) + 'l' + (w / 2) + ',-' + h : 'M0,0')\r\n        .call(Color.stroke, aaxis.linecolor || '#000')\r\n        .style('stroke-width', (aaxis.linewidth || 0) + 'px');\r\n    _this.layers.bline.select('path')\r\n        .attr('d', baxis.showline ?\r\n            'M' + x0 + ',' + (y0 + h) + 'h' + w : 'M0,0')\r\n        .call(Color.stroke, baxis.linecolor || '#000')\r\n        .style('stroke-width', (baxis.linewidth || 0) + 'px');\r\n    _this.layers.cline.select('path')\r\n        .attr('d', caxis.showline ?\r\n            'M' + (x0 + w / 2) + ',' + y0 + 'l' + (w / 2) + ',' + h : 'M0,0')\r\n        .call(Color.stroke, caxis.linecolor || '#000')\r\n        .style('stroke-width', (caxis.linewidth || 0) + 'px');\r\n\r\n    if(!_this.graphDiv._context.staticPlot) {\r\n        _this.initInteractions();\r\n    }\r\n\r\n    Drawing.setClipUrl(\r\n        _this.layers.frontplot,\r\n        _this._hasClipOnAxisFalse ? null : _this.clipId,\r\n        _this.graphDiv\r\n    );\r\n};\r\n\r\nproto.drawAxes = function(doTitles) {\r\n    var _this = this;\r\n    var gd = _this.graphDiv;\r\n    var titlesuffix = _this.id.substr(7) + 'title';\r\n    var layers = _this.layers;\r\n    var aaxis = _this.aaxis;\r\n    var baxis = _this.baxis;\r\n    var caxis = _this.caxis;\r\n\r\n    _this.drawAx(aaxis);\r\n    _this.drawAx(baxis);\r\n    _this.drawAx(caxis);\r\n\r\n    if(doTitles) {\r\n        var apad = Math.max(aaxis.showticklabels ? aaxis.tickfont.size / 2 : 0,\r\n            (caxis.showticklabels ? caxis.tickfont.size * 0.75 : 0) +\r\n            (caxis.ticks === 'outside' ? caxis.ticklen * 0.87 : 0));\r\n        var bpad = (baxis.showticklabels ? baxis.tickfont.size : 0) +\r\n            (baxis.ticks === 'outside' ? baxis.ticklen : 0) + 3;\r\n\r\n        layers['a-title'] = Titles.draw(gd, 'a' + titlesuffix, {\r\n            propContainer: aaxis,\r\n            propName: _this.id + '.aaxis.title',\r\n            placeholder: _(gd, 'Click to enter Component A title'),\r\n            attributes: {\r\n                x: _this.x0 + _this.w / 2,\r\n                y: _this.y0 - aaxis.title.font.size / 3 - apad,\r\n                'text-anchor': 'middle'\r\n            }\r\n        });\r\n        layers['b-title'] = Titles.draw(gd, 'b' + titlesuffix, {\r\n            propContainer: baxis,\r\n            propName: _this.id + '.baxis.title',\r\n            placeholder: _(gd, 'Click to enter Component B title'),\r\n            attributes: {\r\n                x: _this.x0 - bpad,\r\n                y: _this.y0 + _this.h + baxis.title.font.size * 0.83 + bpad,\r\n                'text-anchor': 'middle'\r\n            }\r\n        });\r\n        layers['c-title'] = Titles.draw(gd, 'c' + titlesuffix, {\r\n            propContainer: caxis,\r\n            propName: _this.id + '.caxis.title',\r\n            placeholder: _(gd, 'Click to enter Component C title'),\r\n            attributes: {\r\n                x: _this.x0 + _this.w + bpad,\r\n                y: _this.y0 + _this.h + caxis.title.font.size * 0.83 + bpad,\r\n                'text-anchor': 'middle'\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nproto.drawAx = function(ax) {\r\n    var _this = this;\r\n    var gd = _this.graphDiv;\r\n    var axName = ax._name;\r\n    var axLetter = axName.charAt(0);\r\n    var axId = ax._id;\r\n    var axLayer = _this.layers[axName];\r\n    var counterAngle = 30;\r\n\r\n    var stashKey = axLetter + 'tickLayout';\r\n    var newTickLayout = strTickLayout(ax);\r\n    if(_this[stashKey] !== newTickLayout) {\r\n        axLayer.selectAll('.' + axId + 'tick').remove();\r\n        _this[stashKey] = newTickLayout;\r\n    }\r\n\r\n    ax.setScale();\r\n\r\n    var vals = Axes.calcTicks(ax);\r\n    var valsClipped = Axes.clipEnds(ax, vals);\r\n    var transFn = Axes.makeTransTickFn(ax);\r\n    var tickSign = Axes.getTickSigns(ax)[2];\r\n\r\n    var caRad = Lib.deg2rad(counterAngle);\r\n    var pad = tickSign * (ax.linewidth || 1) / 2;\r\n    var len = tickSign * ax.ticklen;\r\n    var w = _this.w;\r\n    var h = _this.h;\r\n\r\n    var tickPath = axLetter === 'b' ?\r\n        'M0,' + pad + 'l' + (Math.sin(caRad) * len) + ',' + (Math.cos(caRad) * len) :\r\n        'M' + pad + ',0l' + (Math.cos(caRad) * len) + ',' + (-Math.sin(caRad) * len);\r\n\r\n    var gridPath = {\r\n        a: 'M0,0l' + h + ',-' + (w / 2),\r\n        b: 'M0,0l-' + (w / 2) + ',-' + h,\r\n        c: 'M0,0l-' + h + ',' + (w / 2)\r\n    }[axLetter];\r\n\r\n    Axes.drawTicks(gd, ax, {\r\n        vals: ax.ticks === 'inside' ? valsClipped : vals,\r\n        layer: axLayer,\r\n        path: tickPath,\r\n        transFn: transFn,\r\n        crisp: false\r\n    });\r\n\r\n    Axes.drawGrid(gd, ax, {\r\n        vals: valsClipped,\r\n        layer: _this.layers[axLetter + 'grid'],\r\n        path: gridPath,\r\n        transFn: transFn,\r\n        crisp: false\r\n    });\r\n\r\n    Axes.drawLabels(gd, ax, {\r\n        vals: vals,\r\n        layer: axLayer,\r\n        transFn: transFn,\r\n        labelFns: Axes.makeLabelFns(ax, 0, counterAngle)\r\n    });\r\n};\r\n\r\nfunction strTickLayout(axLayout) {\r\n    return axLayout.ticks + String(axLayout.ticklen) + String(axLayout.showticklabels);\r\n}\r\n\r\n// hard coded paths for zoom corners\r\n// uses the same sizing as cartesian, length is MINZOOM/2, width is 3px\r\nvar CLEN = constants.MINZOOM / 2 + 0.87;\r\nvar BLPATH = 'm-0.87,.5h' + CLEN + 'v3h-' + (CLEN + 5.2) +\r\n    'l' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) +\r\n    'l2.6,1.5l-' + (CLEN / 2) + ',' + (CLEN * 0.87) + 'Z';\r\nvar BRPATH = 'm0.87,.5h-' + CLEN + 'v3h' + (CLEN + 5.2) +\r\n    'l-' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) +\r\n    'l-2.6,1.5l' + (CLEN / 2) + ',' + (CLEN * 0.87) + 'Z';\r\nvar TOPPATH = 'm0,1l' + (CLEN / 2) + ',' + (CLEN * 0.87) +\r\n    'l2.6,-1.5l-' + (CLEN / 2 + 2.6) + ',-' + (CLEN * 0.87 + 4.5) +\r\n    'l-' + (CLEN / 2 + 2.6) + ',' + (CLEN * 0.87 + 4.5) +\r\n    'l2.6,1.5l' + (CLEN / 2) + ',-' + (CLEN * 0.87) + 'Z';\r\nvar STARTMARKER = 'm0.5,0.5h5v-2h-5v-5h-2v5h-5v2h5v5h2Z';\r\n\r\n// I guess this could be shared with cartesian... but for now it's separate.\r\nvar SHOWZOOMOUTTIP = true;\r\n\r\nproto.clearSelect = function() {\r\n    clearSelectionsCache(this.dragOptions);\r\n    clearSelect(this.dragOptions.gd);\r\n};\r\n\r\nproto.initInteractions = function() {\r\n    var _this = this;\r\n    var dragger = _this.layers.plotbg.select('path').node();\r\n    var gd = _this.graphDiv;\r\n    var zoomLayer = gd._fullLayout._zoomlayer;\r\n    var scaleX;\r\n    var scaleY;\r\n\r\n    // use plotbg for the main interactions\r\n    this.dragOptions = {\r\n        element: dragger,\r\n        gd: gd,\r\n        plotinfo: {\r\n            id: _this.id,\r\n            domain: gd._fullLayout[_this.id].domain,\r\n            xaxis: _this.xaxis,\r\n            yaxis: _this.yaxis\r\n        },\r\n        subplot: _this.id,\r\n        prepFn: function(e, startX, startY) {\r\n            // these aren't available yet when initInteractions\r\n            // is called\r\n            _this.dragOptions.xaxes = [_this.xaxis];\r\n            _this.dragOptions.yaxes = [_this.yaxis];\r\n\r\n            scaleX = gd._fullLayout._invScaleX;\r\n            scaleY = gd._fullLayout._invScaleY;\r\n\r\n            var dragModeNow = _this.dragOptions.dragmode = gd._fullLayout.dragmode;\r\n\r\n            if(freeMode(dragModeNow)) _this.dragOptions.minDrag = 1;\r\n            else _this.dragOptions.minDrag = undefined;\r\n\r\n            if(dragModeNow === 'zoom') {\r\n                _this.dragOptions.moveFn = zoomMove;\r\n                _this.dragOptions.clickFn = clickZoomPan;\r\n                _this.dragOptions.doneFn = zoomDone;\r\n                zoomPrep(e, startX, startY);\r\n            } else if(dragModeNow === 'pan') {\r\n                _this.dragOptions.moveFn = plotDrag;\r\n                _this.dragOptions.clickFn = clickZoomPan;\r\n                _this.dragOptions.doneFn = dragDone;\r\n                panPrep();\r\n                _this.clearSelect(gd);\r\n            } else if(rectMode(dragModeNow) || freeMode(dragModeNow)) {\r\n                prepSelect(e, startX, startY, _this.dragOptions, dragModeNow);\r\n            }\r\n        }\r\n    };\r\n\r\n    var x0, y0, mins0, span0, mins, lum, path0, dimmed, zb, corners;\r\n\r\n    function makeUpdate(_mins) {\r\n        var attrs = {};\r\n        attrs[_this.id + '.aaxis.min'] = _mins.a;\r\n        attrs[_this.id + '.baxis.min'] = _mins.b;\r\n        attrs[_this.id + '.caxis.min'] = _mins.c;\r\n        return attrs;\r\n    }\r\n\r\n    function clickZoomPan(numClicks, evt) {\r\n        var clickMode = gd._fullLayout.clickmode;\r\n\r\n        removeZoombox(gd);\r\n\r\n        if(numClicks === 2) {\r\n            gd.emit('plotly_doubleclick', null);\r\n            Registry.call('_guiRelayout', gd, makeUpdate({a: 0, b: 0, c: 0}));\r\n        }\r\n\r\n        if(clickMode.indexOf('select') > -1 && numClicks === 1) {\r\n            selectOnClick(evt, gd, [_this.xaxis], [_this.yaxis], _this.id, _this.dragOptions);\r\n        }\r\n\r\n        if(clickMode.indexOf('event') > -1) {\r\n            Fx.click(gd, evt, _this.id);\r\n        }\r\n    }\r\n\r\n    function zoomPrep(e, startX, startY) {\r\n        var dragBBox = dragger.getBoundingClientRect();\r\n        x0 = startX - dragBBox.left;\r\n        y0 = startY - dragBBox.top;\r\n\r\n        gd._fullLayout._calcInverseTransform(gd);\r\n        var inverse = gd._fullLayout._invTransform;\r\n        var transformedCoords = Lib.apply3DTransform(inverse)(x0, y0);\r\n        x0 = transformedCoords[0];\r\n        y0 = transformedCoords[1];\r\n\r\n        mins0 = {\r\n            a: _this.aaxis.range[0],\r\n            b: _this.baxis.range[1],\r\n            c: _this.caxis.range[1]\r\n        };\r\n        mins = mins0;\r\n        span0 = _this.aaxis.range[1] - mins0.a;\r\n        lum = tinycolor(_this.graphDiv._fullLayout[_this.id].bgcolor).getLuminance();\r\n        path0 = 'M0,' + _this.h + 'L' + (_this.w / 2) + ', 0L' + _this.w + ',' + _this.h + 'Z';\r\n        dimmed = false;\r\n\r\n        zb = zoomLayer.append('path')\r\n            .attr('class', 'zoombox')\r\n            .attr('transform', strTranslate(_this.x0, _this.y0))\r\n            .style({\r\n                'fill': lum > 0.2 ? 'rgba(0,0,0,0)' : 'rgba(255,255,255,0)',\r\n                'stroke-width': 0\r\n            })\r\n            .attr('d', path0);\r\n\r\n        corners = zoomLayer.append('path')\r\n            .attr('class', 'zoombox-corners')\r\n            .attr('transform', strTranslate(_this.x0, _this.y0))\r\n            .style({\r\n                fill: Color.background,\r\n                stroke: Color.defaultLine,\r\n                'stroke-width': 1,\r\n                opacity: 0\r\n            })\r\n            .attr('d', 'M0,0Z');\r\n\r\n        _this.clearSelect(gd);\r\n    }\r\n\r\n    function getAFrac(x, y) { return 1 - (y / _this.h); }\r\n    function getBFrac(x, y) { return 1 - ((x + (_this.h - y) / Math.sqrt(3)) / _this.w); }\r\n    function getCFrac(x, y) { return ((x - (_this.h - y) / Math.sqrt(3)) / _this.w); }\r\n\r\n    function zoomMove(dx0, dy0) {\r\n        var x1 = x0 + dx0 * scaleX;\r\n        var y1 = y0 + dy0 * scaleY;\r\n        var afrac = Math.max(0, Math.min(1, getAFrac(x0, y0), getAFrac(x1, y1)));\r\n        var bfrac = Math.max(0, Math.min(1, getBFrac(x0, y0), getBFrac(x1, y1)));\r\n        var cfrac = Math.max(0, Math.min(1, getCFrac(x0, y0), getCFrac(x1, y1)));\r\n        var xLeft = ((afrac / 2) + cfrac) * _this.w;\r\n        var xRight = (1 - (afrac / 2) - bfrac) * _this.w;\r\n        var xCenter = (xLeft + xRight) / 2;\r\n        var xSpan = xRight - xLeft;\r\n        var yBottom = (1 - afrac) * _this.h;\r\n        var yTop = yBottom - xSpan / whRatio;\r\n\r\n        if(xSpan < constants.MINZOOM) {\r\n            mins = mins0;\r\n            zb.attr('d', path0);\r\n            corners.attr('d', 'M0,0Z');\r\n        } else {\r\n            mins = {\r\n                a: mins0.a + afrac * span0,\r\n                b: mins0.b + bfrac * span0,\r\n                c: mins0.c + cfrac * span0\r\n            };\r\n            zb.attr('d', path0 + 'M' + xLeft + ',' + yBottom +\r\n                'H' + xRight + 'L' + xCenter + ',' + yTop +\r\n                'L' + xLeft + ',' + yBottom + 'Z');\r\n            corners.attr('d', 'M' + x0 + ',' + y0 + STARTMARKER +\r\n                'M' + xLeft + ',' + yBottom + BLPATH +\r\n                'M' + xRight + ',' + yBottom + BRPATH +\r\n                'M' + xCenter + ',' + yTop + TOPPATH);\r\n        }\r\n\r\n        if(!dimmed) {\r\n            zb.transition()\r\n                .style('fill', lum > 0.2 ? 'rgba(0,0,0,0.4)' :\r\n                    'rgba(255,255,255,0.3)')\r\n                .duration(200);\r\n            corners.transition()\r\n                .style('opacity', 1)\r\n                .duration(200);\r\n            dimmed = true;\r\n        }\r\n\r\n        gd.emit('plotly_relayouting', makeUpdate(mins));\r\n    }\r\n\r\n    function zoomDone() {\r\n        removeZoombox(gd);\r\n\r\n        if(mins === mins0) return;\r\n\r\n        Registry.call('_guiRelayout', gd, makeUpdate(mins));\r\n\r\n        if(SHOWZOOMOUTTIP && gd.data && gd._context.showTips) {\r\n            Lib.notifier(_(gd, 'Double-click to zoom back out'), 'long');\r\n            SHOWZOOMOUTTIP = false;\r\n        }\r\n    }\r\n\r\n    function panPrep() {\r\n        mins0 = {\r\n            a: _this.aaxis.range[0],\r\n            b: _this.baxis.range[1],\r\n            c: _this.caxis.range[1]\r\n        };\r\n        mins = mins0;\r\n    }\r\n\r\n    function plotDrag(dx, dy) {\r\n        var dxScaled = dx / _this.xaxis._m;\r\n        var dyScaled = dy / _this.yaxis._m;\r\n        mins = {\r\n            a: mins0.a - dyScaled,\r\n            b: mins0.b + (dxScaled + dyScaled) / 2,\r\n            c: mins0.c - (dxScaled - dyScaled) / 2\r\n        };\r\n        var minsorted = [mins.a, mins.b, mins.c].sort(Lib.sorterAsc);\r\n        var minindices = {\r\n            a: minsorted.indexOf(mins.a),\r\n            b: minsorted.indexOf(mins.b),\r\n            c: minsorted.indexOf(mins.c)\r\n        };\r\n        if(minsorted[0] < 0) {\r\n            if(minsorted[1] + minsorted[0] / 2 < 0) {\r\n                minsorted[2] += minsorted[0] + minsorted[1];\r\n                minsorted[0] = minsorted[1] = 0;\r\n            } else {\r\n                minsorted[2] += minsorted[0] / 2;\r\n                minsorted[1] += minsorted[0] / 2;\r\n                minsorted[0] = 0;\r\n            }\r\n            mins = {\r\n                a: minsorted[minindices.a],\r\n                b: minsorted[minindices.b],\r\n                c: minsorted[minindices.c]\r\n            };\r\n            dy = (mins0.a - mins.a) * _this.yaxis._m;\r\n            dx = (mins0.c - mins.c - mins0.b + mins.b) * _this.xaxis._m;\r\n        }\r\n\r\n        // move the data (translate, don't redraw)\r\n        var plotTransform = strTranslate(_this.x0 + dx, _this.y0 + dy);\r\n        _this.plotContainer.selectAll('.scatterlayer,.maplayer')\r\n            .attr('transform', plotTransform);\r\n\r\n        var plotTransform2 = strTranslate(-dx, -dy);\r\n        _this.clipDefRelative.select('path').attr('transform', plotTransform2);\r\n\r\n        // move the ticks\r\n        _this.aaxis.range = [mins.a, _this.sum - mins.b - mins.c];\r\n        _this.baxis.range = [_this.sum - mins.a - mins.c, mins.b];\r\n        _this.caxis.range = [_this.sum - mins.a - mins.b, mins.c];\r\n\r\n        _this.drawAxes(false);\r\n\r\n        if(_this._hasClipOnAxisFalse) {\r\n            _this.plotContainer\r\n                .select('.scatterlayer').selectAll('.trace')\r\n                .call(Drawing.hideOutsideRangePoints, _this);\r\n        }\r\n\r\n        gd.emit('plotly_relayouting', makeUpdate(mins));\r\n    }\r\n\r\n    function dragDone() {\r\n        Registry.call('_guiRelayout', gd, makeUpdate(mins));\r\n    }\r\n\r\n    // finally, set up hover and click\r\n    // these event handlers must already be set before dragElement.init\r\n    // so it can stash them and override them.\r\n    dragger.onmousemove = function(evt) {\r\n        Fx.hover(gd, evt, _this.id);\r\n        gd._fullLayout._lasthover = dragger;\r\n        gd._fullLayout._hoversubplot = _this.id;\r\n    };\r\n\r\n    dragger.onmouseout = function(evt) {\r\n        if(gd._dragging) return;\r\n\r\n        dragElement.unhover(gd, evt);\r\n    };\r\n\r\n    dragElement.init(this.dragOptions);\r\n};\r\n\r\nfunction removeZoombox(gd) {\r\n    d3.select(gd)\r\n        .selectAll('.zoombox,.js-zoombox-backdrop,.js-zoombox-menu,.zoombox-corners')\r\n        .remove();\r\n}\r\n"]},"metadata":{},"sourceType":"script"}