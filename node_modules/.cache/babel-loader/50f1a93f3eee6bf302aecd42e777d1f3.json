{"ast":null,"code":"'use strict';\n\nvar d3 = require('@plotly/d3');\n\nvar isNumeric = require('fast-isnumeric');\n\nvar tinycolor = require('tinycolor2');\n\nvar Registry = require('../../registry');\n\nvar Color = require('../color');\n\nvar Colorscale = require('../colorscale');\n\nvar Lib = require('../../lib');\n\nvar strTranslate = Lib.strTranslate;\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\n\nvar alignment = require('../../constants/alignment');\n\nvar LINE_SPACING = alignment.LINE_SPACING;\n\nvar DESELECTDIM = require('../../constants/interactions').DESELECTDIM;\n\nvar subTypes = require('../../traces/scatter/subtypes');\n\nvar makeBubbleSizeFn = require('../../traces/scatter/make_bubble_size_func');\n\nvar appendArrayPointValue = require('../../components/fx/helpers').appendArrayPointValue;\n\nvar drawing = module.exports = {}; // -----------------------------------------------------\n// styling functions for plot elements\n// -----------------------------------------------------\n\ndrawing.font = function (s, family, size, color) {\n  // also allow the form font(s, {family, size, color})\n  if (Lib.isPlainObject(family)) {\n    color = family.color;\n    size = family.size;\n    family = family.family;\n  }\n\n  if (family) s.style('font-family', family);\n  if (size + 1) s.style('font-size', size + 'px');\n  if (color) s.call(Color.fill, color);\n};\n/*\r\n * Positioning helpers\r\n * Note: do not use `setPosition` with <text> nodes modified by\r\n * `svgTextUtils.convertToTspans`. Use `svgTextUtils.positionText`\r\n * instead, so that <tspan.line> elements get updated to match.\r\n */\n\n\ndrawing.setPosition = function (s, x, y) {\n  s.attr('x', x).attr('y', y);\n};\n\ndrawing.setSize = function (s, w, h) {\n  s.attr('width', w).attr('height', h);\n};\n\ndrawing.setRect = function (s, x, y, w, h) {\n  s.call(drawing.setPosition, x, y).call(drawing.setSize, w, h);\n};\n/** Translate node\r\n *\r\n * @param {object} d : calcdata point item\r\n * @param {sel} sel : d3 selction of node to translate\r\n * @param {object} xa : corresponding full xaxis object\r\n * @param {object} ya : corresponding full yaxis object\r\n *\r\n * @return {boolean} :\r\n *  true if selection got translated\r\n *  false if selection could not get translated\r\n */\n\n\ndrawing.translatePoint = function (d, sel, xa, ya) {\n  var x = xa.c2p(d.x);\n  var y = ya.c2p(d.y);\n\n  if (isNumeric(x) && isNumeric(y) && sel.node()) {\n    // for multiline text this works better\n    if (sel.node().nodeName === 'text') {\n      sel.attr('x', x).attr('y', y);\n    } else {\n      sel.attr('transform', strTranslate(x, y));\n    }\n  } else {\n    return false;\n  }\n\n  return true;\n};\n\ndrawing.translatePoints = function (s, xa, ya) {\n  s.each(function (d) {\n    var sel = d3.select(this);\n    drawing.translatePoint(d, sel, xa, ya);\n  });\n};\n\ndrawing.hideOutsideRangePoint = function (d, sel, xa, ya, xcalendar, ycalendar) {\n  sel.attr('display', xa.isPtWithinRange(d, xcalendar) && ya.isPtWithinRange(d, ycalendar) ? null : 'none');\n};\n\ndrawing.hideOutsideRangePoints = function (traceGroups, subplot) {\n  if (!subplot._hasClipOnAxisFalse) return;\n  var xa = subplot.xaxis;\n  var ya = subplot.yaxis;\n  traceGroups.each(function (d) {\n    var trace = d[0].trace;\n    var xcalendar = trace.xcalendar;\n    var ycalendar = trace.ycalendar;\n    var selector = Registry.traceIs(trace, 'bar-like') ? '.bartext' : '.point,.textpoint';\n    traceGroups.selectAll(selector).each(function (d) {\n      drawing.hideOutsideRangePoint(d, d3.select(this), xa, ya, xcalendar, ycalendar);\n    });\n  });\n};\n\ndrawing.crispRound = function (gd, lineWidth, dflt) {\n  // for lines that disable antialiasing we want to\n  // make sure the width is an integer, and at least 1 if it's nonzero\n  if (!lineWidth || !isNumeric(lineWidth)) return dflt || 0; // but not for static plots - these don't get antialiased anyway.\n\n  if (gd._context.staticPlot) return lineWidth;\n  if (lineWidth < 1) return 1;\n  return Math.round(lineWidth);\n};\n\ndrawing.singleLineStyle = function (d, s, lw, lc, ld) {\n  s.style('fill', 'none');\n  var line = (((d || [])[0] || {}).trace || {}).line || {};\n  var lw1 = lw || line.width || 0;\n  var dash = ld || line.dash || '';\n  Color.stroke(s, lc || line.color);\n  drawing.dashLine(s, dash, lw1);\n};\n\ndrawing.lineGroupStyle = function (s, lw, lc, ld) {\n  s.style('fill', 'none').each(function (d) {\n    var line = (((d || [])[0] || {}).trace || {}).line || {};\n    var lw1 = lw || line.width || 0;\n    var dash = ld || line.dash || '';\n    d3.select(this).call(Color.stroke, lc || line.color).call(drawing.dashLine, dash, lw1);\n  });\n};\n\ndrawing.dashLine = function (s, dash, lineWidth) {\n  lineWidth = +lineWidth || 0;\n  dash = drawing.dashStyle(dash, lineWidth);\n  s.style({\n    'stroke-dasharray': dash,\n    'stroke-width': lineWidth + 'px'\n  });\n};\n\ndrawing.dashStyle = function (dash, lineWidth) {\n  lineWidth = +lineWidth || 1;\n  var dlw = Math.max(lineWidth, 3);\n  if (dash === 'solid') dash = '';else if (dash === 'dot') dash = dlw + 'px,' + dlw + 'px';else if (dash === 'dash') dash = 3 * dlw + 'px,' + 3 * dlw + 'px';else if (dash === 'longdash') dash = 5 * dlw + 'px,' + 5 * dlw + 'px';else if (dash === 'dashdot') {\n    dash = 3 * dlw + 'px,' + dlw + 'px,' + dlw + 'px,' + dlw + 'px';\n  } else if (dash === 'longdashdot') {\n    dash = 5 * dlw + 'px,' + 2 * dlw + 'px,' + dlw + 'px,' + 2 * dlw + 'px';\n  } // otherwise user wrote the dasharray themselves - leave it be\n\n  return dash;\n}; // Same as fillGroupStyle, except in this case the selection may be a transition\n\n\ndrawing.singleFillStyle = function (sel) {\n  var node = d3.select(sel.node());\n  var data = node.data();\n  var fillcolor = (((data[0] || [])[0] || {}).trace || {}).fillcolor;\n\n  if (fillcolor) {\n    sel.call(Color.fill, fillcolor);\n  }\n};\n\ndrawing.fillGroupStyle = function (s) {\n  s.style('stroke-width', 0).each(function (d) {\n    var shape = d3.select(this); // N.B. 'd' won't be a calcdata item when\n    // fill !== 'none' on a segment-less and marker-less trace\n\n    if (d[0].trace) {\n      shape.call(Color.fill, d[0].trace.fillcolor);\n    }\n  });\n};\n\nvar SYMBOLDEFS = require('./symbol_defs');\n\ndrawing.symbolNames = [];\ndrawing.symbolFuncs = [];\ndrawing.symbolNeedLines = {};\ndrawing.symbolNoDot = {};\ndrawing.symbolNoFill = {};\ndrawing.symbolList = [];\nObject.keys(SYMBOLDEFS).forEach(function (k) {\n  var symDef = SYMBOLDEFS[k];\n  var n = symDef.n;\n  drawing.symbolList.push(n, String(n), k, n + 100, String(n + 100), k + '-open');\n  drawing.symbolNames[n] = k;\n  drawing.symbolFuncs[n] = symDef.f;\n\n  if (symDef.needLine) {\n    drawing.symbolNeedLines[n] = true;\n  }\n\n  if (symDef.noDot) {\n    drawing.symbolNoDot[n] = true;\n  } else {\n    drawing.symbolList.push(n + 200, String(n + 200), k + '-dot', n + 300, String(n + 300), k + '-open-dot');\n  }\n\n  if (symDef.noFill) {\n    drawing.symbolNoFill[n] = true;\n  }\n});\nvar MAXSYMBOL = drawing.symbolNames.length; // add a dot in the middle of the symbol\n\nvar DOTPATH = 'M0,0.5L0.5,0L0,-0.5L-0.5,0Z';\n\ndrawing.symbolNumber = function (v) {\n  if (isNumeric(v)) {\n    v = +v;\n  } else if (typeof v === 'string') {\n    var vbase = 0;\n\n    if (v.indexOf('-open') > 0) {\n      vbase = 100;\n      v = v.replace('-open', '');\n    }\n\n    if (v.indexOf('-dot') > 0) {\n      vbase += 200;\n      v = v.replace('-dot', '');\n    }\n\n    v = drawing.symbolNames.indexOf(v);\n\n    if (v >= 0) {\n      v += vbase;\n    }\n  }\n\n  return v % 100 >= MAXSYMBOL || v >= 400 ? 0 : Math.floor(Math.max(v, 0));\n};\n\nfunction makePointPath(symbolNumber, r) {\n  var base = symbolNumber % 100;\n  return drawing.symbolFuncs[base](r) + (symbolNumber >= 200 ? DOTPATH : '');\n}\n\nvar HORZGRADIENT = {\n  x1: 1,\n  x2: 0,\n  y1: 0,\n  y2: 0\n};\nvar VERTGRADIENT = {\n  x1: 0,\n  x2: 0,\n  y1: 1,\n  y2: 0\n};\nvar stopFormatter = d3.format('~.1f');\nvar gradientInfo = {\n  radial: {\n    node: 'radialGradient'\n  },\n  radialreversed: {\n    node: 'radialGradient',\n    reversed: true\n  },\n  horizontal: {\n    node: 'linearGradient',\n    attrs: HORZGRADIENT\n  },\n  horizontalreversed: {\n    node: 'linearGradient',\n    attrs: HORZGRADIENT,\n    reversed: true\n  },\n  vertical: {\n    node: 'linearGradient',\n    attrs: VERTGRADIENT\n  },\n  verticalreversed: {\n    node: 'linearGradient',\n    attrs: VERTGRADIENT,\n    reversed: true\n  }\n};\n/**\r\n * gradient: create and apply a gradient fill\r\n *\r\n * @param {object} sel: d3 selection to apply this gradient to\r\n *     You can use `selection.call(Drawing.gradient, ...)`\r\n * @param {DOM element} gd: the graph div `sel` is part of\r\n * @param {string} gradientID: a unique (within this plot) identifier\r\n *     for this gradient, so that we don't create unnecessary definitions\r\n * @param {string} type: 'radial', 'horizontal', or 'vertical', optionally with\r\n *     'reversed' at the end. Normally radial goes center to edge,\r\n *     horizontal goes right to left, and vertical goes bottom to top\r\n * @param {array} colorscale: as in attribute values, [[fraction, color], ...]\r\n * @param {string} prop: the property to apply to, 'fill' or 'stroke'\r\n */\n\ndrawing.gradient = function (sel, gd, gradientID, type, colorscale, prop) {\n  var len = colorscale.length;\n  var info = gradientInfo[type];\n  var colorStops = new Array(len);\n\n  for (var i = 0; i < len; i++) {\n    if (info.reversed) {\n      colorStops[len - 1 - i] = [stopFormatter((1 - colorscale[i][0]) * 100), colorscale[i][1]];\n    } else {\n      colorStops[i] = [stopFormatter(colorscale[i][0] * 100), colorscale[i][1]];\n    }\n  }\n\n  var fullLayout = gd._fullLayout;\n  var fullID = 'g' + fullLayout._uid + '-' + gradientID;\n\n  var gradient = fullLayout._defs.select('.gradients').selectAll('#' + fullID).data([type + colorStops.join(';')], Lib.identity);\n\n  gradient.exit().remove();\n  gradient.enter().append(info.node).each(function () {\n    var el = d3.select(this);\n    if (info.attrs) el.attr(info.attrs);\n    el.attr('id', fullID);\n    var stops = el.selectAll('stop').data(colorStops);\n    stops.exit().remove();\n    stops.enter().append('stop');\n    stops.each(function (d) {\n      var tc = tinycolor(d[1]);\n      d3.select(this).attr({\n        offset: d[0] + '%',\n        'stop-color': Color.tinyRGB(tc),\n        'stop-opacity': tc.getAlpha()\n      });\n    });\n  });\n  sel.style(prop, getFullUrl(fullID, gd)).style(prop + '-opacity', null);\n\n  var className2query = function (s) {\n    return '.' + s.attr('class').replace(/\\s/g, '.');\n  };\n\n  var k = className2query(d3.select(sel.node().parentNode)) + '>' + className2query(sel);\n  fullLayout._gradientUrlQueryParts[k] = 1;\n};\n/**\r\n * pattern: create and apply a pattern fill\r\n *\r\n * @param {object} sel: d3 selection to apply this pattern to\r\n *     You can use `selection.call(Drawing.pattern, ...)`\r\n * @param {string} calledBy: option to know the caller component\r\n * @param {DOM element} gd: the graph div `sel` is part of\r\n * @param {string} patternID: a unique (within this plot) identifier\r\n *     for this pattern, so that we don't create unnecessary definitions\r\n * @param {number} size: size of unit squares for repetition of this pattern\r\n * @param {number} solidity: how solid lines of this pattern are\r\n * @param {string} mcc: color when painted with colorscale\r\n * @param {string} fillmode: fillmode for this pattern\r\n * @param {string} bgcolor: background color for this pattern\r\n * @param {string} fgcolor: foreground color for this pattern\r\n * @param {number} fgopacity: foreground opacity for this pattern\r\n */\n\n\ndrawing.pattern = function (sel, calledBy, gd, patternID, shape, size, solidity, mcc, fillmode, bgcolor, fgcolor, fgopacity) {\n  var isLegend = calledBy === 'legend';\n\n  if (mcc) {\n    if (fillmode === 'overlay') {\n      bgcolor = mcc;\n      fgcolor = Color.contrast(bgcolor);\n    } else {\n      bgcolor = undefined;\n      fgcolor = mcc;\n    }\n  }\n\n  var fullLayout = gd._fullLayout;\n  var fullID = 'p' + fullLayout._uid + '-' + patternID;\n  var width, height; // linear interpolation\n\n  var linearFn = function (x, x0, x1, y0, y1) {\n    return y0 + (y1 - y0) * (x - x0) / (x1 - x0);\n  };\n\n  var path, linewidth, radius;\n  var patternTag;\n  var patternAttrs = {};\n\n  switch (shape) {\n    case '/':\n      width = size * Math.sqrt(2);\n      height = size * Math.sqrt(2);\n      path = 'M-' + width / 4 + ',' + height / 4 + 'l' + width / 2 + ',-' + height / 2 + 'M0,' + height + 'L' + width + ',0' + 'M' + width / 4 * 3 + ',' + height / 4 * 5 + 'l' + width / 2 + ',-' + height / 2;\n      linewidth = solidity * size;\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case '\\\\':\n      width = size * Math.sqrt(2);\n      height = size * Math.sqrt(2);\n      path = 'M' + width / 4 * 3 + ',-' + height / 4 + 'l' + width / 2 + ',' + height / 2 + 'M0,0L' + width + ',' + height + 'M-' + width / 4 + ',' + height / 4 * 3 + 'l' + width / 2 + ',' + height / 2;\n      linewidth = solidity * size;\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case 'x':\n      width = size * Math.sqrt(2);\n      height = size * Math.sqrt(2);\n      path = 'M-' + width / 4 + ',' + height / 4 + 'l' + width / 2 + ',-' + height / 2 + 'M0,' + height + 'L' + width + ',0' + 'M' + width / 4 * 3 + ',' + height / 4 * 5 + 'l' + width / 2 + ',-' + height / 2 + 'M' + width / 4 * 3 + ',-' + height / 4 + 'l' + width / 2 + ',' + height / 2 + 'M0,0L' + width + ',' + height + 'M-' + width / 4 + ',' + height / 4 * 3 + 'l' + width / 2 + ',' + height / 2;\n      linewidth = size - size * Math.sqrt(1.0 - solidity);\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case '|':\n      width = size;\n      height = size;\n      patternTag = 'path';\n      path = 'M' + width / 2 + ',0L' + width / 2 + ',' + height;\n      linewidth = solidity * size;\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case '-':\n      width = size;\n      height = size;\n      patternTag = 'path';\n      path = 'M0,' + height / 2 + 'L' + width + ',' + height / 2;\n      linewidth = solidity * size;\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case '+':\n      width = size;\n      height = size;\n      patternTag = 'path';\n      path = 'M' + width / 2 + ',0L' + width / 2 + ',' + height + 'M0,' + height / 2 + 'L' + width + ',' + height / 2;\n      linewidth = size - size * Math.sqrt(1.0 - solidity);\n      patternTag = 'path';\n      patternAttrs = {\n        'd': path,\n        'opacity': fgopacity,\n        'stroke': fgcolor,\n        'stroke-width': linewidth + 'px'\n      };\n      break;\n\n    case '.':\n      width = size;\n      height = size;\n\n      if (solidity < Math.PI / 4) {\n        radius = Math.sqrt(solidity * size * size / Math.PI);\n      } else {\n        radius = linearFn(solidity, Math.PI / 4, 1.0, size / 2, size / Math.sqrt(2));\n      }\n\n      patternTag = 'circle';\n      patternAttrs = {\n        'cx': width / 2,\n        'cy': height / 2,\n        'r': radius,\n        'opacity': fgopacity,\n        'fill': fgcolor\n      };\n      break;\n  }\n\n  var str = [shape || 'noSh', bgcolor || 'noBg', fgcolor || 'noFg', size, solidity].join(';');\n\n  var pattern = fullLayout._defs.select('.patterns').selectAll('#' + fullID).data([str], Lib.identity);\n\n  pattern.exit().remove();\n  pattern.enter().append('pattern').each(function () {\n    var el = d3.select(this);\n    el.attr({\n      'id': fullID,\n      'width': width + 'px',\n      'height': height + 'px',\n      'patternUnits': 'userSpaceOnUse',\n      // for legends scale down patterns just a bit so that default size (i.e 8) nicely fit in small icons\n      'patternTransform': isLegend ? 'scale(0.8)' : ''\n    });\n\n    if (bgcolor) {\n      var rects = el.selectAll('rect').data([0]);\n      rects.exit().remove();\n      rects.enter().append('rect').attr({\n        'width': width + 'px',\n        'height': height + 'px',\n        'fill': bgcolor\n      });\n    }\n\n    var patterns = el.selectAll(patternTag).data([0]);\n    patterns.exit().remove();\n    patterns.enter().append(patternTag).attr(patternAttrs);\n  });\n  sel.style('fill', getFullUrl(fullID, gd)).style('fill-opacity', null);\n  sel.classed('pattern_filled', true);\n\n  var className2query = function (s) {\n    return '.' + s.attr('class').replace(/\\s/g, '.');\n  };\n\n  var k = className2query(d3.select(sel.node().parentNode)) + '>.pattern_filled';\n  fullLayout._patternUrlQueryParts[k] = 1;\n};\n/*\r\n * Make the gradients container and clear out any previous gradients.\r\n * We never collect all the gradients we need in one place,\r\n * so we can't ever remove gradients that have stopped being useful,\r\n * except all at once before a full redraw.\r\n * The upside of this is arbitrary points can share gradient defs\r\n */\n\n\ndrawing.initGradients = function (gd) {\n  var fullLayout = gd._fullLayout;\n  var gradientsGroup = Lib.ensureSingle(fullLayout._defs, 'g', 'gradients');\n  gradientsGroup.selectAll('linearGradient,radialGradient').remove(); // initialize stash of query parts filled in Drawing.gradient,\n  // used to fix URL strings during image exports\n\n  fullLayout._gradientUrlQueryParts = {};\n};\n\ndrawing.initPatterns = function (gd) {\n  var fullLayout = gd._fullLayout;\n  var patternsGroup = Lib.ensureSingle(fullLayout._defs, 'g', 'patterns');\n  patternsGroup.selectAll('pattern').remove(); // initialize stash of query parts filled in Drawing.pattern,\n  // used to fix URL strings during image exports\n\n  fullLayout._patternUrlQueryParts = {};\n};\n\ndrawing.getPatternAttr = function (mp, i, dflt) {\n  if (mp && Lib.isArrayOrTypedArray(mp)) {\n    return i < mp.length ? mp[i] : dflt;\n  }\n\n  return mp;\n};\n\ndrawing.pointStyle = function (s, trace, gd) {\n  if (!s.size()) return;\n  var fns = drawing.makePointStyleFns(trace);\n  s.each(function (d) {\n    drawing.singlePointStyle(d, d3.select(this), trace, fns, gd);\n  });\n};\n\ndrawing.singlePointStyle = function (d, sel, trace, fns, gd) {\n  var marker = trace.marker;\n  var markerLine = marker.line;\n  sel.style('opacity', fns.selectedOpacityFn ? fns.selectedOpacityFn(d) : d.mo === undefined ? marker.opacity : d.mo);\n\n  if (fns.ms2mrc) {\n    var r; // handle multi-trace graph edit case\n\n    if (d.ms === 'various' || marker.size === 'various') {\n      r = 3;\n    } else {\n      r = fns.ms2mrc(d.ms);\n    } // store the calculated size so hover can use it\n\n\n    d.mrc = r;\n\n    if (fns.selectedSizeFn) {\n      r = d.mrc = fns.selectedSizeFn(d);\n    } // turn the symbol into a sanitized number\n\n\n    var x = drawing.symbolNumber(d.mx || marker.symbol) || 0; // save if this marker is open\n    // because that impacts how to handle colors\n\n    d.om = x % 200 >= 100;\n    sel.attr('d', makePointPath(x, r));\n  }\n\n  var perPointGradient = false;\n  var fillColor, lineColor, lineWidth; // 'so' is suspected outliers, for box plots\n\n  if (d.so) {\n    lineWidth = markerLine.outlierwidth;\n    lineColor = markerLine.outliercolor;\n    fillColor = marker.outliercolor;\n  } else {\n    var markerLineWidth = (markerLine || {}).width;\n    lineWidth = (d.mlw + 1 || markerLineWidth + 1 || // TODO: we need the latter for legends... can we get rid of it?\n    (d.trace ? (d.trace.marker.line || {}).width : 0) + 1) - 1 || 0;\n    if ('mlc' in d) lineColor = d.mlcc = fns.lineScale(d.mlc); // weird case: array wasn't long enough to apply to every point\n    else if (Lib.isArrayOrTypedArray(markerLine.color)) lineColor = Color.defaultLine;else lineColor = markerLine.color;\n\n    if (Lib.isArrayOrTypedArray(marker.color)) {\n      fillColor = Color.defaultLine;\n      perPointGradient = true;\n    }\n\n    if ('mc' in d) {\n      fillColor = d.mcc = fns.markerScale(d.mc);\n    } else {\n      fillColor = marker.color || 'rgba(0,0,0,0)';\n    }\n\n    if (fns.selectedColorFn) {\n      fillColor = fns.selectedColorFn(d);\n    }\n  }\n\n  if (d.om) {\n    // open markers can't have zero linewidth, default to 1px,\n    // and use fill color as stroke color\n    sel.call(Color.stroke, fillColor).style({\n      'stroke-width': (lineWidth || 1) + 'px',\n      fill: 'none'\n    });\n  } else {\n    sel.style('stroke-width', (d.isBlank ? 0 : lineWidth) + 'px');\n    var markerGradient = marker.gradient;\n    var gradientType = d.mgt;\n    if (gradientType) perPointGradient = true;else gradientType = markerGradient && markerGradient.type; // for legend - arrays will propagate through here, but we don't need\n    // to treat it as per-point.\n\n    if (Lib.isArrayOrTypedArray(gradientType)) {\n      gradientType = gradientType[0];\n      if (!gradientInfo[gradientType]) gradientType = 0;\n    }\n\n    var markerPattern = marker.pattern;\n    var patternShape = markerPattern && drawing.getPatternAttr(markerPattern.shape, d.i, '');\n\n    if (gradientType && gradientType !== 'none') {\n      var gradientColor = d.mgc;\n      if (gradientColor) perPointGradient = true;else gradientColor = markerGradient.color;\n      var gradientID = trace.uid;\n      if (perPointGradient) gradientID += '-' + d.i;\n      drawing.gradient(sel, gd, gradientID, gradientType, [[0, gradientColor], [1, fillColor]], 'fill');\n    } else if (patternShape) {\n      var patternBGColor = drawing.getPatternAttr(markerPattern.bgcolor, d.i, null);\n      var patternFGColor = drawing.getPatternAttr(markerPattern.fgcolor, d.i, null);\n      var patternFGOpacity = markerPattern.fgopacity;\n      var patternSize = drawing.getPatternAttr(markerPattern.size, d.i, 8);\n      var patternSolidity = drawing.getPatternAttr(markerPattern.solidity, d.i, 0.3);\n      var perPointPattern = d.mcc || Lib.isArrayOrTypedArray(markerPattern.shape) || Lib.isArrayOrTypedArray(markerPattern.bgcolor) || Lib.isArrayOrTypedArray(markerPattern.size) || Lib.isArrayOrTypedArray(markerPattern.solidity);\n      var patternID = trace.uid;\n      if (perPointPattern) patternID += '-' + d.i;\n      drawing.pattern(sel, 'point', gd, patternID, patternShape, patternSize, patternSolidity, d.mcc, markerPattern.fillmode, patternBGColor, patternFGColor, patternFGOpacity);\n    } else {\n      Color.fill(sel, fillColor);\n    }\n\n    if (lineWidth) {\n      Color.stroke(sel, lineColor);\n    }\n  }\n};\n\ndrawing.makePointStyleFns = function (trace) {\n  var out = {};\n  var marker = trace.marker; // allow array marker and marker line colors to be\n  // scaled by given max and min to colorscales\n\n  out.markerScale = drawing.tryColorscale(marker, '');\n  out.lineScale = drawing.tryColorscale(marker, 'line');\n\n  if (Registry.traceIs(trace, 'symbols')) {\n    out.ms2mrc = subTypes.isBubble(trace) ? makeBubbleSizeFn(trace) : function () {\n      return (marker.size || 6) / 2;\n    };\n  }\n\n  if (trace.selectedpoints) {\n    Lib.extendFlat(out, drawing.makeSelectedPointStyleFns(trace));\n  }\n\n  return out;\n};\n\ndrawing.makeSelectedPointStyleFns = function (trace) {\n  var out = {};\n  var selectedAttrs = trace.selected || {};\n  var unselectedAttrs = trace.unselected || {};\n  var marker = trace.marker || {};\n  var selectedMarker = selectedAttrs.marker || {};\n  var unselectedMarker = unselectedAttrs.marker || {};\n  var mo = marker.opacity;\n  var smo = selectedMarker.opacity;\n  var usmo = unselectedMarker.opacity;\n  var smoIsDefined = smo !== undefined;\n  var usmoIsDefined = usmo !== undefined;\n\n  if (Lib.isArrayOrTypedArray(mo) || smoIsDefined || usmoIsDefined) {\n    out.selectedOpacityFn = function (d) {\n      var base = d.mo === undefined ? marker.opacity : d.mo;\n\n      if (d.selected) {\n        return smoIsDefined ? smo : base;\n      } else {\n        return usmoIsDefined ? usmo : DESELECTDIM * base;\n      }\n    };\n  }\n\n  var mc = marker.color;\n  var smc = selectedMarker.color;\n  var usmc = unselectedMarker.color;\n\n  if (smc || usmc) {\n    out.selectedColorFn = function (d) {\n      var base = d.mcc || mc;\n\n      if (d.selected) {\n        return smc || base;\n      } else {\n        return usmc || base;\n      }\n    };\n  }\n\n  var ms = marker.size;\n  var sms = selectedMarker.size;\n  var usms = unselectedMarker.size;\n  var smsIsDefined = sms !== undefined;\n  var usmsIsDefined = usms !== undefined;\n\n  if (Registry.traceIs(trace, 'symbols') && (smsIsDefined || usmsIsDefined)) {\n    out.selectedSizeFn = function (d) {\n      var base = d.mrc || ms / 2;\n\n      if (d.selected) {\n        return smsIsDefined ? sms / 2 : base;\n      } else {\n        return usmsIsDefined ? usms / 2 : base;\n      }\n    };\n  }\n\n  return out;\n};\n\ndrawing.makeSelectedTextStyleFns = function (trace) {\n  var out = {};\n  var selectedAttrs = trace.selected || {};\n  var unselectedAttrs = trace.unselected || {};\n  var textFont = trace.textfont || {};\n  var selectedTextFont = selectedAttrs.textfont || {};\n  var unselectedTextFont = unselectedAttrs.textfont || {};\n  var tc = textFont.color;\n  var stc = selectedTextFont.color;\n  var utc = unselectedTextFont.color;\n\n  out.selectedTextColorFn = function (d) {\n    var base = d.tc || tc;\n\n    if (d.selected) {\n      return stc || base;\n    } else {\n      if (utc) return utc;else return stc ? base : Color.addOpacity(base, DESELECTDIM);\n    }\n  };\n\n  return out;\n};\n\ndrawing.selectedPointStyle = function (s, trace) {\n  if (!s.size() || !trace.selectedpoints) return;\n  var fns = drawing.makeSelectedPointStyleFns(trace);\n  var marker = trace.marker || {};\n  var seq = [];\n\n  if (fns.selectedOpacityFn) {\n    seq.push(function (pt, d) {\n      pt.style('opacity', fns.selectedOpacityFn(d));\n    });\n  }\n\n  if (fns.selectedColorFn) {\n    seq.push(function (pt, d) {\n      Color.fill(pt, fns.selectedColorFn(d));\n    });\n  }\n\n  if (fns.selectedSizeFn) {\n    seq.push(function (pt, d) {\n      var mx = d.mx || marker.symbol || 0;\n      var mrc2 = fns.selectedSizeFn(d);\n      pt.attr('d', makePointPath(drawing.symbolNumber(mx), mrc2)); // save for Drawing.selectedTextStyle\n\n      d.mrc2 = mrc2;\n    });\n  }\n\n  if (seq.length) {\n    s.each(function (d) {\n      var pt = d3.select(this);\n\n      for (var i = 0; i < seq.length; i++) {\n        seq[i](pt, d);\n      }\n    });\n  }\n};\n\ndrawing.tryColorscale = function (marker, prefix) {\n  var cont = prefix ? Lib.nestedProperty(marker, prefix).get() : marker;\n\n  if (cont) {\n    var colorArray = cont.color;\n\n    if ((cont.colorscale || cont._colorAx) && Lib.isArrayOrTypedArray(colorArray)) {\n      return Colorscale.makeColorScaleFuncFromTrace(cont);\n    }\n  }\n\n  return Lib.identity;\n};\n\nvar TEXTOFFSETSIGN = {\n  start: 1,\n  end: -1,\n  middle: 0,\n  bottom: 1,\n  top: -1\n};\n\nfunction textPointPosition(s, textPosition, fontSize, markerRadius) {\n  var group = d3.select(s.node().parentNode);\n  var v = textPosition.indexOf('top') !== -1 ? 'top' : textPosition.indexOf('bottom') !== -1 ? 'bottom' : 'middle';\n  var h = textPosition.indexOf('left') !== -1 ? 'end' : textPosition.indexOf('right') !== -1 ? 'start' : 'middle'; // if markers are shown, offset a little more than\n  // the nominal marker size\n  // ie 2/1.6 * nominal, bcs some markers are a bit bigger\n\n  var r = markerRadius ? markerRadius / 0.8 + 1 : 0;\n  var numLines = (svgTextUtils.lineCount(s) - 1) * LINE_SPACING + 1;\n  var dx = TEXTOFFSETSIGN[h] * r;\n  var dy = fontSize * 0.75 + TEXTOFFSETSIGN[v] * r + (TEXTOFFSETSIGN[v] - 1) * numLines * fontSize / 2; // fix the overall text group position\n\n  s.attr('text-anchor', h);\n  group.attr('transform', strTranslate(dx, dy));\n}\n\nfunction extracTextFontSize(d, trace) {\n  var fontSize = d.ts || trace.textfont.size;\n  return isNumeric(fontSize) && fontSize > 0 ? fontSize : 0;\n} // draw text at points\n\n\ndrawing.textPointStyle = function (s, trace, gd) {\n  if (!s.size()) return;\n  var selectedTextColorFn;\n\n  if (trace.selectedpoints) {\n    var fns = drawing.makeSelectedTextStyleFns(trace);\n    selectedTextColorFn = fns.selectedTextColorFn;\n  }\n\n  var texttemplate = trace.texttemplate;\n  var fullLayout = gd._fullLayout;\n  s.each(function (d) {\n    var p = d3.select(this);\n    var text = texttemplate ? Lib.extractOption(d, trace, 'txt', 'texttemplate') : Lib.extractOption(d, trace, 'tx', 'text');\n\n    if (!text && text !== 0) {\n      p.remove();\n      return;\n    }\n\n    if (texttemplate) {\n      var fn = trace._module.formatLabels;\n      var labels = fn ? fn(d, trace, fullLayout) : {};\n      var pointValues = {};\n      appendArrayPointValue(pointValues, trace, d.i);\n      var meta = trace._meta || {};\n      text = Lib.texttemplateString(text, labels, fullLayout._d3locale, pointValues, d, meta);\n    }\n\n    var pos = d.tp || trace.textposition;\n    var fontSize = extracTextFontSize(d, trace);\n    var fontColor = selectedTextColorFn ? selectedTextColorFn(d) : d.tc || trace.textfont.color;\n    p.call(drawing.font, d.tf || trace.textfont.family, fontSize, fontColor).text(text).call(svgTextUtils.convertToTspans, gd).call(textPointPosition, pos, fontSize, d.mrc);\n  });\n};\n\ndrawing.selectedTextStyle = function (s, trace) {\n  if (!s.size() || !trace.selectedpoints) return;\n  var fns = drawing.makeSelectedTextStyleFns(trace);\n  s.each(function (d) {\n    var tx = d3.select(this);\n    var tc = fns.selectedTextColorFn(d);\n    var tp = d.tp || trace.textposition;\n    var fontSize = extracTextFontSize(d, trace);\n    Color.fill(tx, tc);\n    textPointPosition(tx, tp, fontSize, d.mrc2 || d.mrc);\n  });\n}; // generalized Catmull-Rom splines, per\n// http://www.cemyuksel.com/research/catmullrom_param/catmullrom.pdf\n\n\nvar CatmullRomExp = 0.5;\n\ndrawing.smoothopen = function (pts, smoothness) {\n  if (pts.length < 3) {\n    return 'M' + pts.join('L');\n  }\n\n  var path = 'M' + pts[0];\n  var tangents = [];\n  var i;\n\n  for (i = 1; i < pts.length - 1; i++) {\n    tangents.push(makeTangent(pts[i - 1], pts[i], pts[i + 1], smoothness));\n  }\n\n  path += 'Q' + tangents[0][0] + ' ' + pts[1];\n\n  for (i = 2; i < pts.length - 1; i++) {\n    path += 'C' + tangents[i - 2][1] + ' ' + tangents[i - 1][0] + ' ' + pts[i];\n  }\n\n  path += 'Q' + tangents[pts.length - 3][1] + ' ' + pts[pts.length - 1];\n  return path;\n};\n\ndrawing.smoothclosed = function (pts, smoothness) {\n  if (pts.length < 3) {\n    return 'M' + pts.join('L') + 'Z';\n  }\n\n  var path = 'M' + pts[0];\n  var pLast = pts.length - 1;\n  var tangents = [makeTangent(pts[pLast], pts[0], pts[1], smoothness)];\n  var i;\n\n  for (i = 1; i < pLast; i++) {\n    tangents.push(makeTangent(pts[i - 1], pts[i], pts[i + 1], smoothness));\n  }\n\n  tangents.push(makeTangent(pts[pLast - 1], pts[pLast], pts[0], smoothness));\n\n  for (i = 1; i <= pLast; i++) {\n    path += 'C' + tangents[i - 1][1] + ' ' + tangents[i][0] + ' ' + pts[i];\n  }\n\n  path += 'C' + tangents[pLast][1] + ' ' + tangents[0][0] + ' ' + pts[0] + 'Z';\n  return path;\n};\n\nfunction makeTangent(prevpt, thispt, nextpt, smoothness) {\n  var d1x = prevpt[0] - thispt[0];\n  var d1y = prevpt[1] - thispt[1];\n  var d2x = nextpt[0] - thispt[0];\n  var d2y = nextpt[1] - thispt[1];\n  var d1a = Math.pow(d1x * d1x + d1y * d1y, CatmullRomExp / 2);\n  var d2a = Math.pow(d2x * d2x + d2y * d2y, CatmullRomExp / 2);\n  var numx = (d2a * d2a * d1x - d1a * d1a * d2x) * smoothness;\n  var numy = (d2a * d2a * d1y - d1a * d1a * d2y) * smoothness;\n  var denom1 = 3 * d2a * (d1a + d2a);\n  var denom2 = 3 * d1a * (d1a + d2a);\n  return [[d3.round(thispt[0] + (denom1 && numx / denom1), 2), d3.round(thispt[1] + (denom1 && numy / denom1), 2)], [d3.round(thispt[0] - (denom2 && numx / denom2), 2), d3.round(thispt[1] - (denom2 && numy / denom2), 2)]];\n} // step paths - returns a generator function for paths\n// with the given step shape\n\n\nvar STEPPATH = {\n  hv: function (p0, p1) {\n    return 'H' + d3.round(p1[0], 2) + 'V' + d3.round(p1[1], 2);\n  },\n  vh: function (p0, p1) {\n    return 'V' + d3.round(p1[1], 2) + 'H' + d3.round(p1[0], 2);\n  },\n  hvh: function (p0, p1) {\n    return 'H' + d3.round((p0[0] + p1[0]) / 2, 2) + 'V' + d3.round(p1[1], 2) + 'H' + d3.round(p1[0], 2);\n  },\n  vhv: function (p0, p1) {\n    return 'V' + d3.round((p0[1] + p1[1]) / 2, 2) + 'H' + d3.round(p1[0], 2) + 'V' + d3.round(p1[1], 2);\n  }\n};\n\nvar STEPLINEAR = function (p0, p1) {\n  return 'L' + d3.round(p1[0], 2) + ',' + d3.round(p1[1], 2);\n};\n\ndrawing.steps = function (shape) {\n  var onestep = STEPPATH[shape] || STEPLINEAR;\n  return function (pts) {\n    var path = 'M' + d3.round(pts[0][0], 2) + ',' + d3.round(pts[0][1], 2);\n\n    for (var i = 1; i < pts.length; i++) {\n      path += onestep(pts[i - 1], pts[i]);\n    }\n\n    return path;\n  };\n}; // off-screen svg render testing element, shared by the whole page\n// uses the id 'js-plotly-tester' and stores it in drawing.tester\n\n\ndrawing.makeTester = function () {\n  var tester = Lib.ensureSingleById(d3.select('body'), 'svg', 'js-plotly-tester', function (s) {\n    s.attr(xmlnsNamespaces.svgAttrs).style({\n      position: 'absolute',\n      left: '-10000px',\n      top: '-10000px',\n      width: '9000px',\n      height: '9000px',\n      'z-index': '1'\n    });\n  }); // browsers differ on how they describe the bounding rect of\n  // the svg if its contents spill over... so make a 1x1px\n  // reference point we can measure off of.\n\n  var testref = Lib.ensureSingle(tester, 'path', 'js-reference-point', function (s) {\n    s.attr('d', 'M0,0H1V1H0Z').style({\n      'stroke-width': 0,\n      fill: 'black'\n    });\n  });\n  drawing.tester = tester;\n  drawing.testref = testref;\n};\n/*\r\n * use our offscreen tester to get a clientRect for an element,\r\n * in a reference frame where it isn't translated (or transformed) and\r\n * its anchor point is at (0,0)\r\n * always returns a copy of the bbox, so the caller can modify it safely\r\n *\r\n * @param {SVGElement} node: the element to measure. If possible this should be\r\n *   a <text> or MathJax <g> element that's already passed through\r\n *   `convertToTspans` because in that case we can cache the results, but it's\r\n *   possible to pass in any svg element.\r\n *\r\n * @param {boolean} inTester: is this element already in `drawing.tester`?\r\n *   If you are measuring a dummy element, rather than one you really intend\r\n *   to use on the plot, making it in `drawing.tester` in the first place\r\n *   allows us to test faster because it cuts out cloning and appending it.\r\n *\r\n * @param {string} hash: for internal use only, if we already know the cache key\r\n *   for this element beforehand.\r\n *\r\n * @return {object}: a plain object containing the width, height, left, right,\r\n *   top, and bottom of `node`\r\n */\n\n\ndrawing.savedBBoxes = {};\nvar savedBBoxesCount = 0;\nvar maxSavedBBoxes = 10000;\n\ndrawing.bBox = function (node, inTester, hash) {\n  /*\r\n   * Cache elements we've already measured so we don't have to\r\n   * remeasure the same thing many times\r\n   * We have a few bBox callers though who pass a node larger than\r\n   * a <text> or a MathJax <g>, such as an axis group containing many labels.\r\n   * These will not generate a hash (unless we figure out an appropriate\r\n   * hash key for them) and thus we will not hash them.\r\n   */\n  if (!hash) hash = nodeHash(node);\n  var out;\n\n  if (hash) {\n    out = drawing.savedBBoxes[hash];\n    if (out) return Lib.extendFlat({}, out);\n  } else if (node.childNodes.length === 1) {\n    /*\r\n     * If we have only one child element, which is itself hashable, make\r\n     * a new hash from this element plus its x,y,transform\r\n     * These bounding boxes *include* x,y,transform - mostly for use by\r\n     * callers trying to avoid overlaps (ie titles)\r\n     */\n    var innerNode = node.childNodes[0];\n    hash = nodeHash(innerNode);\n\n    if (hash) {\n      var x = +innerNode.getAttribute('x') || 0;\n      var y = +innerNode.getAttribute('y') || 0;\n      var transform = innerNode.getAttribute('transform');\n\n      if (!transform) {\n        // in this case, just varying x and y, don't bother caching\n        // the final bBox because the alteration is quick.\n        var innerBB = drawing.bBox(innerNode, false, hash);\n\n        if (x) {\n          innerBB.left += x;\n          innerBB.right += x;\n        }\n\n        if (y) {\n          innerBB.top += y;\n          innerBB.bottom += y;\n        }\n\n        return innerBB;\n      }\n      /*\r\n       * else we have a transform - rather than make a complicated\r\n       * (and error-prone and probably slow) transform parser/calculator,\r\n       * just continue on calculating the boundingClientRect of the group\r\n       * and use the new composite hash to cache it.\r\n       * That said, `innerNode.transform.baseVal` is an array of\r\n       * `SVGTransform` objects, that *do* seem to have a nice matrix\r\n       * multiplication interface that we could use to avoid making\r\n       * another getBoundingClientRect call...\r\n       */\n\n\n      hash += '~' + x + '~' + y + '~' + transform;\n      out = drawing.savedBBoxes[hash];\n      if (out) return Lib.extendFlat({}, out);\n    }\n  }\n\n  var testNode, tester;\n\n  if (inTester) {\n    testNode = node;\n  } else {\n    tester = drawing.tester.node(); // copy the node to test into the tester\n\n    testNode = node.cloneNode(true);\n    tester.appendChild(testNode);\n  } // standardize its position (and newline tspans if any)\n\n\n  d3.select(testNode).attr('transform', null).call(svgTextUtils.positionText, 0, 0);\n  var testRect = testNode.getBoundingClientRect();\n  var refRect = drawing.testref.node().getBoundingClientRect();\n  if (!inTester) tester.removeChild(testNode);\n  var bb = {\n    height: testRect.height,\n    width: testRect.width,\n    left: testRect.left - refRect.left,\n    top: testRect.top - refRect.top,\n    right: testRect.right - refRect.left,\n    bottom: testRect.bottom - refRect.top\n  }; // make sure we don't have too many saved boxes,\n  // or a long session could overload on memory\n  // by saving boxes for long-gone elements\n\n  if (savedBBoxesCount >= maxSavedBBoxes) {\n    drawing.savedBBoxes = {};\n    savedBBoxesCount = 0;\n  } // cache this bbox\n\n\n  if (hash) drawing.savedBBoxes[hash] = bb;\n  savedBBoxesCount++;\n  return Lib.extendFlat({}, bb);\n}; // capture everything about a node (at least in our usage) that\n// impacts its bounding box, given that bBox clears x, y, and transform\n\n\nfunction nodeHash(node) {\n  var inputText = node.getAttribute('data-unformatted');\n  if (inputText === null) return;\n  return inputText + node.getAttribute('data-math') + node.getAttribute('text-anchor') + node.getAttribute('style');\n}\n/**\r\n * Set clipPath URL in a way that work for all situations.\r\n *\r\n * In details, graphs on pages with <base> HTML tags need to prepend\r\n * the clip path ids with the page's base url EXCEPT during toImage exports.\r\n *\r\n * @param {d3 selection} s : node to add clip-path attribute\r\n * @param {string} localId : local clip-path (w/o base url) id\r\n * @param {DOM element || object} gd\r\n * - context._baseUrl {string}\r\n * - context._exportedPlot {boolean}\r\n */\n\n\ndrawing.setClipUrl = function (s, localId, gd) {\n  s.attr('clip-path', getFullUrl(localId, gd));\n};\n\nfunction getFullUrl(localId, gd) {\n  if (!localId) return null;\n  var context = gd._context;\n  var baseUrl = context._exportedPlot ? '' : context._baseUrl || '';\n  return baseUrl ? 'url(\\'' + baseUrl + '#' + localId + '\\')' : 'url(#' + localId + ')';\n}\n\ndrawing.getTranslate = function (element) {\n  // Note the separator [^\\d] between x and y in this regex\n  // We generally use ',' but IE will convert it to ' '\n  var re = /.*\\btranslate\\((-?\\d*\\.?\\d*)[^-\\d]*(-?\\d*\\.?\\d*)[^\\d].*/;\n  var getter = element.attr ? 'attr' : 'getAttribute';\n  var transform = element[getter]('transform') || '';\n  var translate = transform.replace(re, function (match, p1, p2) {\n    return [p1, p2].join(' ');\n  }).split(' ');\n  return {\n    x: +translate[0] || 0,\n    y: +translate[1] || 0\n  };\n};\n\ndrawing.setTranslate = function (element, x, y) {\n  var re = /(\\btranslate\\(.*?\\);?)/;\n  var getter = element.attr ? 'attr' : 'getAttribute';\n  var setter = element.attr ? 'attr' : 'setAttribute';\n  var transform = element[getter]('transform') || '';\n  x = x || 0;\n  y = y || 0;\n  transform = transform.replace(re, '').trim();\n  transform += strTranslate(x, y);\n  transform = transform.trim();\n  element[setter]('transform', transform);\n  return transform;\n};\n\ndrawing.getScale = function (element) {\n  var re = /.*\\bscale\\((\\d*\\.?\\d*)[^\\d]*(\\d*\\.?\\d*)[^\\d].*/;\n  var getter = element.attr ? 'attr' : 'getAttribute';\n  var transform = element[getter]('transform') || '';\n  var translate = transform.replace(re, function (match, p1, p2) {\n    return [p1, p2].join(' ');\n  }).split(' ');\n  return {\n    x: +translate[0] || 1,\n    y: +translate[1] || 1\n  };\n};\n\ndrawing.setScale = function (element, x, y) {\n  var re = /(\\bscale\\(.*?\\);?)/;\n  var getter = element.attr ? 'attr' : 'getAttribute';\n  var setter = element.attr ? 'attr' : 'setAttribute';\n  var transform = element[getter]('transform') || '';\n  x = x || 1;\n  y = y || 1;\n  transform = transform.replace(re, '').trim();\n  transform += 'scale(' + x + ',' + y + ')';\n  transform = transform.trim();\n  element[setter]('transform', transform);\n  return transform;\n};\n\nvar SCALE_RE = /\\s*sc.*/;\n\ndrawing.setPointGroupScale = function (selection, xScale, yScale) {\n  xScale = xScale || 1;\n  yScale = yScale || 1;\n  if (!selection) return; // The same scale transform for every point:\n\n  var scale = xScale === 1 && yScale === 1 ? '' : 'scale(' + xScale + ',' + yScale + ')';\n  selection.each(function () {\n    var t = (this.getAttribute('transform') || '').replace(SCALE_RE, '');\n    t += scale;\n    t = t.trim();\n    this.setAttribute('transform', t);\n  });\n};\n\nvar TEXT_POINT_LAST_TRANSLATION_RE = /translate\\([^)]*\\)\\s*$/;\n\ndrawing.setTextPointsScale = function (selection, xScale, yScale) {\n  if (!selection) return;\n  selection.each(function () {\n    var transforms;\n    var el = d3.select(this);\n    var text = el.select('text');\n    if (!text.node()) return;\n    var x = parseFloat(text.attr('x') || 0);\n    var y = parseFloat(text.attr('y') || 0);\n    var existingTransform = (el.attr('transform') || '').match(TEXT_POINT_LAST_TRANSLATION_RE);\n\n    if (xScale === 1 && yScale === 1) {\n      transforms = [];\n    } else {\n      transforms = [strTranslate(x, y), 'scale(' + xScale + ',' + yScale + ')', strTranslate(-x, -y)];\n    }\n\n    if (existingTransform) {\n      transforms.push(existingTransform);\n    }\n\n    el.attr('transform', transforms.join(''));\n  });\n};","map":{"version":3,"sources":["C:/Users/mikke/VSC/fantasy-django-react/fantasy-django/fantasy-react-app/node_modules/plotly.js/src/components/drawing/index.js"],"names":["d3","require","isNumeric","tinycolor","Registry","Color","Colorscale","Lib","strTranslate","svgTextUtils","xmlnsNamespaces","alignment","LINE_SPACING","DESELECTDIM","subTypes","makeBubbleSizeFn","appendArrayPointValue","drawing","module","exports","font","s","family","size","color","isPlainObject","style","call","fill","setPosition","x","y","attr","setSize","w","h","setRect","translatePoint","d","sel","xa","ya","c2p","node","nodeName","translatePoints","each","select","hideOutsideRangePoint","xcalendar","ycalendar","isPtWithinRange","hideOutsideRangePoints","traceGroups","subplot","_hasClipOnAxisFalse","xaxis","yaxis","trace","selector","traceIs","selectAll","crispRound","gd","lineWidth","dflt","_context","staticPlot","Math","round","singleLineStyle","lw","lc","ld","line","lw1","width","dash","stroke","dashLine","lineGroupStyle","dashStyle","dlw","max","singleFillStyle","data","fillcolor","fillGroupStyle","shape","SYMBOLDEFS","symbolNames","symbolFuncs","symbolNeedLines","symbolNoDot","symbolNoFill","symbolList","Object","keys","forEach","k","symDef","n","push","String","f","needLine","noDot","noFill","MAXSYMBOL","length","DOTPATH","symbolNumber","v","vbase","indexOf","replace","floor","makePointPath","r","base","HORZGRADIENT","x1","x2","y1","y2","VERTGRADIENT","stopFormatter","format","gradientInfo","radial","radialreversed","reversed","horizontal","attrs","horizontalreversed","vertical","verticalreversed","gradient","gradientID","type","colorscale","prop","len","info","colorStops","Array","i","fullLayout","_fullLayout","fullID","_uid","_defs","join","identity","exit","remove","enter","append","el","stops","tc","offset","tinyRGB","getAlpha","getFullUrl","className2query","parentNode","_gradientUrlQueryParts","pattern","calledBy","patternID","solidity","mcc","fillmode","bgcolor","fgcolor","fgopacity","isLegend","contrast","undefined","height","linearFn","x0","y0","path","linewidth","radius","patternTag","patternAttrs","sqrt","PI","str","rects","patterns","classed","_patternUrlQueryParts","initGradients","gradientsGroup","ensureSingle","initPatterns","patternsGroup","getPatternAttr","mp","isArrayOrTypedArray","pointStyle","fns","makePointStyleFns","singlePointStyle","marker","markerLine","selectedOpacityFn","mo","opacity","ms2mrc","ms","mrc","selectedSizeFn","mx","symbol","om","perPointGradient","fillColor","lineColor","so","outlierwidth","outliercolor","markerLineWidth","mlw","mlcc","lineScale","mlc","defaultLine","markerScale","mc","selectedColorFn","isBlank","markerGradient","gradientType","mgt","markerPattern","patternShape","gradientColor","mgc","uid","patternBGColor","patternFGColor","patternFGOpacity","patternSize","patternSolidity","perPointPattern","out","tryColorscale","isBubble","selectedpoints","extendFlat","makeSelectedPointStyleFns","selectedAttrs","selected","unselectedAttrs","unselected","selectedMarker","unselectedMarker","smo","usmo","smoIsDefined","usmoIsDefined","smc","usmc","sms","usms","smsIsDefined","usmsIsDefined","makeSelectedTextStyleFns","textFont","textfont","selectedTextFont","unselectedTextFont","stc","utc","selectedTextColorFn","addOpacity","selectedPointStyle","seq","pt","mrc2","prefix","cont","nestedProperty","get","colorArray","_colorAx","makeColorScaleFuncFromTrace","TEXTOFFSETSIGN","start","end","middle","bottom","top","textPointPosition","textPosition","fontSize","markerRadius","group","numLines","lineCount","dx","dy","extracTextFontSize","ts","textPointStyle","texttemplate","p","text","extractOption","fn","_module","formatLabels","labels","pointValues","meta","_meta","texttemplateString","_d3locale","pos","tp","textposition","fontColor","tf","convertToTspans","selectedTextStyle","tx","CatmullRomExp","smoothopen","pts","smoothness","tangents","makeTangent","smoothclosed","pLast","prevpt","thispt","nextpt","d1x","d1y","d2x","d2y","d1a","pow","d2a","numx","numy","denom1","denom2","STEPPATH","hv","p0","p1","vh","hvh","vhv","STEPLINEAR","steps","onestep","makeTester","tester","ensureSingleById","svgAttrs","position","left","testref","savedBBoxes","savedBBoxesCount","maxSavedBBoxes","bBox","inTester","hash","nodeHash","childNodes","innerNode","getAttribute","transform","innerBB","right","testNode","cloneNode","appendChild","positionText","testRect","getBoundingClientRect","refRect","removeChild","bb","inputText","setClipUrl","localId","context","baseUrl","_exportedPlot","_baseUrl","getTranslate","element","re","getter","translate","match","p2","split","setTranslate","setter","trim","getScale","setScale","SCALE_RE","setPointGroupScale","selection","xScale","yScale","scale","t","setAttribute","TEXT_POINT_LAST_TRANSLATION_RE","setTextPointsScale","transforms","parseFloat","existingTransform"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar d3 = require('@plotly/d3');\r\nvar isNumeric = require('fast-isnumeric');\r\nvar tinycolor = require('tinycolor2');\r\n\r\nvar Registry = require('../../registry');\r\nvar Color = require('../color');\r\nvar Colorscale = require('../colorscale');\r\nvar Lib = require('../../lib');\r\nvar strTranslate = Lib.strTranslate;\r\nvar svgTextUtils = require('../../lib/svg_text_utils');\r\n\r\nvar xmlnsNamespaces = require('../../constants/xmlns_namespaces');\r\nvar alignment = require('../../constants/alignment');\r\nvar LINE_SPACING = alignment.LINE_SPACING;\r\nvar DESELECTDIM = require('../../constants/interactions').DESELECTDIM;\r\n\r\nvar subTypes = require('../../traces/scatter/subtypes');\r\nvar makeBubbleSizeFn = require('../../traces/scatter/make_bubble_size_func');\r\nvar appendArrayPointValue = require('../../components/fx/helpers').appendArrayPointValue;\r\n\r\nvar drawing = module.exports = {};\r\n\r\n// -----------------------------------------------------\r\n// styling functions for plot elements\r\n// -----------------------------------------------------\r\n\r\ndrawing.font = function(s, family, size, color) {\r\n    // also allow the form font(s, {family, size, color})\r\n    if(Lib.isPlainObject(family)) {\r\n        color = family.color;\r\n        size = family.size;\r\n        family = family.family;\r\n    }\r\n    if(family) s.style('font-family', family);\r\n    if(size + 1) s.style('font-size', size + 'px');\r\n    if(color) s.call(Color.fill, color);\r\n};\r\n\r\n/*\r\n * Positioning helpers\r\n * Note: do not use `setPosition` with <text> nodes modified by\r\n * `svgTextUtils.convertToTspans`. Use `svgTextUtils.positionText`\r\n * instead, so that <tspan.line> elements get updated to match.\r\n */\r\ndrawing.setPosition = function(s, x, y) { s.attr('x', x).attr('y', y); };\r\ndrawing.setSize = function(s, w, h) { s.attr('width', w).attr('height', h); };\r\ndrawing.setRect = function(s, x, y, w, h) {\r\n    s.call(drawing.setPosition, x, y).call(drawing.setSize, w, h);\r\n};\r\n\r\n/** Translate node\r\n *\r\n * @param {object} d : calcdata point item\r\n * @param {sel} sel : d3 selction of node to translate\r\n * @param {object} xa : corresponding full xaxis object\r\n * @param {object} ya : corresponding full yaxis object\r\n *\r\n * @return {boolean} :\r\n *  true if selection got translated\r\n *  false if selection could not get translated\r\n */\r\ndrawing.translatePoint = function(d, sel, xa, ya) {\r\n    var x = xa.c2p(d.x);\r\n    var y = ya.c2p(d.y);\r\n\r\n    if(isNumeric(x) && isNumeric(y) && sel.node()) {\r\n        // for multiline text this works better\r\n        if(sel.node().nodeName === 'text') {\r\n            sel.attr('x', x).attr('y', y);\r\n        } else {\r\n            sel.attr('transform', strTranslate(x, y));\r\n        }\r\n    } else {\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\ndrawing.translatePoints = function(s, xa, ya) {\r\n    s.each(function(d) {\r\n        var sel = d3.select(this);\r\n        drawing.translatePoint(d, sel, xa, ya);\r\n    });\r\n};\r\n\r\ndrawing.hideOutsideRangePoint = function(d, sel, xa, ya, xcalendar, ycalendar) {\r\n    sel.attr(\r\n        'display',\r\n        (xa.isPtWithinRange(d, xcalendar) && ya.isPtWithinRange(d, ycalendar)) ? null : 'none'\r\n    );\r\n};\r\n\r\ndrawing.hideOutsideRangePoints = function(traceGroups, subplot) {\r\n    if(!subplot._hasClipOnAxisFalse) return;\r\n\r\n    var xa = subplot.xaxis;\r\n    var ya = subplot.yaxis;\r\n\r\n    traceGroups.each(function(d) {\r\n        var trace = d[0].trace;\r\n        var xcalendar = trace.xcalendar;\r\n        var ycalendar = trace.ycalendar;\r\n        var selector = Registry.traceIs(trace, 'bar-like') ? '.bartext' : '.point,.textpoint';\r\n\r\n        traceGroups.selectAll(selector).each(function(d) {\r\n            drawing.hideOutsideRangePoint(d, d3.select(this), xa, ya, xcalendar, ycalendar);\r\n        });\r\n    });\r\n};\r\n\r\ndrawing.crispRound = function(gd, lineWidth, dflt) {\r\n    // for lines that disable antialiasing we want to\r\n    // make sure the width is an integer, and at least 1 if it's nonzero\r\n\r\n    if(!lineWidth || !isNumeric(lineWidth)) return dflt || 0;\r\n\r\n    // but not for static plots - these don't get antialiased anyway.\r\n    if(gd._context.staticPlot) return lineWidth;\r\n\r\n    if(lineWidth < 1) return 1;\r\n    return Math.round(lineWidth);\r\n};\r\n\r\ndrawing.singleLineStyle = function(d, s, lw, lc, ld) {\r\n    s.style('fill', 'none');\r\n    var line = (((d || [])[0] || {}).trace || {}).line || {};\r\n    var lw1 = lw || line.width || 0;\r\n    var dash = ld || line.dash || '';\r\n\r\n    Color.stroke(s, lc || line.color);\r\n    drawing.dashLine(s, dash, lw1);\r\n};\r\n\r\ndrawing.lineGroupStyle = function(s, lw, lc, ld) {\r\n    s.style('fill', 'none')\r\n    .each(function(d) {\r\n        var line = (((d || [])[0] || {}).trace || {}).line || {};\r\n        var lw1 = lw || line.width || 0;\r\n        var dash = ld || line.dash || '';\r\n\r\n        d3.select(this)\r\n            .call(Color.stroke, lc || line.color)\r\n            .call(drawing.dashLine, dash, lw1);\r\n    });\r\n};\r\n\r\ndrawing.dashLine = function(s, dash, lineWidth) {\r\n    lineWidth = +lineWidth || 0;\r\n\r\n    dash = drawing.dashStyle(dash, lineWidth);\r\n\r\n    s.style({\r\n        'stroke-dasharray': dash,\r\n        'stroke-width': lineWidth + 'px'\r\n    });\r\n};\r\n\r\ndrawing.dashStyle = function(dash, lineWidth) {\r\n    lineWidth = +lineWidth || 1;\r\n    var dlw = Math.max(lineWidth, 3);\r\n\r\n    if(dash === 'solid') dash = '';\r\n    else if(dash === 'dot') dash = dlw + 'px,' + dlw + 'px';\r\n    else if(dash === 'dash') dash = (3 * dlw) + 'px,' + (3 * dlw) + 'px';\r\n    else if(dash === 'longdash') dash = (5 * dlw) + 'px,' + (5 * dlw) + 'px';\r\n    else if(dash === 'dashdot') {\r\n        dash = (3 * dlw) + 'px,' + dlw + 'px,' + dlw + 'px,' + dlw + 'px';\r\n    } else if(dash === 'longdashdot') {\r\n        dash = (5 * dlw) + 'px,' + (2 * dlw) + 'px,' + dlw + 'px,' + (2 * dlw) + 'px';\r\n    }\r\n    // otherwise user wrote the dasharray themselves - leave it be\r\n\r\n    return dash;\r\n};\r\n\r\n// Same as fillGroupStyle, except in this case the selection may be a transition\r\ndrawing.singleFillStyle = function(sel) {\r\n    var node = d3.select(sel.node());\r\n    var data = node.data();\r\n    var fillcolor = (((data[0] || [])[0] || {}).trace || {}).fillcolor;\r\n    if(fillcolor) {\r\n        sel.call(Color.fill, fillcolor);\r\n    }\r\n};\r\n\r\ndrawing.fillGroupStyle = function(s) {\r\n    s.style('stroke-width', 0)\r\n    .each(function(d) {\r\n        var shape = d3.select(this);\r\n        // N.B. 'd' won't be a calcdata item when\r\n        // fill !== 'none' on a segment-less and marker-less trace\r\n        if(d[0].trace) {\r\n            shape.call(Color.fill, d[0].trace.fillcolor);\r\n        }\r\n    });\r\n};\r\n\r\nvar SYMBOLDEFS = require('./symbol_defs');\r\n\r\ndrawing.symbolNames = [];\r\ndrawing.symbolFuncs = [];\r\ndrawing.symbolNeedLines = {};\r\ndrawing.symbolNoDot = {};\r\ndrawing.symbolNoFill = {};\r\ndrawing.symbolList = [];\r\n\r\nObject.keys(SYMBOLDEFS).forEach(function(k) {\r\n    var symDef = SYMBOLDEFS[k];\r\n    var n = symDef.n;\r\n    drawing.symbolList.push(\r\n        n,\r\n        String(n),\r\n        k,\r\n\r\n        n + 100,\r\n        String(n + 100),\r\n        k + '-open'\r\n    );\r\n    drawing.symbolNames[n] = k;\r\n    drawing.symbolFuncs[n] = symDef.f;\r\n\r\n    if(symDef.needLine) {\r\n        drawing.symbolNeedLines[n] = true;\r\n    }\r\n    if(symDef.noDot) {\r\n        drawing.symbolNoDot[n] = true;\r\n    } else {\r\n        drawing.symbolList.push(\r\n            n + 200,\r\n            String(n + 200),\r\n            k + '-dot',\r\n\r\n            n + 300,\r\n            String(n + 300),\r\n            k + '-open-dot'\r\n        );\r\n    }\r\n    if(symDef.noFill) {\r\n        drawing.symbolNoFill[n] = true;\r\n    }\r\n});\r\n\r\nvar MAXSYMBOL = drawing.symbolNames.length;\r\n// add a dot in the middle of the symbol\r\nvar DOTPATH = 'M0,0.5L0.5,0L0,-0.5L-0.5,0Z';\r\n\r\ndrawing.symbolNumber = function(v) {\r\n    if(isNumeric(v)) {\r\n        v = +v;\r\n    } else if(typeof v === 'string') {\r\n        var vbase = 0;\r\n        if(v.indexOf('-open') > 0) {\r\n            vbase = 100;\r\n            v = v.replace('-open', '');\r\n        }\r\n        if(v.indexOf('-dot') > 0) {\r\n            vbase += 200;\r\n            v = v.replace('-dot', '');\r\n        }\r\n        v = drawing.symbolNames.indexOf(v);\r\n        if(v >= 0) { v += vbase; }\r\n    }\r\n\r\n    return (v % 100 >= MAXSYMBOL || v >= 400) ?\r\n        0 : Math.floor(Math.max(v, 0));\r\n};\r\n\r\nfunction makePointPath(symbolNumber, r) {\r\n    var base = symbolNumber % 100;\r\n    return drawing.symbolFuncs[base](r) + (symbolNumber >= 200 ? DOTPATH : '');\r\n}\r\n\r\nvar HORZGRADIENT = {x1: 1, x2: 0, y1: 0, y2: 0};\r\nvar VERTGRADIENT = {x1: 0, x2: 0, y1: 1, y2: 0};\r\nvar stopFormatter = d3.format('~.1f');\r\nvar gradientInfo = {\r\n    radial: {node: 'radialGradient'},\r\n    radialreversed: {node: 'radialGradient', reversed: true},\r\n    horizontal: {node: 'linearGradient', attrs: HORZGRADIENT},\r\n    horizontalreversed: {node: 'linearGradient', attrs: HORZGRADIENT, reversed: true},\r\n    vertical: {node: 'linearGradient', attrs: VERTGRADIENT},\r\n    verticalreversed: {node: 'linearGradient', attrs: VERTGRADIENT, reversed: true}\r\n};\r\n\r\n/**\r\n * gradient: create and apply a gradient fill\r\n *\r\n * @param {object} sel: d3 selection to apply this gradient to\r\n *     You can use `selection.call(Drawing.gradient, ...)`\r\n * @param {DOM element} gd: the graph div `sel` is part of\r\n * @param {string} gradientID: a unique (within this plot) identifier\r\n *     for this gradient, so that we don't create unnecessary definitions\r\n * @param {string} type: 'radial', 'horizontal', or 'vertical', optionally with\r\n *     'reversed' at the end. Normally radial goes center to edge,\r\n *     horizontal goes right to left, and vertical goes bottom to top\r\n * @param {array} colorscale: as in attribute values, [[fraction, color], ...]\r\n * @param {string} prop: the property to apply to, 'fill' or 'stroke'\r\n */\r\ndrawing.gradient = function(sel, gd, gradientID, type, colorscale, prop) {\r\n    var len = colorscale.length;\r\n    var info = gradientInfo[type];\r\n    var colorStops = new Array(len);\r\n    for(var i = 0; i < len; i++) {\r\n        if(info.reversed) {\r\n            colorStops[len - 1 - i] = [stopFormatter((1 - colorscale[i][0]) * 100), colorscale[i][1]];\r\n        } else {\r\n            colorStops[i] = [stopFormatter(colorscale[i][0] * 100), colorscale[i][1]];\r\n        }\r\n    }\r\n\r\n    var fullLayout = gd._fullLayout;\r\n    var fullID = 'g' + fullLayout._uid + '-' + gradientID;\r\n\r\n    var gradient = fullLayout._defs.select('.gradients')\r\n        .selectAll('#' + fullID)\r\n        .data([type + colorStops.join(';')], Lib.identity);\r\n\r\n    gradient.exit().remove();\r\n\r\n    gradient.enter()\r\n        .append(info.node)\r\n        .each(function() {\r\n            var el = d3.select(this);\r\n            if(info.attrs) el.attr(info.attrs);\r\n\r\n            el.attr('id', fullID);\r\n\r\n            var stops = el.selectAll('stop')\r\n                .data(colorStops);\r\n            stops.exit().remove();\r\n            stops.enter().append('stop');\r\n\r\n            stops.each(function(d) {\r\n                var tc = tinycolor(d[1]);\r\n                d3.select(this).attr({\r\n                    offset: d[0] + '%',\r\n                    'stop-color': Color.tinyRGB(tc),\r\n                    'stop-opacity': tc.getAlpha()\r\n                });\r\n            });\r\n        });\r\n\r\n    sel.style(prop, getFullUrl(fullID, gd))\r\n        .style(prop + '-opacity', null);\r\n\r\n    var className2query = function(s) {\r\n        return '.' + s.attr('class').replace(/\\s/g, '.');\r\n    };\r\n    var k = className2query(d3.select(sel.node().parentNode)) +\r\n        '>' + className2query(sel);\r\n    fullLayout._gradientUrlQueryParts[k] = 1;\r\n};\r\n\r\n/**\r\n * pattern: create and apply a pattern fill\r\n *\r\n * @param {object} sel: d3 selection to apply this pattern to\r\n *     You can use `selection.call(Drawing.pattern, ...)`\r\n * @param {string} calledBy: option to know the caller component\r\n * @param {DOM element} gd: the graph div `sel` is part of\r\n * @param {string} patternID: a unique (within this plot) identifier\r\n *     for this pattern, so that we don't create unnecessary definitions\r\n * @param {number} size: size of unit squares for repetition of this pattern\r\n * @param {number} solidity: how solid lines of this pattern are\r\n * @param {string} mcc: color when painted with colorscale\r\n * @param {string} fillmode: fillmode for this pattern\r\n * @param {string} bgcolor: background color for this pattern\r\n * @param {string} fgcolor: foreground color for this pattern\r\n * @param {number} fgopacity: foreground opacity for this pattern\r\n */\r\ndrawing.pattern = function(sel, calledBy, gd, patternID, shape, size, solidity, mcc, fillmode, bgcolor, fgcolor, fgopacity) {\r\n    var isLegend = calledBy === 'legend';\r\n\r\n    if(mcc) {\r\n        if(fillmode === 'overlay') {\r\n            bgcolor = mcc;\r\n            fgcolor = Color.contrast(bgcolor);\r\n        } else {\r\n            bgcolor = undefined;\r\n            fgcolor = mcc;\r\n        }\r\n    }\r\n\r\n    var fullLayout = gd._fullLayout;\r\n    var fullID = 'p' + fullLayout._uid + '-' + patternID;\r\n    var width, height;\r\n\r\n    // linear interpolation\r\n    var linearFn = function(x, x0, x1, y0, y1) {\r\n        return y0 + (y1 - y0) * (x - x0) / (x1 - x0);\r\n    };\r\n\r\n    var path, linewidth, radius;\r\n    var patternTag;\r\n    var patternAttrs = {};\r\n    switch(shape) {\r\n        case '/':\r\n            width = size * Math.sqrt(2);\r\n            height = size * Math.sqrt(2);\r\n            path = 'M-' + (width / 4) + ',' + (height / 4) + 'l' + (width / 2) + ',-' + (height / 2) +\r\n                   'M0,' + height + 'L' + width + ',0' +\r\n                   'M' + (width / 4 * 3) + ',' + (height / 4 * 5) + 'l' + (width / 2) + ',-' + (height / 2);\r\n            linewidth = solidity * size;\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case '\\\\':\r\n            width = size * Math.sqrt(2);\r\n            height = size * Math.sqrt(2);\r\n            path = 'M' + (width / 4 * 3) + ',-' + (height / 4) + 'l' + (width / 2) + ',' + (height / 2) +\r\n                   'M0,0L' + width + ',' + height +\r\n                   'M-' + (width / 4) + ',' + (height / 4 * 3) + 'l' + (width / 2) + ',' + (height / 2);\r\n            linewidth = solidity * size;\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case 'x':\r\n            width = size * Math.sqrt(2);\r\n            height = size * Math.sqrt(2);\r\n            path = 'M-' + (width / 4) + ',' + (height / 4) + 'l' + (width / 2) + ',-' + (height / 2) +\r\n                   'M0,' + height + 'L' + width + ',0' +\r\n                   'M' + (width / 4 * 3) + ',' + (height / 4 * 5) + 'l' + (width / 2) + ',-' + (height / 2) +\r\n                   'M' + (width / 4 * 3) + ',-' + (height / 4) + 'l' + (width / 2) + ',' + (height / 2) +\r\n                   'M0,0L' + width + ',' + height +\r\n                   'M-' + (width / 4) + ',' + (height / 4 * 3) + 'l' + (width / 2) + ',' + (height / 2);\r\n            linewidth = size - size * Math.sqrt(1.0 - solidity);\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case '|':\r\n            width = size;\r\n            height = size;\r\n            patternTag = 'path';\r\n            path = 'M' + (width / 2) + ',0L' + (width / 2) + ',' + height;\r\n            linewidth = solidity * size;\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case '-':\r\n            width = size;\r\n            height = size;\r\n            patternTag = 'path';\r\n            path = 'M0,' + (height / 2) + 'L' + width + ',' + (height / 2);\r\n            linewidth = solidity * size;\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case '+':\r\n            width = size;\r\n            height = size;\r\n            patternTag = 'path';\r\n            path = 'M' + (width / 2) + ',0L' + (width / 2) + ',' + height +\r\n                   'M0,' + (height / 2) + 'L' + width + ',' + (height / 2);\r\n            linewidth = size - size * Math.sqrt(1.0 - solidity);\r\n            patternTag = 'path';\r\n            patternAttrs = {\r\n                'd': path,\r\n                'opacity': fgopacity,\r\n                'stroke': fgcolor,\r\n                'stroke-width': linewidth + 'px'\r\n            };\r\n            break;\r\n        case '.':\r\n            width = size;\r\n            height = size;\r\n            if(solidity < Math.PI / 4) {\r\n                radius = Math.sqrt(solidity * size * size / Math.PI);\r\n            } else {\r\n                radius = linearFn(solidity, Math.PI / 4, 1.0, size / 2, size / Math.sqrt(2));\r\n            }\r\n            patternTag = 'circle';\r\n            patternAttrs = {\r\n                'cx': width / 2,\r\n                'cy': height / 2,\r\n                'r': radius,\r\n                'opacity': fgopacity,\r\n                'fill': fgcolor\r\n            };\r\n            break;\r\n    }\r\n\r\n    var str = [\r\n        shape || 'noSh',\r\n        bgcolor || 'noBg',\r\n        fgcolor || 'noFg',\r\n        size,\r\n        solidity\r\n    ].join(';');\r\n\r\n    var pattern = fullLayout._defs.select('.patterns')\r\n        .selectAll('#' + fullID)\r\n        .data([str], Lib.identity);\r\n\r\n    pattern.exit().remove();\r\n\r\n    pattern.enter()\r\n        .append('pattern')\r\n        .each(function() {\r\n            var el = d3.select(this);\r\n\r\n            el.attr({\r\n                'id': fullID,\r\n                'width': width + 'px',\r\n                'height': height + 'px',\r\n                'patternUnits': 'userSpaceOnUse',\r\n                // for legends scale down patterns just a bit so that default size (i.e 8) nicely fit in small icons\r\n                'patternTransform': isLegend ? 'scale(0.8)' : ''\r\n            });\r\n\r\n            if(bgcolor) {\r\n                var rects = el.selectAll('rect').data([0]);\r\n                rects.exit().remove();\r\n                rects.enter()\r\n                    .append('rect')\r\n                    .attr({\r\n                        'width': width + 'px',\r\n                        'height': height + 'px',\r\n                        'fill': bgcolor\r\n                    });\r\n            }\r\n\r\n            var patterns = el.selectAll(patternTag).data([0]);\r\n            patterns.exit().remove();\r\n            patterns.enter()\r\n                .append(patternTag)\r\n                .attr(patternAttrs);\r\n        });\r\n\r\n    sel.style('fill', getFullUrl(fullID, gd))\r\n        .style('fill-opacity', null);\r\n\r\n    sel.classed('pattern_filled', true);\r\n    var className2query = function(s) {\r\n        return '.' + s.attr('class').replace(/\\s/g, '.');\r\n    };\r\n    var k = className2query(d3.select(sel.node().parentNode)) + '>.pattern_filled';\r\n    fullLayout._patternUrlQueryParts[k] = 1;\r\n};\r\n\r\n/*\r\n * Make the gradients container and clear out any previous gradients.\r\n * We never collect all the gradients we need in one place,\r\n * so we can't ever remove gradients that have stopped being useful,\r\n * except all at once before a full redraw.\r\n * The upside of this is arbitrary points can share gradient defs\r\n */\r\ndrawing.initGradients = function(gd) {\r\n    var fullLayout = gd._fullLayout;\r\n\r\n    var gradientsGroup = Lib.ensureSingle(fullLayout._defs, 'g', 'gradients');\r\n    gradientsGroup.selectAll('linearGradient,radialGradient').remove();\r\n\r\n    // initialize stash of query parts filled in Drawing.gradient,\r\n    // used to fix URL strings during image exports\r\n    fullLayout._gradientUrlQueryParts = {};\r\n};\r\n\r\ndrawing.initPatterns = function(gd) {\r\n    var fullLayout = gd._fullLayout;\r\n\r\n    var patternsGroup = Lib.ensureSingle(fullLayout._defs, 'g', 'patterns');\r\n    patternsGroup.selectAll('pattern').remove();\r\n\r\n    // initialize stash of query parts filled in Drawing.pattern,\r\n    // used to fix URL strings during image exports\r\n    fullLayout._patternUrlQueryParts = {};\r\n};\r\n\r\ndrawing.getPatternAttr = function(mp, i, dflt) {\r\n    if(mp && Lib.isArrayOrTypedArray(mp)) {\r\n        return i < mp.length ? mp[i] : dflt;\r\n    }\r\n    return mp;\r\n};\r\n\r\ndrawing.pointStyle = function(s, trace, gd) {\r\n    if(!s.size()) return;\r\n\r\n    var fns = drawing.makePointStyleFns(trace);\r\n\r\n    s.each(function(d) {\r\n        drawing.singlePointStyle(d, d3.select(this), trace, fns, gd);\r\n    });\r\n};\r\n\r\ndrawing.singlePointStyle = function(d, sel, trace, fns, gd) {\r\n    var marker = trace.marker;\r\n    var markerLine = marker.line;\r\n\r\n    sel.style('opacity',\r\n        fns.selectedOpacityFn ? fns.selectedOpacityFn(d) :\r\n            (d.mo === undefined ? marker.opacity : d.mo)\r\n    );\r\n\r\n    if(fns.ms2mrc) {\r\n        var r;\r\n\r\n        // handle multi-trace graph edit case\r\n        if(d.ms === 'various' || marker.size === 'various') {\r\n            r = 3;\r\n        } else {\r\n            r = fns.ms2mrc(d.ms);\r\n        }\r\n\r\n        // store the calculated size so hover can use it\r\n        d.mrc = r;\r\n\r\n        if(fns.selectedSizeFn) {\r\n            r = d.mrc = fns.selectedSizeFn(d);\r\n        }\r\n\r\n        // turn the symbol into a sanitized number\r\n        var x = drawing.symbolNumber(d.mx || marker.symbol) || 0;\r\n\r\n        // save if this marker is open\r\n        // because that impacts how to handle colors\r\n        d.om = x % 200 >= 100;\r\n\r\n        sel.attr('d', makePointPath(x, r));\r\n    }\r\n\r\n    var perPointGradient = false;\r\n    var fillColor, lineColor, lineWidth;\r\n\r\n    // 'so' is suspected outliers, for box plots\r\n    if(d.so) {\r\n        lineWidth = markerLine.outlierwidth;\r\n        lineColor = markerLine.outliercolor;\r\n        fillColor = marker.outliercolor;\r\n    } else {\r\n        var markerLineWidth = (markerLine || {}).width;\r\n\r\n        lineWidth = (\r\n            d.mlw + 1 ||\r\n            markerLineWidth + 1 ||\r\n            // TODO: we need the latter for legends... can we get rid of it?\r\n            (d.trace ? (d.trace.marker.line || {}).width : 0) + 1\r\n        ) - 1 || 0;\r\n\r\n        if('mlc' in d) lineColor = d.mlcc = fns.lineScale(d.mlc);\r\n        // weird case: array wasn't long enough to apply to every point\r\n        else if(Lib.isArrayOrTypedArray(markerLine.color)) lineColor = Color.defaultLine;\r\n        else lineColor = markerLine.color;\r\n\r\n        if(Lib.isArrayOrTypedArray(marker.color)) {\r\n            fillColor = Color.defaultLine;\r\n            perPointGradient = true;\r\n        }\r\n\r\n        if('mc' in d) {\r\n            fillColor = d.mcc = fns.markerScale(d.mc);\r\n        } else {\r\n            fillColor = marker.color || 'rgba(0,0,0,0)';\r\n        }\r\n\r\n        if(fns.selectedColorFn) {\r\n            fillColor = fns.selectedColorFn(d);\r\n        }\r\n    }\r\n\r\n    if(d.om) {\r\n        // open markers can't have zero linewidth, default to 1px,\r\n        // and use fill color as stroke color\r\n        sel.call(Color.stroke, fillColor)\r\n            .style({\r\n                'stroke-width': (lineWidth || 1) + 'px',\r\n                fill: 'none'\r\n            });\r\n    } else {\r\n        sel.style('stroke-width', (d.isBlank ? 0 : lineWidth) + 'px');\r\n\r\n        var markerGradient = marker.gradient;\r\n\r\n        var gradientType = d.mgt;\r\n        if(gradientType) perPointGradient = true;\r\n        else gradientType = markerGradient && markerGradient.type;\r\n\r\n        // for legend - arrays will propagate through here, but we don't need\r\n        // to treat it as per-point.\r\n        if(Lib.isArrayOrTypedArray(gradientType)) {\r\n            gradientType = gradientType[0];\r\n            if(!gradientInfo[gradientType]) gradientType = 0;\r\n        }\r\n\r\n        var markerPattern = marker.pattern;\r\n        var patternShape = markerPattern && drawing.getPatternAttr(markerPattern.shape, d.i, '');\r\n\r\n        if(gradientType && gradientType !== 'none') {\r\n            var gradientColor = d.mgc;\r\n            if(gradientColor) perPointGradient = true;\r\n            else gradientColor = markerGradient.color;\r\n\r\n            var gradientID = trace.uid;\r\n            if(perPointGradient) gradientID += '-' + d.i;\r\n\r\n            drawing.gradient(sel, gd, gradientID, gradientType,\r\n                [[0, gradientColor], [1, fillColor]], 'fill');\r\n        } else if(patternShape) {\r\n            var patternBGColor = drawing.getPatternAttr(markerPattern.bgcolor, d.i, null);\r\n            var patternFGColor = drawing.getPatternAttr(markerPattern.fgcolor, d.i, null);\r\n            var patternFGOpacity = markerPattern.fgopacity;\r\n            var patternSize = drawing.getPatternAttr(markerPattern.size, d.i, 8);\r\n            var patternSolidity = drawing.getPatternAttr(markerPattern.solidity, d.i, 0.3);\r\n            var perPointPattern = d.mcc ||\r\n                Lib.isArrayOrTypedArray(markerPattern.shape) ||\r\n                Lib.isArrayOrTypedArray(markerPattern.bgcolor) ||\r\n                Lib.isArrayOrTypedArray(markerPattern.size) ||\r\n                Lib.isArrayOrTypedArray(markerPattern.solidity);\r\n\r\n            var patternID = trace.uid;\r\n            if(perPointPattern) patternID += '-' + d.i;\r\n\r\n            drawing.pattern(\r\n                sel, 'point', gd, patternID,\r\n                patternShape, patternSize, patternSolidity,\r\n                d.mcc, markerPattern.fillmode,\r\n                patternBGColor, patternFGColor, patternFGOpacity\r\n            );\r\n        } else {\r\n            Color.fill(sel, fillColor);\r\n        }\r\n\r\n        if(lineWidth) {\r\n            Color.stroke(sel, lineColor);\r\n        }\r\n    }\r\n};\r\n\r\ndrawing.makePointStyleFns = function(trace) {\r\n    var out = {};\r\n    var marker = trace.marker;\r\n\r\n    // allow array marker and marker line colors to be\r\n    // scaled by given max and min to colorscales\r\n    out.markerScale = drawing.tryColorscale(marker, '');\r\n    out.lineScale = drawing.tryColorscale(marker, 'line');\r\n\r\n    if(Registry.traceIs(trace, 'symbols')) {\r\n        out.ms2mrc = subTypes.isBubble(trace) ?\r\n            makeBubbleSizeFn(trace) :\r\n            function() { return (marker.size || 6) / 2; };\r\n    }\r\n\r\n    if(trace.selectedpoints) {\r\n        Lib.extendFlat(out, drawing.makeSelectedPointStyleFns(trace));\r\n    }\r\n\r\n    return out;\r\n};\r\n\r\ndrawing.makeSelectedPointStyleFns = function(trace) {\r\n    var out = {};\r\n\r\n    var selectedAttrs = trace.selected || {};\r\n    var unselectedAttrs = trace.unselected || {};\r\n\r\n    var marker = trace.marker || {};\r\n    var selectedMarker = selectedAttrs.marker || {};\r\n    var unselectedMarker = unselectedAttrs.marker || {};\r\n\r\n    var mo = marker.opacity;\r\n    var smo = selectedMarker.opacity;\r\n    var usmo = unselectedMarker.opacity;\r\n    var smoIsDefined = smo !== undefined;\r\n    var usmoIsDefined = usmo !== undefined;\r\n\r\n    if(Lib.isArrayOrTypedArray(mo) || smoIsDefined || usmoIsDefined) {\r\n        out.selectedOpacityFn = function(d) {\r\n            var base = d.mo === undefined ? marker.opacity : d.mo;\r\n\r\n            if(d.selected) {\r\n                return smoIsDefined ? smo : base;\r\n            } else {\r\n                return usmoIsDefined ? usmo : DESELECTDIM * base;\r\n            }\r\n        };\r\n    }\r\n\r\n    var mc = marker.color;\r\n    var smc = selectedMarker.color;\r\n    var usmc = unselectedMarker.color;\r\n\r\n    if(smc || usmc) {\r\n        out.selectedColorFn = function(d) {\r\n            var base = d.mcc || mc;\r\n\r\n            if(d.selected) {\r\n                return smc || base;\r\n            } else {\r\n                return usmc || base;\r\n            }\r\n        };\r\n    }\r\n\r\n    var ms = marker.size;\r\n    var sms = selectedMarker.size;\r\n    var usms = unselectedMarker.size;\r\n    var smsIsDefined = sms !== undefined;\r\n    var usmsIsDefined = usms !== undefined;\r\n\r\n    if(Registry.traceIs(trace, 'symbols') && (smsIsDefined || usmsIsDefined)) {\r\n        out.selectedSizeFn = function(d) {\r\n            var base = d.mrc || ms / 2;\r\n\r\n            if(d.selected) {\r\n                return smsIsDefined ? sms / 2 : base;\r\n            } else {\r\n                return usmsIsDefined ? usms / 2 : base;\r\n            }\r\n        };\r\n    }\r\n\r\n    return out;\r\n};\r\n\r\ndrawing.makeSelectedTextStyleFns = function(trace) {\r\n    var out = {};\r\n\r\n    var selectedAttrs = trace.selected || {};\r\n    var unselectedAttrs = trace.unselected || {};\r\n\r\n    var textFont = trace.textfont || {};\r\n    var selectedTextFont = selectedAttrs.textfont || {};\r\n    var unselectedTextFont = unselectedAttrs.textfont || {};\r\n\r\n    var tc = textFont.color;\r\n    var stc = selectedTextFont.color;\r\n    var utc = unselectedTextFont.color;\r\n\r\n    out.selectedTextColorFn = function(d) {\r\n        var base = d.tc || tc;\r\n\r\n        if(d.selected) {\r\n            return stc || base;\r\n        } else {\r\n            if(utc) return utc;\r\n            else return stc ? base : Color.addOpacity(base, DESELECTDIM);\r\n        }\r\n    };\r\n\r\n    return out;\r\n};\r\n\r\ndrawing.selectedPointStyle = function(s, trace) {\r\n    if(!s.size() || !trace.selectedpoints) return;\r\n\r\n    var fns = drawing.makeSelectedPointStyleFns(trace);\r\n    var marker = trace.marker || {};\r\n    var seq = [];\r\n\r\n    if(fns.selectedOpacityFn) {\r\n        seq.push(function(pt, d) {\r\n            pt.style('opacity', fns.selectedOpacityFn(d));\r\n        });\r\n    }\r\n\r\n    if(fns.selectedColorFn) {\r\n        seq.push(function(pt, d) {\r\n            Color.fill(pt, fns.selectedColorFn(d));\r\n        });\r\n    }\r\n\r\n    if(fns.selectedSizeFn) {\r\n        seq.push(function(pt, d) {\r\n            var mx = d.mx || marker.symbol || 0;\r\n            var mrc2 = fns.selectedSizeFn(d);\r\n\r\n            pt.attr('d', makePointPath(drawing.symbolNumber(mx), mrc2));\r\n\r\n            // save for Drawing.selectedTextStyle\r\n            d.mrc2 = mrc2;\r\n        });\r\n    }\r\n\r\n    if(seq.length) {\r\n        s.each(function(d) {\r\n            var pt = d3.select(this);\r\n            for(var i = 0; i < seq.length; i++) {\r\n                seq[i](pt, d);\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\ndrawing.tryColorscale = function(marker, prefix) {\r\n    var cont = prefix ? Lib.nestedProperty(marker, prefix).get() : marker;\r\n\r\n    if(cont) {\r\n        var colorArray = cont.color;\r\n        if((cont.colorscale || cont._colorAx) && Lib.isArrayOrTypedArray(colorArray)) {\r\n            return Colorscale.makeColorScaleFuncFromTrace(cont);\r\n        }\r\n    }\r\n    return Lib.identity;\r\n};\r\n\r\nvar TEXTOFFSETSIGN = {\r\n    start: 1, end: -1, middle: 0, bottom: 1, top: -1\r\n};\r\n\r\nfunction textPointPosition(s, textPosition, fontSize, markerRadius) {\r\n    var group = d3.select(s.node().parentNode);\r\n\r\n    var v = textPosition.indexOf('top') !== -1 ?\r\n        'top' :\r\n        textPosition.indexOf('bottom') !== -1 ? 'bottom' : 'middle';\r\n    var h = textPosition.indexOf('left') !== -1 ?\r\n        'end' :\r\n        textPosition.indexOf('right') !== -1 ? 'start' : 'middle';\r\n\r\n    // if markers are shown, offset a little more than\r\n    // the nominal marker size\r\n    // ie 2/1.6 * nominal, bcs some markers are a bit bigger\r\n    var r = markerRadius ? markerRadius / 0.8 + 1 : 0;\r\n\r\n    var numLines = (svgTextUtils.lineCount(s) - 1) * LINE_SPACING + 1;\r\n    var dx = TEXTOFFSETSIGN[h] * r;\r\n    var dy = fontSize * 0.75 + TEXTOFFSETSIGN[v] * r +\r\n        (TEXTOFFSETSIGN[v] - 1) * numLines * fontSize / 2;\r\n\r\n    // fix the overall text group position\r\n    s.attr('text-anchor', h);\r\n    group.attr('transform', strTranslate(dx, dy));\r\n}\r\n\r\nfunction extracTextFontSize(d, trace) {\r\n    var fontSize = d.ts || trace.textfont.size;\r\n    return (isNumeric(fontSize) && fontSize > 0) ? fontSize : 0;\r\n}\r\n\r\n// draw text at points\r\ndrawing.textPointStyle = function(s, trace, gd) {\r\n    if(!s.size()) return;\r\n\r\n    var selectedTextColorFn;\r\n    if(trace.selectedpoints) {\r\n        var fns = drawing.makeSelectedTextStyleFns(trace);\r\n        selectedTextColorFn = fns.selectedTextColorFn;\r\n    }\r\n\r\n    var texttemplate = trace.texttemplate;\r\n    var fullLayout = gd._fullLayout;\r\n\r\n    s.each(function(d) {\r\n        var p = d3.select(this);\r\n\r\n        var text = texttemplate ?\r\n            Lib.extractOption(d, trace, 'txt', 'texttemplate') :\r\n            Lib.extractOption(d, trace, 'tx', 'text');\r\n\r\n        if(!text && text !== 0) {\r\n            p.remove();\r\n            return;\r\n        }\r\n\r\n        if(texttemplate) {\r\n            var fn = trace._module.formatLabels;\r\n            var labels = fn ? fn(d, trace, fullLayout) : {};\r\n            var pointValues = {};\r\n            appendArrayPointValue(pointValues, trace, d.i);\r\n            var meta = trace._meta || {};\r\n            text = Lib.texttemplateString(text, labels, fullLayout._d3locale, pointValues, d, meta);\r\n        }\r\n\r\n        var pos = d.tp || trace.textposition;\r\n        var fontSize = extracTextFontSize(d, trace);\r\n        var fontColor = selectedTextColorFn ?\r\n            selectedTextColorFn(d) :\r\n            (d.tc || trace.textfont.color);\r\n\r\n        p.call(drawing.font,\r\n                d.tf || trace.textfont.family,\r\n                fontSize,\r\n                fontColor)\r\n            .text(text)\r\n            .call(svgTextUtils.convertToTspans, gd)\r\n            .call(textPointPosition, pos, fontSize, d.mrc);\r\n    });\r\n};\r\n\r\ndrawing.selectedTextStyle = function(s, trace) {\r\n    if(!s.size() || !trace.selectedpoints) return;\r\n\r\n    var fns = drawing.makeSelectedTextStyleFns(trace);\r\n\r\n    s.each(function(d) {\r\n        var tx = d3.select(this);\r\n        var tc = fns.selectedTextColorFn(d);\r\n        var tp = d.tp || trace.textposition;\r\n        var fontSize = extracTextFontSize(d, trace);\r\n\r\n        Color.fill(tx, tc);\r\n        textPointPosition(tx, tp, fontSize, d.mrc2 || d.mrc);\r\n    });\r\n};\r\n\r\n// generalized Catmull-Rom splines, per\r\n// http://www.cemyuksel.com/research/catmullrom_param/catmullrom.pdf\r\nvar CatmullRomExp = 0.5;\r\ndrawing.smoothopen = function(pts, smoothness) {\r\n    if(pts.length < 3) { return 'M' + pts.join('L');}\r\n    var path = 'M' + pts[0];\r\n    var tangents = [];\r\n    var i;\r\n    for(i = 1; i < pts.length - 1; i++) {\r\n        tangents.push(makeTangent(pts[i - 1], pts[i], pts[i + 1], smoothness));\r\n    }\r\n    path += 'Q' + tangents[0][0] + ' ' + pts[1];\r\n    for(i = 2; i < pts.length - 1; i++) {\r\n        path += 'C' + tangents[i - 2][1] + ' ' + tangents[i - 1][0] + ' ' + pts[i];\r\n    }\r\n    path += 'Q' + tangents[pts.length - 3][1] + ' ' + pts[pts.length - 1];\r\n    return path;\r\n};\r\n\r\ndrawing.smoothclosed = function(pts, smoothness) {\r\n    if(pts.length < 3) { return 'M' + pts.join('L') + 'Z'; }\r\n    var path = 'M' + pts[0];\r\n    var pLast = pts.length - 1;\r\n    var tangents = [makeTangent(pts[pLast], pts[0], pts[1], smoothness)];\r\n    var i;\r\n    for(i = 1; i < pLast; i++) {\r\n        tangents.push(makeTangent(pts[i - 1], pts[i], pts[i + 1], smoothness));\r\n    }\r\n    tangents.push(\r\n        makeTangent(pts[pLast - 1], pts[pLast], pts[0], smoothness)\r\n    );\r\n\r\n    for(i = 1; i <= pLast; i++) {\r\n        path += 'C' + tangents[i - 1][1] + ' ' + tangents[i][0] + ' ' + pts[i];\r\n    }\r\n    path += 'C' + tangents[pLast][1] + ' ' + tangents[0][0] + ' ' + pts[0] + 'Z';\r\n    return path;\r\n};\r\n\r\nfunction makeTangent(prevpt, thispt, nextpt, smoothness) {\r\n    var d1x = prevpt[0] - thispt[0];\r\n    var d1y = prevpt[1] - thispt[1];\r\n    var d2x = nextpt[0] - thispt[0];\r\n    var d2y = nextpt[1] - thispt[1];\r\n    var d1a = Math.pow(d1x * d1x + d1y * d1y, CatmullRomExp / 2);\r\n    var d2a = Math.pow(d2x * d2x + d2y * d2y, CatmullRomExp / 2);\r\n    var numx = (d2a * d2a * d1x - d1a * d1a * d2x) * smoothness;\r\n    var numy = (d2a * d2a * d1y - d1a * d1a * d2y) * smoothness;\r\n    var denom1 = 3 * d2a * (d1a + d2a);\r\n    var denom2 = 3 * d1a * (d1a + d2a);\r\n    return [\r\n        [\r\n            d3.round(thispt[0] + (denom1 && numx / denom1), 2),\r\n            d3.round(thispt[1] + (denom1 && numy / denom1), 2)\r\n        ], [\r\n            d3.round(thispt[0] - (denom2 && numx / denom2), 2),\r\n            d3.round(thispt[1] - (denom2 && numy / denom2), 2)\r\n        ]\r\n    ];\r\n}\r\n\r\n// step paths - returns a generator function for paths\r\n// with the given step shape\r\nvar STEPPATH = {\r\n    hv: function(p0, p1) {\r\n        return 'H' + d3.round(p1[0], 2) + 'V' + d3.round(p1[1], 2);\r\n    },\r\n    vh: function(p0, p1) {\r\n        return 'V' + d3.round(p1[1], 2) + 'H' + d3.round(p1[0], 2);\r\n    },\r\n    hvh: function(p0, p1) {\r\n        return 'H' + d3.round((p0[0] + p1[0]) / 2, 2) + 'V' +\r\n            d3.round(p1[1], 2) + 'H' + d3.round(p1[0], 2);\r\n    },\r\n    vhv: function(p0, p1) {\r\n        return 'V' + d3.round((p0[1] + p1[1]) / 2, 2) + 'H' +\r\n            d3.round(p1[0], 2) + 'V' + d3.round(p1[1], 2);\r\n    }\r\n};\r\nvar STEPLINEAR = function(p0, p1) {\r\n    return 'L' + d3.round(p1[0], 2) + ',' + d3.round(p1[1], 2);\r\n};\r\ndrawing.steps = function(shape) {\r\n    var onestep = STEPPATH[shape] || STEPLINEAR;\r\n    return function(pts) {\r\n        var path = 'M' + d3.round(pts[0][0], 2) + ',' + d3.round(pts[0][1], 2);\r\n        for(var i = 1; i < pts.length; i++) {\r\n            path += onestep(pts[i - 1], pts[i]);\r\n        }\r\n        return path;\r\n    };\r\n};\r\n\r\n// off-screen svg render testing element, shared by the whole page\r\n// uses the id 'js-plotly-tester' and stores it in drawing.tester\r\ndrawing.makeTester = function() {\r\n    var tester = Lib.ensureSingleById(d3.select('body'), 'svg', 'js-plotly-tester', function(s) {\r\n        s.attr(xmlnsNamespaces.svgAttrs)\r\n            .style({\r\n                position: 'absolute',\r\n                left: '-10000px',\r\n                top: '-10000px',\r\n                width: '9000px',\r\n                height: '9000px',\r\n                'z-index': '1'\r\n            });\r\n    });\r\n\r\n    // browsers differ on how they describe the bounding rect of\r\n    // the svg if its contents spill over... so make a 1x1px\r\n    // reference point we can measure off of.\r\n    var testref = Lib.ensureSingle(tester, 'path', 'js-reference-point', function(s) {\r\n        s.attr('d', 'M0,0H1V1H0Z')\r\n            .style({\r\n                'stroke-width': 0,\r\n                fill: 'black'\r\n            });\r\n    });\r\n\r\n    drawing.tester = tester;\r\n    drawing.testref = testref;\r\n};\r\n\r\n/*\r\n * use our offscreen tester to get a clientRect for an element,\r\n * in a reference frame where it isn't translated (or transformed) and\r\n * its anchor point is at (0,0)\r\n * always returns a copy of the bbox, so the caller can modify it safely\r\n *\r\n * @param {SVGElement} node: the element to measure. If possible this should be\r\n *   a <text> or MathJax <g> element that's already passed through\r\n *   `convertToTspans` because in that case we can cache the results, but it's\r\n *   possible to pass in any svg element.\r\n *\r\n * @param {boolean} inTester: is this element already in `drawing.tester`?\r\n *   If you are measuring a dummy element, rather than one you really intend\r\n *   to use on the plot, making it in `drawing.tester` in the first place\r\n *   allows us to test faster because it cuts out cloning and appending it.\r\n *\r\n * @param {string} hash: for internal use only, if we already know the cache key\r\n *   for this element beforehand.\r\n *\r\n * @return {object}: a plain object containing the width, height, left, right,\r\n *   top, and bottom of `node`\r\n */\r\ndrawing.savedBBoxes = {};\r\nvar savedBBoxesCount = 0;\r\nvar maxSavedBBoxes = 10000;\r\n\r\ndrawing.bBox = function(node, inTester, hash) {\r\n    /*\r\n     * Cache elements we've already measured so we don't have to\r\n     * remeasure the same thing many times\r\n     * We have a few bBox callers though who pass a node larger than\r\n     * a <text> or a MathJax <g>, such as an axis group containing many labels.\r\n     * These will not generate a hash (unless we figure out an appropriate\r\n     * hash key for them) and thus we will not hash them.\r\n     */\r\n    if(!hash) hash = nodeHash(node);\r\n    var out;\r\n    if(hash) {\r\n        out = drawing.savedBBoxes[hash];\r\n        if(out) return Lib.extendFlat({}, out);\r\n    } else if(node.childNodes.length === 1) {\r\n        /*\r\n         * If we have only one child element, which is itself hashable, make\r\n         * a new hash from this element plus its x,y,transform\r\n         * These bounding boxes *include* x,y,transform - mostly for use by\r\n         * callers trying to avoid overlaps (ie titles)\r\n         */\r\n        var innerNode = node.childNodes[0];\r\n\r\n        hash = nodeHash(innerNode);\r\n        if(hash) {\r\n            var x = +innerNode.getAttribute('x') || 0;\r\n            var y = +innerNode.getAttribute('y') || 0;\r\n            var transform = innerNode.getAttribute('transform');\r\n\r\n            if(!transform) {\r\n                // in this case, just varying x and y, don't bother caching\r\n                // the final bBox because the alteration is quick.\r\n                var innerBB = drawing.bBox(innerNode, false, hash);\r\n                if(x) {\r\n                    innerBB.left += x;\r\n                    innerBB.right += x;\r\n                }\r\n                if(y) {\r\n                    innerBB.top += y;\r\n                    innerBB.bottom += y;\r\n                }\r\n                return innerBB;\r\n            }\r\n            /*\r\n             * else we have a transform - rather than make a complicated\r\n             * (and error-prone and probably slow) transform parser/calculator,\r\n             * just continue on calculating the boundingClientRect of the group\r\n             * and use the new composite hash to cache it.\r\n             * That said, `innerNode.transform.baseVal` is an array of\r\n             * `SVGTransform` objects, that *do* seem to have a nice matrix\r\n             * multiplication interface that we could use to avoid making\r\n             * another getBoundingClientRect call...\r\n             */\r\n            hash += '~' + x + '~' + y + '~' + transform;\r\n\r\n            out = drawing.savedBBoxes[hash];\r\n            if(out) return Lib.extendFlat({}, out);\r\n        }\r\n    }\r\n    var testNode, tester;\r\n    if(inTester) {\r\n        testNode = node;\r\n    } else {\r\n        tester = drawing.tester.node();\r\n\r\n        // copy the node to test into the tester\r\n        testNode = node.cloneNode(true);\r\n        tester.appendChild(testNode);\r\n    }\r\n\r\n    // standardize its position (and newline tspans if any)\r\n    d3.select(testNode)\r\n        .attr('transform', null)\r\n        .call(svgTextUtils.positionText, 0, 0);\r\n\r\n    var testRect = testNode.getBoundingClientRect();\r\n    var refRect = drawing.testref\r\n        .node()\r\n        .getBoundingClientRect();\r\n\r\n    if(!inTester) tester.removeChild(testNode);\r\n\r\n    var bb = {\r\n        height: testRect.height,\r\n        width: testRect.width,\r\n        left: testRect.left - refRect.left,\r\n        top: testRect.top - refRect.top,\r\n        right: testRect.right - refRect.left,\r\n        bottom: testRect.bottom - refRect.top\r\n    };\r\n\r\n    // make sure we don't have too many saved boxes,\r\n    // or a long session could overload on memory\r\n    // by saving boxes for long-gone elements\r\n    if(savedBBoxesCount >= maxSavedBBoxes) {\r\n        drawing.savedBBoxes = {};\r\n        savedBBoxesCount = 0;\r\n    }\r\n\r\n    // cache this bbox\r\n    if(hash) drawing.savedBBoxes[hash] = bb;\r\n    savedBBoxesCount++;\r\n\r\n    return Lib.extendFlat({}, bb);\r\n};\r\n\r\n// capture everything about a node (at least in our usage) that\r\n// impacts its bounding box, given that bBox clears x, y, and transform\r\nfunction nodeHash(node) {\r\n    var inputText = node.getAttribute('data-unformatted');\r\n    if(inputText === null) return;\r\n    return inputText +\r\n        node.getAttribute('data-math') +\r\n        node.getAttribute('text-anchor') +\r\n        node.getAttribute('style');\r\n}\r\n\r\n/**\r\n * Set clipPath URL in a way that work for all situations.\r\n *\r\n * In details, graphs on pages with <base> HTML tags need to prepend\r\n * the clip path ids with the page's base url EXCEPT during toImage exports.\r\n *\r\n * @param {d3 selection} s : node to add clip-path attribute\r\n * @param {string} localId : local clip-path (w/o base url) id\r\n * @param {DOM element || object} gd\r\n * - context._baseUrl {string}\r\n * - context._exportedPlot {boolean}\r\n */\r\ndrawing.setClipUrl = function(s, localId, gd) {\r\n    s.attr('clip-path', getFullUrl(localId, gd));\r\n};\r\n\r\nfunction getFullUrl(localId, gd) {\r\n    if(!localId) return null;\r\n\r\n    var context = gd._context;\r\n    var baseUrl = context._exportedPlot ? '' : (context._baseUrl || '');\r\n    return baseUrl ?\r\n        'url(\\'' + baseUrl + '#' + localId + '\\')' :\r\n        'url(#' + localId + ')';\r\n}\r\n\r\ndrawing.getTranslate = function(element) {\r\n    // Note the separator [^\\d] between x and y in this regex\r\n    // We generally use ',' but IE will convert it to ' '\r\n    var re = /.*\\btranslate\\((-?\\d*\\.?\\d*)[^-\\d]*(-?\\d*\\.?\\d*)[^\\d].*/;\r\n    var getter = element.attr ? 'attr' : 'getAttribute';\r\n    var transform = element[getter]('transform') || '';\r\n\r\n    var translate = transform.replace(re, function(match, p1, p2) {\r\n        return [p1, p2].join(' ');\r\n    })\r\n    .split(' ');\r\n\r\n    return {\r\n        x: +translate[0] || 0,\r\n        y: +translate[1] || 0\r\n    };\r\n};\r\n\r\ndrawing.setTranslate = function(element, x, y) {\r\n    var re = /(\\btranslate\\(.*?\\);?)/;\r\n    var getter = element.attr ? 'attr' : 'getAttribute';\r\n    var setter = element.attr ? 'attr' : 'setAttribute';\r\n    var transform = element[getter]('transform') || '';\r\n\r\n    x = x || 0;\r\n    y = y || 0;\r\n\r\n    transform = transform.replace(re, '').trim();\r\n    transform += strTranslate(x, y);\r\n    transform = transform.trim();\r\n\r\n    element[setter]('transform', transform);\r\n\r\n    return transform;\r\n};\r\n\r\ndrawing.getScale = function(element) {\r\n    var re = /.*\\bscale\\((\\d*\\.?\\d*)[^\\d]*(\\d*\\.?\\d*)[^\\d].*/;\r\n    var getter = element.attr ? 'attr' : 'getAttribute';\r\n    var transform = element[getter]('transform') || '';\r\n\r\n    var translate = transform.replace(re, function(match, p1, p2) {\r\n        return [p1, p2].join(' ');\r\n    })\r\n    .split(' ');\r\n\r\n    return {\r\n        x: +translate[0] || 1,\r\n        y: +translate[1] || 1\r\n    };\r\n};\r\n\r\ndrawing.setScale = function(element, x, y) {\r\n    var re = /(\\bscale\\(.*?\\);?)/;\r\n    var getter = element.attr ? 'attr' : 'getAttribute';\r\n    var setter = element.attr ? 'attr' : 'setAttribute';\r\n    var transform = element[getter]('transform') || '';\r\n\r\n    x = x || 1;\r\n    y = y || 1;\r\n\r\n    transform = transform.replace(re, '').trim();\r\n    transform += 'scale(' + x + ',' + y + ')';\r\n    transform = transform.trim();\r\n\r\n    element[setter]('transform', transform);\r\n\r\n    return transform;\r\n};\r\n\r\nvar SCALE_RE = /\\s*sc.*/;\r\n\r\ndrawing.setPointGroupScale = function(selection, xScale, yScale) {\r\n    xScale = xScale || 1;\r\n    yScale = yScale || 1;\r\n\r\n    if(!selection) return;\r\n\r\n    // The same scale transform for every point:\r\n    var scale = (xScale === 1 && yScale === 1) ?\r\n        '' :\r\n        'scale(' + xScale + ',' + yScale + ')';\r\n\r\n    selection.each(function() {\r\n        var t = (this.getAttribute('transform') || '').replace(SCALE_RE, '');\r\n        t += scale;\r\n        t = t.trim();\r\n        this.setAttribute('transform', t);\r\n    });\r\n};\r\n\r\nvar TEXT_POINT_LAST_TRANSLATION_RE = /translate\\([^)]*\\)\\s*$/;\r\n\r\ndrawing.setTextPointsScale = function(selection, xScale, yScale) {\r\n    if(!selection) return;\r\n\r\n    selection.each(function() {\r\n        var transforms;\r\n        var el = d3.select(this);\r\n        var text = el.select('text');\r\n\r\n        if(!text.node()) return;\r\n\r\n        var x = parseFloat(text.attr('x') || 0);\r\n        var y = parseFloat(text.attr('y') || 0);\r\n\r\n        var existingTransform = (el.attr('transform') || '').match(TEXT_POINT_LAST_TRANSLATION_RE);\r\n\r\n        if(xScale === 1 && yScale === 1) {\r\n            transforms = [];\r\n        } else {\r\n            transforms = [\r\n                strTranslate(x, y),\r\n                'scale(' + xScale + ',' + yScale + ')',\r\n                strTranslate(-x, -y),\r\n            ];\r\n        }\r\n\r\n        if(existingTransform) {\r\n            transforms.push(existingTransform);\r\n        }\r\n\r\n        el.attr('transform', transforms.join(''));\r\n    });\r\n};\r\n"]},"metadata":{},"sourceType":"script"}