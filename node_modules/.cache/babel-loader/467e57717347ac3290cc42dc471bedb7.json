{"ast":null,"code":"'use strict';\n\nvar cluster = require('@plotly/point-cluster');\n\nvar Lib = require('../../lib');\n\nvar AxisIDs = require('../../plots/cartesian/axis_ids');\n\nvar findExtremes = require('../../plots/cartesian/autorange').findExtremes;\n\nvar alignPeriod = require('../../plots/cartesian/align_period');\n\nvar scatterCalc = require('../scatter/calc');\n\nvar calcMarkerSize = scatterCalc.calcMarkerSize;\nvar calcAxisExpansion = scatterCalc.calcAxisExpansion;\nvar setFirstScatter = scatterCalc.setFirstScatter;\n\nvar calcColorscale = require('../scatter/colorscale_calc');\n\nvar convert = require('./convert');\n\nvar sceneUpdate = require('./scene_update');\n\nvar BADNUM = require('../../constants/numerical').BADNUM;\n\nvar TOO_MANY_POINTS = require('./constants').TOO_MANY_POINTS;\n\nmodule.exports = function calc(gd, trace) {\n  var fullLayout = gd._fullLayout;\n  var xa = AxisIDs.getFromId(gd, trace.xaxis);\n  var ya = AxisIDs.getFromId(gd, trace.yaxis);\n  var subplot = fullLayout._plots[trace.xaxis + trace.yaxis];\n  var len = trace._length;\n  var hasTooManyPoints = len >= TOO_MANY_POINTS;\n  var len2 = len * 2;\n  var stash = {};\n  var i;\n  var origX = xa.makeCalcdata(trace, 'x');\n  var origY = ya.makeCalcdata(trace, 'y');\n  var x = alignPeriod(trace, xa, 'x', origX);\n  var y = alignPeriod(trace, ya, 'y', origY);\n  trace._x = x;\n  trace._y = y;\n  if (trace.xperiodalignment) trace._origX = origX;\n  if (trace.yperiodalignment) trace._origY = origY; // we need hi-precision for scatter2d,\n  // regl-scatter2d uses NaNs for bad/missing values\n\n  var positions = new Array(len2);\n\n  var _ids = new Array(len);\n\n  for (i = 0; i < len; i++) {\n    positions[i * 2] = x[i] === BADNUM ? NaN : x[i];\n    positions[i * 2 + 1] = y[i] === BADNUM ? NaN : y[i]; // Pre-compute ids.\n\n    _ids[i] = i;\n  }\n\n  if (xa.type === 'log') {\n    for (i = 0; i < len2; i += 2) {\n      positions[i] = xa.c2l(positions[i]);\n    }\n  }\n\n  if (ya.type === 'log') {\n    for (i = 1; i < len2; i += 2) {\n      positions[i] = ya.c2l(positions[i]);\n    }\n  } // we don't build a tree for log axes since it takes long to convert log2px\n  // and it is also\n\n\n  if (hasTooManyPoints && xa.type !== 'log' && ya.type !== 'log') {\n    // FIXME: delegate this to webworker\n    stash.tree = cluster(positions);\n  } else {\n    stash.ids = _ids;\n  } // create scene options and scene\n\n\n  calcColorscale(gd, trace);\n  var opts = sceneOptions(gd, subplot, trace, positions, x, y);\n  var scene = sceneUpdate(gd, subplot); // Reuse SVG scatter axis expansion routine.\n  // For graphs with very large number of points and array marker.size,\n  // use average marker size instead to speed things up.\n\n  setFirstScatter(fullLayout, trace);\n  var ppad;\n\n  if (!hasTooManyPoints) {\n    ppad = calcMarkerSize(trace, len);\n  } else if (opts.marker) {\n    ppad = 2 * (opts.marker.sizeAvg || Math.max(opts.marker.size, 3));\n  }\n\n  calcAxisExpansion(gd, trace, xa, ya, x, y, ppad);\n  if (opts.errorX) expandForErrorBars(trace, xa, opts.errorX);\n  if (opts.errorY) expandForErrorBars(trace, ya, opts.errorY); // set flags to create scene renderers\n\n  if (opts.fill && !scene.fill2d) scene.fill2d = true;\n  if (opts.marker && !scene.scatter2d) scene.scatter2d = true;\n  if (opts.line && !scene.line2d) scene.line2d = true;\n  if ((opts.errorX || opts.errorY) && !scene.error2d) scene.error2d = true;\n  if (opts.text && !scene.glText) scene.glText = true;\n  if (opts.marker) opts.marker.snap = len;\n  scene.lineOptions.push(opts.line);\n  scene.errorXOptions.push(opts.errorX);\n  scene.errorYOptions.push(opts.errorY);\n  scene.fillOptions.push(opts.fill);\n  scene.markerOptions.push(opts.marker);\n  scene.markerSelectedOptions.push(opts.markerSel);\n  scene.markerUnselectedOptions.push(opts.markerUnsel);\n  scene.textOptions.push(opts.text);\n  scene.textSelectedOptions.push(opts.textSel);\n  scene.textUnselectedOptions.push(opts.textUnsel);\n  scene.selectBatch.push([]);\n  scene.unselectBatch.push([]);\n  stash._scene = scene;\n  stash.index = scene.count;\n  stash.x = x;\n  stash.y = y;\n  stash.positions = positions;\n  scene.count++;\n  return [{\n    x: false,\n    y: false,\n    t: stash,\n    trace: trace\n  }];\n};\n\nfunction expandForErrorBars(trace, ax, opts) {\n  var extremes = trace._extremes[ax._id];\n  var errExt = findExtremes(ax, opts._bnds, {\n    padded: true\n  });\n  extremes.min = extremes.min.concat(errExt.min);\n  extremes.max = extremes.max.concat(errExt.max);\n}\n\nfunction sceneOptions(gd, subplot, trace, positions, x, y) {\n  var opts = convert.style(gd, trace);\n\n  if (opts.marker) {\n    opts.marker.positions = positions;\n  }\n\n  if (opts.line && positions.length > 1) {\n    Lib.extendFlat(opts.line, convert.linePositions(gd, trace, positions));\n  }\n\n  if (opts.errorX || opts.errorY) {\n    var errors = convert.errorBarPositions(gd, trace, positions, x, y);\n\n    if (opts.errorX) {\n      Lib.extendFlat(opts.errorX, errors.x);\n    }\n\n    if (opts.errorY) {\n      Lib.extendFlat(opts.errorY, errors.y);\n    }\n  }\n\n  if (opts.text) {\n    Lib.extendFlat(opts.text, {\n      positions: positions\n    }, convert.textPosition(gd, trace, opts.text, opts.marker));\n    Lib.extendFlat(opts.textSel, {\n      positions: positions\n    }, convert.textPosition(gd, trace, opts.text, opts.markerSel));\n    Lib.extendFlat(opts.textUnsel, {\n      positions: positions\n    }, convert.textPosition(gd, trace, opts.text, opts.markerUnsel));\n  }\n\n  return opts;\n}","map":{"version":3,"sources":["C:/Users/mikke/VSC/fantasy-django-react/fantasy-django/fantasy-react-app/node_modules/plotly.js/src/traces/scattergl/calc.js"],"names":["cluster","require","Lib","AxisIDs","findExtremes","alignPeriod","scatterCalc","calcMarkerSize","calcAxisExpansion","setFirstScatter","calcColorscale","convert","sceneUpdate","BADNUM","TOO_MANY_POINTS","module","exports","calc","gd","trace","fullLayout","_fullLayout","xa","getFromId","xaxis","ya","yaxis","subplot","_plots","len","_length","hasTooManyPoints","len2","stash","i","origX","makeCalcdata","origY","x","y","_x","_y","xperiodalignment","_origX","yperiodalignment","_origY","positions","Array","_ids","NaN","type","c2l","tree","ids","opts","sceneOptions","scene","ppad","marker","sizeAvg","Math","max","size","errorX","expandForErrorBars","errorY","fill","fill2d","scatter2d","line","line2d","error2d","text","glText","snap","lineOptions","push","errorXOptions","errorYOptions","fillOptions","markerOptions","markerSelectedOptions","markerSel","markerUnselectedOptions","markerUnsel","textOptions","textSelectedOptions","textSel","textUnselectedOptions","textUnsel","selectBatch","unselectBatch","_scene","index","count","t","ax","extremes","_extremes","_id","errExt","_bnds","padded","min","concat","style","length","extendFlat","linePositions","errors","errorBarPositions","textPosition"],"mappings":"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","sourcesContent":["'use strict';\n\nvar cluster = require('@plotly/point-cluster');\n\nvar Lib = require('../../lib');\nvar AxisIDs = require('../../plots/cartesian/axis_ids');\nvar findExtremes = require('../../plots/cartesian/autorange').findExtremes;\nvar alignPeriod = require('../../plots/cartesian/align_period');\n\nvar scatterCalc = require('../scatter/calc');\nvar calcMarkerSize = scatterCalc.calcMarkerSize;\nvar calcAxisExpansion = scatterCalc.calcAxisExpansion;\nvar setFirstScatter = scatterCalc.setFirstScatter;\nvar calcColorscale = require('../scatter/colorscale_calc');\nvar convert = require('./convert');\nvar sceneUpdate = require('./scene_update');\n\nvar BADNUM = require('../../constants/numerical').BADNUM;\nvar TOO_MANY_POINTS = require('./constants').TOO_MANY_POINTS;\n\nmodule.exports = function calc(gd, trace) {\n    var fullLayout = gd._fullLayout;\n    var xa = AxisIDs.getFromId(gd, trace.xaxis);\n    var ya = AxisIDs.getFromId(gd, trace.yaxis);\n    var subplot = fullLayout._plots[trace.xaxis + trace.yaxis];\n    var len = trace._length;\n    var hasTooManyPoints = len >= TOO_MANY_POINTS;\n    var len2 = len * 2;\n    var stash = {};\n    var i;\n\n    var origX = xa.makeCalcdata(trace, 'x');\n    var origY = ya.makeCalcdata(trace, 'y');\n    var x = alignPeriod(trace, xa, 'x', origX);\n    var y = alignPeriod(trace, ya, 'y', origY);\n    trace._x = x;\n    trace._y = y;\n\n    if(trace.xperiodalignment) trace._origX = origX;\n    if(trace.yperiodalignment) trace._origY = origY;\n\n    // we need hi-precision for scatter2d,\n    // regl-scatter2d uses NaNs for bad/missing values\n    var positions = new Array(len2);\n    var _ids = new Array(len);\n    for(i = 0; i < len; i++) {\n        positions[i * 2] = x[i] === BADNUM ? NaN : x[i];\n        positions[i * 2 + 1] = y[i] === BADNUM ? NaN : y[i];\n        // Pre-compute ids.\n        _ids[i] = i;\n    }\n\n    if(xa.type === 'log') {\n        for(i = 0; i < len2; i += 2) {\n            positions[i] = xa.c2l(positions[i]);\n        }\n    }\n    if(ya.type === 'log') {\n        for(i = 1; i < len2; i += 2) {\n            positions[i] = ya.c2l(positions[i]);\n        }\n    }\n\n    // we don't build a tree for log axes since it takes long to convert log2px\n    // and it is also\n    if(hasTooManyPoints && (xa.type !== 'log' && ya.type !== 'log')) {\n        // FIXME: delegate this to webworker\n        stash.tree = cluster(positions);\n    } else {\n        stash.ids = _ids;\n    }\n\n    // create scene options and scene\n    calcColorscale(gd, trace);\n    var opts = sceneOptions(gd, subplot, trace, positions, x, y);\n    var scene = sceneUpdate(gd, subplot);\n\n    // Reuse SVG scatter axis expansion routine.\n    // For graphs with very large number of points and array marker.size,\n    // use average marker size instead to speed things up.\n    setFirstScatter(fullLayout, trace);\n    var ppad;\n    if(!hasTooManyPoints) {\n        ppad = calcMarkerSize(trace, len);\n    } else if(opts.marker) {\n        ppad = 2 * (opts.marker.sizeAvg || Math.max(opts.marker.size, 3));\n    }\n    calcAxisExpansion(gd, trace, xa, ya, x, y, ppad);\n    if(opts.errorX) expandForErrorBars(trace, xa, opts.errorX);\n    if(opts.errorY) expandForErrorBars(trace, ya, opts.errorY);\n\n    // set flags to create scene renderers\n    if(opts.fill && !scene.fill2d) scene.fill2d = true;\n    if(opts.marker && !scene.scatter2d) scene.scatter2d = true;\n    if(opts.line && !scene.line2d) scene.line2d = true;\n    if((opts.errorX || opts.errorY) && !scene.error2d) scene.error2d = true;\n    if(opts.text && !scene.glText) scene.glText = true;\n    if(opts.marker) opts.marker.snap = len;\n\n    scene.lineOptions.push(opts.line);\n    scene.errorXOptions.push(opts.errorX);\n    scene.errorYOptions.push(opts.errorY);\n    scene.fillOptions.push(opts.fill);\n    scene.markerOptions.push(opts.marker);\n    scene.markerSelectedOptions.push(opts.markerSel);\n    scene.markerUnselectedOptions.push(opts.markerUnsel);\n    scene.textOptions.push(opts.text);\n    scene.textSelectedOptions.push(opts.textSel);\n    scene.textUnselectedOptions.push(opts.textUnsel);\n    scene.selectBatch.push([]);\n    scene.unselectBatch.push([]);\n\n    stash._scene = scene;\n    stash.index = scene.count;\n    stash.x = x;\n    stash.y = y;\n    stash.positions = positions;\n    scene.count++;\n\n    return [{x: false, y: false, t: stash, trace: trace}];\n};\n\nfunction expandForErrorBars(trace, ax, opts) {\n    var extremes = trace._extremes[ax._id];\n    var errExt = findExtremes(ax, opts._bnds, {padded: true});\n    extremes.min = extremes.min.concat(errExt.min);\n    extremes.max = extremes.max.concat(errExt.max);\n}\n\nfunction sceneOptions(gd, subplot, trace, positions, x, y) {\n    var opts = convert.style(gd, trace);\n\n    if(opts.marker) {\n        opts.marker.positions = positions;\n    }\n\n    if(opts.line && positions.length > 1) {\n        Lib.extendFlat(\n            opts.line,\n            convert.linePositions(gd, trace, positions)\n        );\n    }\n\n    if(opts.errorX || opts.errorY) {\n        var errors = convert.errorBarPositions(gd, trace, positions, x, y);\n\n        if(opts.errorX) {\n            Lib.extendFlat(opts.errorX, errors.x);\n        }\n        if(opts.errorY) {\n            Lib.extendFlat(opts.errorY, errors.y);\n        }\n    }\n\n    if(opts.text) {\n        Lib.extendFlat(\n            opts.text,\n            {positions: positions},\n            convert.textPosition(gd, trace, opts.text, opts.marker)\n        );\n        Lib.extendFlat(\n            opts.textSel,\n            {positions: positions},\n            convert.textPosition(gd, trace, opts.text, opts.markerSel)\n        );\n        Lib.extendFlat(\n            opts.textUnsel,\n            {positions: positions},\n            convert.textPosition(gd, trace, opts.text, opts.markerUnsel)\n        );\n    }\n\n    return opts;\n}\n"]},"metadata":{},"sourceType":"script"}