{"ast":null,"code":"'use strict';\n\nvar mapboxgl = require('mapbox-gl/dist/mapbox-gl-unminified');\n\nvar Lib = require('../../lib');\n\nvar geoUtils = require('../../lib/geo_location_utils');\n\nvar Registry = require('../../registry');\n\nvar Axes = require('../cartesian/axes');\n\nvar dragElement = require('../../components/dragelement');\n\nvar Fx = require('../../components/fx');\n\nvar dragHelpers = require('../../components/dragelement/helpers');\n\nvar rectMode = dragHelpers.rectMode;\nvar drawMode = dragHelpers.drawMode;\nvar selectMode = dragHelpers.selectMode;\n\nvar prepSelect = require('../cartesian/select').prepSelect;\n\nvar clearSelect = require('../cartesian/select').clearSelect;\n\nvar clearSelectionsCache = require('../cartesian/select').clearSelectionsCache;\n\nvar selectOnClick = require('../cartesian/select').selectOnClick;\n\nvar constants = require('./constants');\n\nvar createMapboxLayer = require('./layers');\n\nfunction Mapbox(gd, id) {\n  this.id = id;\n  this.gd = gd;\n  var fullLayout = gd._fullLayout;\n  var context = gd._context;\n  this.container = fullLayout._glcontainer.node();\n  this.isStatic = context.staticPlot; // unique id for this Mapbox instance\n\n  this.uid = fullLayout._uid + '-' + this.id; // create framework on instantiation for a smoother first plot call\n\n  this.div = null;\n  this.xaxis = null;\n  this.yaxis = null;\n  this.createFramework(fullLayout); // state variables used to infer how and what to update\n\n  this.map = null;\n  this.accessToken = null;\n  this.styleObj = null;\n  this.traceHash = {};\n  this.layerList = [];\n  this.belowLookup = {};\n  this.dragging = false;\n  this.wheeling = false;\n}\n\nvar proto = Mapbox.prototype;\n\nproto.plot = function (calcData, fullLayout, promises) {\n  var self = this;\n  var opts = fullLayout[self.id]; // remove map and create a new map if access token has change\n\n  if (self.map && opts.accesstoken !== self.accessToken) {\n    self.map.remove();\n    self.map = null;\n    self.styleObj = null;\n    self.traceHash = {};\n    self.layerList = [];\n  }\n\n  var promise;\n\n  if (!self.map) {\n    promise = new Promise(function (resolve, reject) {\n      self.createMap(calcData, fullLayout, resolve, reject);\n    });\n  } else {\n    promise = new Promise(function (resolve, reject) {\n      self.updateMap(calcData, fullLayout, resolve, reject);\n    });\n  }\n\n  promises.push(promise);\n};\n\nproto.createMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var opts = fullLayout[self.id]; // store style id and URL or object\n\n  var styleObj = self.styleObj = getStyleObj(opts.style); // store access token associated with this map\n\n  self.accessToken = opts.accesstoken; // create the map!\n\n  var map = self.map = new mapboxgl.Map({\n    container: self.div,\n    style: styleObj.style,\n    center: convertCenter(opts.center),\n    zoom: opts.zoom,\n    bearing: opts.bearing,\n    pitch: opts.pitch,\n    interactive: !self.isStatic,\n    preserveDrawingBuffer: self.isStatic,\n    doubleClickZoom: false,\n    boxZoom: false,\n    attributionControl: false\n  }).addControl(new mapboxgl.AttributionControl({\n    compact: true\n  })); // make sure canvas does not inherit left and top css\n\n  map._canvas.style.left = '0px';\n  map._canvas.style.top = '0px';\n  self.rejectOnError(reject);\n\n  if (!self.isStatic) {\n    self.initFx(calcData, fullLayout);\n  }\n\n  var promises = [];\n  promises.push(new Promise(function (resolve) {\n    map.once('load', resolve);\n  }));\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\n\nproto.updateMap = function (calcData, fullLayout, resolve, reject) {\n  var self = this;\n  var map = self.map;\n  var opts = fullLayout[this.id];\n  self.rejectOnError(reject);\n  var promises = [];\n  var styleObj = getStyleObj(opts.style);\n\n  if (JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\n    self.styleObj = styleObj;\n    map.setStyle(styleObj.style); // need to rebuild trace layers on reload\n    // to avoid 'lost event' errors\n\n    self.traceHash = {};\n    promises.push(new Promise(function (resolve) {\n      map.once('styledata', resolve);\n    }));\n  }\n\n  promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\n  Promise.all(promises).then(function () {\n    self.fillBelowLookup(calcData, fullLayout);\n    self.updateData(calcData);\n    self.updateLayout(fullLayout);\n    self.resolveOnRender(resolve);\n  }).catch(reject);\n};\n\nproto.fillBelowLookup = function (calcData, fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var i, val;\n  var belowLookup = this.belowLookup = {};\n  var hasTraceAtTop = false;\n\n  for (i = 0; i < calcData.length; i++) {\n    var trace = calcData[i][0].trace;\n    var _module = trace._module;\n\n    if (typeof trace.below === 'string') {\n      val = trace.below;\n    } else if (_module.getBelow) {\n      // 'smart' default that depend the map's base layers\n      val = _module.getBelow(trace, this);\n    }\n\n    if (val === '') {\n      hasTraceAtTop = true;\n    }\n\n    belowLookup['trace-' + trace.uid] = val || '';\n  }\n\n  for (i = 0; i < layers.length; i++) {\n    var item = layers[i];\n\n    if (typeof item.below === 'string') {\n      val = item.below;\n    } else if (hasTraceAtTop) {\n      // if one or more trace(s) set `below:''` and\n      // layers[i].below is unset,\n      // place layer below traces\n      val = 'traces';\n    } else {\n      val = '';\n    }\n\n    belowLookup['layout-' + i] = val;\n  } // N.B. If multiple layers have the 'below' value,\n  // we must clear the stashed 'below' field in order\n  // to make `traceHash[k].update()` and `layerList[i].update()`\n  // remove/add the all those layers to have preserve\n  // the correct layer ordering\n\n\n  var val2list = {};\n  var k, id;\n\n  for (k in belowLookup) {\n    val = belowLookup[k];\n\n    if (val2list[val]) {\n      val2list[val].push(k);\n    } else {\n      val2list[val] = [k];\n    }\n  }\n\n  for (val in val2list) {\n    var list = val2list[val];\n\n    if (list.length > 1) {\n      for (i = 0; i < list.length; i++) {\n        k = list[i];\n\n        if (k.indexOf('trace-') === 0) {\n          id = k.split('trace-')[1];\n\n          if (this.traceHash[id]) {\n            this.traceHash[id].below = null;\n          }\n        } else if (k.indexOf('layout-') === 0) {\n          id = k.split('layout-')[1];\n\n          if (this.layerList[id]) {\n            this.layerList[id].below = null;\n          }\n        }\n      }\n    }\n  }\n};\n\nvar traceType2orderIndex = {\n  choroplethmapbox: 0,\n  densitymapbox: 1,\n  scattermapbox: 2\n};\n\nproto.updateData = function (calcData) {\n  var traceHash = this.traceHash;\n  var traceObj, trace, i, j; // Need to sort here by trace type here,\n  // in case traces with different `type` have the same\n  // below value, but sorting we ensure that\n  // e.g. choroplethmapbox traces will be below scattermapbox traces\n\n  var calcDataSorted = calcData.slice().sort(function (a, b) {\n    return traceType2orderIndex[a[0].trace.type] - traceType2orderIndex[b[0].trace.type];\n  }); // update or create trace objects\n\n  for (i = 0; i < calcDataSorted.length; i++) {\n    var calcTrace = calcDataSorted[i];\n    trace = calcTrace[0].trace;\n    traceObj = traceHash[trace.uid];\n    var didUpdate = false;\n\n    if (traceObj) {\n      if (traceObj.type === trace.type) {\n        traceObj.update(calcTrace);\n        didUpdate = true;\n      } else {\n        traceObj.dispose();\n      }\n    }\n\n    if (!didUpdate && trace._module) {\n      traceHash[trace.uid] = trace._module.plot(this, calcTrace);\n    }\n  } // remove empty trace objects\n\n\n  var ids = Object.keys(traceHash);\n\n  idLoop: for (i = 0; i < ids.length; i++) {\n    var id = ids[i];\n\n    for (j = 0; j < calcData.length; j++) {\n      trace = calcData[j][0].trace;\n      if (id === trace.uid) continue idLoop;\n    }\n\n    traceObj = traceHash[id];\n    traceObj.dispose();\n    delete traceHash[id];\n  }\n};\n\nproto.updateLayout = function (fullLayout) {\n  var map = this.map;\n  var opts = fullLayout[this.id];\n\n  if (!this.dragging && !this.wheeling) {\n    map.setCenter(convertCenter(opts.center));\n    map.setZoom(opts.zoom);\n    map.setBearing(opts.bearing);\n    map.setPitch(opts.pitch);\n  }\n\n  this.updateLayers(fullLayout);\n  this.updateFramework(fullLayout);\n  this.updateFx(fullLayout);\n  this.map.resize();\n\n  if (this.gd._context._scrollZoom.mapbox) {\n    map.scrollZoom.enable();\n  } else {\n    map.scrollZoom.disable();\n  }\n};\n\nproto.resolveOnRender = function (resolve) {\n  var map = this.map;\n  map.on('render', function onRender() {\n    if (map.loaded()) {\n      map.off('render', onRender); // resolve at end of render loop\n      //\n      // Need a 10ms delay (0ms should suffice to skip a thread in the\n      // render loop) to workaround mapbox-gl bug introduced in v1.3.0\n\n      setTimeout(resolve, 10);\n    }\n  });\n};\n\nproto.rejectOnError = function (reject) {\n  var map = this.map;\n\n  function handler() {\n    reject(new Error(constants.mapOnErrorMsg));\n  }\n\n  map.once('error', handler);\n  map.once('style.error', handler);\n  map.once('source.error', handler);\n  map.once('tile.error', handler);\n  map.once('layer.error', handler);\n};\n\nproto.createFramework = function (fullLayout) {\n  var self = this;\n  var div = self.div = document.createElement('div');\n  div.id = self.uid;\n  div.style.position = 'absolute';\n  self.container.appendChild(div); // create mock x/y axes for hover routine\n\n  self.xaxis = {\n    _id: 'x',\n    c2p: function (v) {\n      return self.project(v).x;\n    }\n  };\n  self.yaxis = {\n    _id: 'y',\n    c2p: function (v) {\n      return self.project(v).y;\n    }\n  };\n  self.updateFramework(fullLayout); // mock axis for hover formatting\n\n  self.mockAxis = {\n    type: 'linear',\n    showexponent: 'all',\n    exponentformat: 'B'\n  };\n  Axes.setConvert(self.mockAxis, fullLayout);\n};\n\nproto.initFx = function (calcData, fullLayout) {\n  var self = this;\n  var gd = self.gd;\n  var map = self.map; // keep track of pan / zoom in user layout and emit relayout event\n\n  map.on('moveend', function (evt) {\n    if (!self.map) return;\n    var fullLayoutNow = gd._fullLayout; // 'moveend' gets triggered by map.setCenter, map.setZoom,\n    // map.setBearing and map.setPitch.\n    //\n    // Here, we make sure that state updates amd 'plotly_relayout'\n    // are triggered only when the 'moveend' originates from a\n    // mouse target (filtering out API calls) to not\n    // duplicate 'plotly_relayout' events.\n\n    if (evt.originalEvent || self.wheeling) {\n      var optsNow = fullLayoutNow[self.id];\n      Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\n      var viewNow = self.getView();\n      optsNow._input.center = optsNow.center = viewNow.center;\n      optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n      optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n      optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n      gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n    }\n\n    if (evt.originalEvent && evt.originalEvent.type === 'mouseup') {\n      self.dragging = false;\n    } else if (self.wheeling) {\n      self.wheeling = false;\n    }\n\n    if (fullLayoutNow._rehover) {\n      fullLayoutNow._rehover();\n    }\n  });\n  map.on('wheel', function () {\n    self.wheeling = true;\n  });\n  map.on('mousemove', function (evt) {\n    var bb = self.div.getBoundingClientRect();\n    var xy = [evt.originalEvent.offsetX, evt.originalEvent.offsetY];\n\n    evt.target.getBoundingClientRect = function () {\n      return bb;\n    };\n\n    self.xaxis.p2c = function () {\n      return map.unproject(xy).lng;\n    };\n\n    self.yaxis.p2c = function () {\n      return map.unproject(xy).lat;\n    };\n\n    gd._fullLayout._rehover = function () {\n      if (gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\n        Fx.hover(gd, evt, self.id);\n      }\n    };\n\n    Fx.hover(gd, evt, self.id);\n    gd._fullLayout._hoversubplot = self.id;\n  });\n\n  function unhover() {\n    Fx.loneUnhover(fullLayout._hoverlayer);\n  }\n\n  map.on('dragstart', function () {\n    self.dragging = true;\n    unhover();\n  });\n  map.on('zoomstart', unhover);\n  map.on('mouseout', function () {\n    gd._fullLayout._hoversubplot = null;\n  });\n\n  function emitUpdate() {\n    var viewNow = self.getView();\n    gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\n  }\n\n  map.on('drag', emitUpdate);\n  map.on('zoom', emitUpdate);\n  map.on('dblclick', function () {\n    var optsNow = gd._fullLayout[self.id];\n    Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\n    var viewInitial = self.viewInitial;\n    map.setCenter(convertCenter(viewInitial.center));\n    map.setZoom(viewInitial.zoom);\n    map.setBearing(viewInitial.bearing);\n    map.setPitch(viewInitial.pitch);\n    var viewNow = self.getView();\n    optsNow._input.center = optsNow.center = viewNow.center;\n    optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\n    optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\n    optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\n    gd.emit('plotly_doubleclick', null);\n    gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\n  }); // define event handlers on map creation, to keep one ref per map,\n  // so that map.on / map.off in updateFx works as expected\n\n  self.clearSelect = function () {\n    clearSelectionsCache(self.dragOptions);\n    clearSelect(self.dragOptions.gd);\n  };\n  /**\r\n   * Returns a click handler function that is supposed\r\n   * to handle clicks in pan mode.\r\n   */\n\n\n  self.onClickInPanFn = function (dragOptions) {\n    return function (evt) {\n      var clickMode = gd._fullLayout.clickmode;\n\n      if (clickMode.indexOf('select') > -1) {\n        selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\n      }\n\n      if (clickMode.indexOf('event') > -1) {\n        // TODO: this does not support right-click. If we want to support it, we\n        // would likely need to change mapbox to use dragElement instead of straight\n        // mapbox event binding. Or perhaps better, make a simple wrapper with the\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\n        // pie would use this too.\n        Fx.click(gd, evt.originalEvent);\n      }\n    };\n  };\n};\n\nproto.updateFx = function (fullLayout) {\n  var self = this;\n  var map = self.map;\n  var gd = self.gd;\n  if (self.isStatic) return;\n\n  function invert(pxpy) {\n    var obj = self.map.unproject(pxpy);\n    return [obj.lng, obj.lat];\n  }\n\n  var dragMode = fullLayout.dragmode;\n  var fillRangeItems;\n\n  if (rectMode(dragMode)) {\n    fillRangeItems = function (eventData, poly) {\n      var ranges = eventData.range = {};\n      ranges[self.id] = [invert([poly.xmin, poly.ymin]), invert([poly.xmax, poly.ymax])];\n    };\n  } else {\n    fillRangeItems = function (eventData, poly, pts) {\n      var dataPts = eventData.lassoPoints = {};\n      dataPts[self.id] = pts.filtered.map(invert);\n    };\n  } // Note: dragOptions is needed to be declared for all dragmodes because\n  // it's the object that holds persistent selection state.\n  // Merge old dragOptions with new to keep possibly initialized\n  // persistent selection state.\n\n\n  var oldDragOptions = self.dragOptions;\n  self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\n    dragmode: fullLayout.dragmode,\n    element: self.div,\n    gd: gd,\n    plotinfo: {\n      id: self.id,\n      domain: fullLayout[self.id].domain,\n      xaxis: self.xaxis,\n      yaxis: self.yaxis,\n      fillRangeItems: fillRangeItems\n    },\n    xaxes: [self.xaxis],\n    yaxes: [self.yaxis],\n    subplot: self.id\n  }); // Unregister the old handler before potentially registering\n  // a new one. Otherwise multiple click handlers might\n  // be registered resulting in unwanted behavior.\n\n  map.off('click', self.onClickInPanHandler);\n\n  if (selectMode(dragMode) || drawMode(dragMode)) {\n    map.dragPan.disable();\n    map.on('zoomstart', self.clearSelect);\n\n    self.dragOptions.prepFn = function (e, startX, startY) {\n      prepSelect(e, startX, startY, self.dragOptions, dragMode);\n    };\n\n    dragElement.init(self.dragOptions);\n  } else {\n    map.dragPan.enable();\n    map.off('zoomstart', self.clearSelect);\n    self.div.onmousedown = null; // TODO: this does not support right-click. If we want to support it, we\n    // would likely need to change mapbox to use dragElement instead of straight\n    // mapbox event binding. Or perhaps better, make a simple wrapper with the\n    // right mousedown, mousemove, and mouseup handlers just for a left/right click\n    // pie would use this too.\n\n    self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\n    map.on('click', self.onClickInPanHandler);\n  }\n};\n\nproto.updateFramework = function (fullLayout) {\n  var domain = fullLayout[this.id].domain;\n  var size = fullLayout._size;\n  var style = this.div.style;\n  style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\n  style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\n  style.left = size.l + domain.x[0] * size.w + 'px';\n  style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\n  this.xaxis._offset = size.l + domain.x[0] * size.w;\n  this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\n  this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\n  this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\n};\n\nproto.updateLayers = function (fullLayout) {\n  var opts = fullLayout[this.id];\n  var layers = opts.layers;\n  var layerList = this.layerList;\n  var i; // if the layer arrays don't match,\n  // don't try to be smart,\n  // delete them all, and start all over.\n\n  if (layers.length !== layerList.length) {\n    for (i = 0; i < layerList.length; i++) {\n      layerList[i].dispose();\n    }\n\n    layerList = this.layerList = [];\n\n    for (i = 0; i < layers.length; i++) {\n      layerList.push(createMapboxLayer(this, i, layers[i]));\n    }\n  } else {\n    for (i = 0; i < layers.length; i++) {\n      layerList[i].update(layers[i]);\n    }\n  }\n};\n\nproto.destroy = function () {\n  if (this.map) {\n    this.map.remove();\n    this.map = null;\n    this.container.removeChild(this.div);\n  }\n};\n\nproto.toImage = function () {\n  this.map.stop();\n  return this.map.getCanvas().toDataURL();\n}; // convenience wrapper to create set multiple layer\n// 'layout' or 'paint options at once.\n\n\nproto.setOptions = function (id, methodName, opts) {\n  for (var k in opts) {\n    this.map[methodName](id, k, opts[k]);\n  }\n};\n\nproto.getMapLayers = function () {\n  return this.map.getStyle().layers;\n}; // convenience wrapper that first check in 'below' references\n// a layer that exist and then add the layer to the map,\n\n\nproto.addLayer = function (opts, below) {\n  var map = this.map;\n\n  if (typeof below === 'string') {\n    if (below === '') {\n      map.addLayer(opts, below);\n      return;\n    }\n\n    var mapLayers = this.getMapLayers();\n\n    for (var i = 0; i < mapLayers.length; i++) {\n      if (below === mapLayers[i].id) {\n        map.addLayer(opts, below);\n        return;\n      }\n    }\n\n    Lib.warn(['Trying to add layer with *below* value', below, 'referencing a layer that does not exist', 'or that does not yet exist.'].join(' '));\n  }\n\n  map.addLayer(opts);\n}; // convenience method to project a [lon, lat] array to pixel coords\n\n\nproto.project = function (v) {\n  return this.map.project(new mapboxgl.LngLat(v[0], v[1]));\n}; // get map's current view values in plotly.js notation\n\n\nproto.getView = function () {\n  var map = this.map;\n  var mapCenter = map.getCenter();\n  var center = {\n    lon: mapCenter.lng,\n    lat: mapCenter.lat\n  };\n  var canvas = map.getCanvas();\n  var w = canvas.width;\n  var h = canvas.height;\n  return {\n    center: center,\n    zoom: map.getZoom(),\n    bearing: map.getBearing(),\n    pitch: map.getPitch(),\n    _derived: {\n      coordinates: [map.unproject([0, 0]).toArray(), map.unproject([w, 0]).toArray(), map.unproject([w, h]).toArray(), map.unproject([0, h]).toArray()]\n    }\n  };\n};\n\nproto.getViewEdits = function (cont) {\n  var id = this.id;\n  var keys = ['center', 'zoom', 'bearing', 'pitch'];\n  var obj = {};\n\n  for (var i = 0; i < keys.length; i++) {\n    var k = keys[i];\n    obj[id + '.' + k] = cont[k];\n  }\n\n  return obj;\n};\n\nproto.getViewEditsWithDerived = function (cont) {\n  var id = this.id;\n  var obj = this.getViewEdits(cont);\n  obj[id + '._derived'] = cont._derived;\n  return obj;\n};\n\nfunction getStyleObj(val) {\n  var styleObj = {};\n\n  if (Lib.isPlainObject(val)) {\n    styleObj.id = val.id;\n    styleObj.style = val;\n  } else if (typeof val === 'string') {\n    styleObj.id = val;\n\n    if (constants.styleValuesMapbox.indexOf(val) !== -1) {\n      styleObj.style = convertStyleVal(val);\n    } else if (constants.stylesNonMapbox[val]) {\n      styleObj.style = constants.stylesNonMapbox[val];\n    } else {\n      styleObj.style = val;\n    }\n  } else {\n    styleObj.id = constants.styleValueDflt;\n    styleObj.style = convertStyleVal(constants.styleValueDflt);\n  }\n\n  styleObj.transition = {\n    duration: 0,\n    delay: 0\n  };\n  return styleObj;\n} // if style is part of the 'official' mapbox values, add URL prefix and suffix\n\n\nfunction convertStyleVal(val) {\n  return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\n}\n\nfunction convertCenter(center) {\n  return [center.lon, center.lat];\n}\n\nmodule.exports = Mapbox;","map":{"version":3,"sources":["C:/Users/mikke/VSC/fantasy-django-react/fantasy-django/fantasy-react-app/node_modules/plotly.js/src/plots/mapbox/mapbox.js"],"names":["mapboxgl","require","Lib","geoUtils","Registry","Axes","dragElement","Fx","dragHelpers","rectMode","drawMode","selectMode","prepSelect","clearSelect","clearSelectionsCache","selectOnClick","constants","createMapboxLayer","Mapbox","gd","id","fullLayout","_fullLayout","context","_context","container","_glcontainer","node","isStatic","staticPlot","uid","_uid","div","xaxis","yaxis","createFramework","map","accessToken","styleObj","traceHash","layerList","belowLookup","dragging","wheeling","proto","prototype","plot","calcData","promises","self","opts","accesstoken","remove","promise","Promise","resolve","reject","createMap","updateMap","push","getStyleObj","style","Map","center","convertCenter","zoom","bearing","pitch","interactive","preserveDrawingBuffer","doubleClickZoom","boxZoom","attributionControl","addControl","AttributionControl","compact","_canvas","left","top","rejectOnError","initFx","once","concat","fetchTraceGeoData","all","then","fillBelowLookup","updateData","updateLayout","resolveOnRender","catch","JSON","stringify","setStyle","layers","i","val","hasTraceAtTop","length","trace","_module","below","getBelow","item","val2list","k","list","indexOf","split","traceType2orderIndex","choroplethmapbox","densitymapbox","scattermapbox","traceObj","j","calcDataSorted","slice","sort","a","b","type","calcTrace","didUpdate","update","dispose","ids","Object","keys","idLoop","setCenter","setZoom","setBearing","setPitch","updateLayers","updateFramework","updateFx","resize","_scrollZoom","mapbox","scrollZoom","enable","disable","on","onRender","loaded","off","setTimeout","handler","Error","mapOnErrorMsg","document","createElement","position","appendChild","_id","c2p","v","project","x","y","mockAxis","showexponent","exponentformat","setConvert","evt","fullLayoutNow","originalEvent","optsNow","call","layout","_preGUI","getViewEdits","viewNow","getView","_input","emit","getViewEditsWithDerived","_rehover","bb","getBoundingClientRect","xy","offsetX","offsetY","target","p2c","unproject","lng","lat","_hoversubplot","hover","unhover","loneUnhover","_hoverlayer","emitUpdate","viewInitial","dragOptions","onClickInPanFn","clickMode","clickmode","click","invert","pxpy","obj","dragMode","dragmode","fillRangeItems","eventData","poly","ranges","range","xmin","ymin","xmax","ymax","pts","dataPts","lassoPoints","filtered","oldDragOptions","extendDeep","element","plotinfo","domain","xaxes","yaxes","subplot","onClickInPanHandler","dragPan","prepFn","e","startX","startY","init","onmousedown","size","_size","width","w","height","h","l","t","_offset","_length","destroy","removeChild","toImage","stop","getCanvas","toDataURL","setOptions","methodName","getMapLayers","getStyle","addLayer","mapLayers","warn","join","LngLat","mapCenter","getCenter","lon","canvas","getZoom","getBearing","getPitch","_derived","coordinates","toArray","cont","isPlainObject","styleValuesMapbox","convertStyleVal","stylesNonMapbox","styleValueDflt","transition","duration","delay","styleUrlPrefix","styleUrlSuffix","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar mapboxgl = require('mapbox-gl/dist/mapbox-gl-unminified');\r\n\r\nvar Lib = require('../../lib');\r\nvar geoUtils = require('../../lib/geo_location_utils');\r\nvar Registry = require('../../registry');\r\nvar Axes = require('../cartesian/axes');\r\nvar dragElement = require('../../components/dragelement');\r\n\r\nvar Fx = require('../../components/fx');\r\nvar dragHelpers = require('../../components/dragelement/helpers');\r\nvar rectMode = dragHelpers.rectMode;\r\nvar drawMode = dragHelpers.drawMode;\r\nvar selectMode = dragHelpers.selectMode;\r\n\r\nvar prepSelect = require('../cartesian/select').prepSelect;\r\nvar clearSelect = require('../cartesian/select').clearSelect;\r\nvar clearSelectionsCache = require('../cartesian/select').clearSelectionsCache;\r\nvar selectOnClick = require('../cartesian/select').selectOnClick;\r\n\r\nvar constants = require('./constants');\r\nvar createMapboxLayer = require('./layers');\r\n\r\nfunction Mapbox(gd, id) {\r\n    this.id = id;\r\n    this.gd = gd;\r\n\r\n    var fullLayout = gd._fullLayout;\r\n    var context = gd._context;\r\n\r\n    this.container = fullLayout._glcontainer.node();\r\n    this.isStatic = context.staticPlot;\r\n\r\n    // unique id for this Mapbox instance\r\n    this.uid = fullLayout._uid + '-' + this.id;\r\n\r\n    // create framework on instantiation for a smoother first plot call\r\n    this.div = null;\r\n    this.xaxis = null;\r\n    this.yaxis = null;\r\n    this.createFramework(fullLayout);\r\n\r\n    // state variables used to infer how and what to update\r\n    this.map = null;\r\n    this.accessToken = null;\r\n    this.styleObj = null;\r\n    this.traceHash = {};\r\n    this.layerList = [];\r\n    this.belowLookup = {};\r\n    this.dragging = false;\r\n    this.wheeling = false;\r\n}\r\n\r\nvar proto = Mapbox.prototype;\r\n\r\nproto.plot = function(calcData, fullLayout, promises) {\r\n    var self = this;\r\n    var opts = fullLayout[self.id];\r\n\r\n    // remove map and create a new map if access token has change\r\n    if(self.map && (opts.accesstoken !== self.accessToken)) {\r\n        self.map.remove();\r\n        self.map = null;\r\n        self.styleObj = null;\r\n        self.traceHash = {};\r\n        self.layerList = [];\r\n    }\r\n\r\n    var promise;\r\n\r\n    if(!self.map) {\r\n        promise = new Promise(function(resolve, reject) {\r\n            self.createMap(calcData, fullLayout, resolve, reject);\r\n        });\r\n    } else {\r\n        promise = new Promise(function(resolve, reject) {\r\n            self.updateMap(calcData, fullLayout, resolve, reject);\r\n        });\r\n    }\r\n\r\n    promises.push(promise);\r\n};\r\n\r\nproto.createMap = function(calcData, fullLayout, resolve, reject) {\r\n    var self = this;\r\n    var opts = fullLayout[self.id];\r\n\r\n    // store style id and URL or object\r\n    var styleObj = self.styleObj = getStyleObj(opts.style);\r\n\r\n    // store access token associated with this map\r\n    self.accessToken = opts.accesstoken;\r\n\r\n    // create the map!\r\n    var map = self.map = new mapboxgl.Map({\r\n        container: self.div,\r\n\r\n        style: styleObj.style,\r\n        center: convertCenter(opts.center),\r\n        zoom: opts.zoom,\r\n        bearing: opts.bearing,\r\n        pitch: opts.pitch,\r\n\r\n        interactive: !self.isStatic,\r\n        preserveDrawingBuffer: self.isStatic,\r\n\r\n        doubleClickZoom: false,\r\n        boxZoom: false,\r\n\r\n        attributionControl: false\r\n    })\r\n    .addControl(new mapboxgl.AttributionControl({\r\n        compact: true\r\n    }));\r\n\r\n\r\n    // make sure canvas does not inherit left and top css\r\n    map._canvas.style.left = '0px';\r\n    map._canvas.style.top = '0px';\r\n\r\n    self.rejectOnError(reject);\r\n\r\n    if(!self.isStatic) {\r\n        self.initFx(calcData, fullLayout);\r\n    }\r\n\r\n    var promises = [];\r\n\r\n    promises.push(new Promise(function(resolve) {\r\n        map.once('load', resolve);\r\n    }));\r\n\r\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\r\n\r\n    Promise.all(promises).then(function() {\r\n        self.fillBelowLookup(calcData, fullLayout);\r\n        self.updateData(calcData);\r\n        self.updateLayout(fullLayout);\r\n        self.resolveOnRender(resolve);\r\n    }).catch(reject);\r\n};\r\n\r\nproto.updateMap = function(calcData, fullLayout, resolve, reject) {\r\n    var self = this;\r\n    var map = self.map;\r\n    var opts = fullLayout[this.id];\r\n\r\n    self.rejectOnError(reject);\r\n\r\n    var promises = [];\r\n    var styleObj = getStyleObj(opts.style);\r\n\r\n    if(JSON.stringify(self.styleObj) !== JSON.stringify(styleObj)) {\r\n        self.styleObj = styleObj;\r\n        map.setStyle(styleObj.style);\r\n\r\n        // need to rebuild trace layers on reload\r\n        // to avoid 'lost event' errors\r\n        self.traceHash = {};\r\n\r\n        promises.push(new Promise(function(resolve) {\r\n            map.once('styledata', resolve);\r\n        }));\r\n    }\r\n\r\n    promises = promises.concat(geoUtils.fetchTraceGeoData(calcData));\r\n\r\n    Promise.all(promises).then(function() {\r\n        self.fillBelowLookup(calcData, fullLayout);\r\n        self.updateData(calcData);\r\n        self.updateLayout(fullLayout);\r\n        self.resolveOnRender(resolve);\r\n    }).catch(reject);\r\n};\r\n\r\nproto.fillBelowLookup = function(calcData, fullLayout) {\r\n    var opts = fullLayout[this.id];\r\n    var layers = opts.layers;\r\n    var i, val;\r\n\r\n    var belowLookup = this.belowLookup = {};\r\n    var hasTraceAtTop = false;\r\n\r\n    for(i = 0; i < calcData.length; i++) {\r\n        var trace = calcData[i][0].trace;\r\n        var _module = trace._module;\r\n\r\n        if(typeof trace.below === 'string') {\r\n            val = trace.below;\r\n        } else if(_module.getBelow) {\r\n            // 'smart' default that depend the map's base layers\r\n            val = _module.getBelow(trace, this);\r\n        }\r\n\r\n        if(val === '') {\r\n            hasTraceAtTop = true;\r\n        }\r\n\r\n        belowLookup['trace-' + trace.uid] = val || '';\r\n    }\r\n\r\n    for(i = 0; i < layers.length; i++) {\r\n        var item = layers[i];\r\n\r\n        if(typeof item.below === 'string') {\r\n            val = item.below;\r\n        } else if(hasTraceAtTop) {\r\n            // if one or more trace(s) set `below:''` and\r\n            // layers[i].below is unset,\r\n            // place layer below traces\r\n            val = 'traces';\r\n        } else {\r\n            val = '';\r\n        }\r\n\r\n        belowLookup['layout-' + i] = val;\r\n    }\r\n\r\n    // N.B. If multiple layers have the 'below' value,\r\n    // we must clear the stashed 'below' field in order\r\n    // to make `traceHash[k].update()` and `layerList[i].update()`\r\n    // remove/add the all those layers to have preserve\r\n    // the correct layer ordering\r\n    var val2list = {};\r\n    var k, id;\r\n\r\n    for(k in belowLookup) {\r\n        val = belowLookup[k];\r\n        if(val2list[val]) {\r\n            val2list[val].push(k);\r\n        } else {\r\n            val2list[val] = [k];\r\n        }\r\n    }\r\n\r\n    for(val in val2list) {\r\n        var list = val2list[val];\r\n        if(list.length > 1) {\r\n            for(i = 0; i < list.length; i++) {\r\n                k = list[i];\r\n                if(k.indexOf('trace-') === 0) {\r\n                    id = k.split('trace-')[1];\r\n                    if(this.traceHash[id]) {\r\n                        this.traceHash[id].below = null;\r\n                    }\r\n                } else if(k.indexOf('layout-') === 0) {\r\n                    id = k.split('layout-')[1];\r\n                    if(this.layerList[id]) {\r\n                        this.layerList[id].below = null;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nvar traceType2orderIndex = {\r\n    choroplethmapbox: 0,\r\n    densitymapbox: 1,\r\n    scattermapbox: 2\r\n};\r\n\r\nproto.updateData = function(calcData) {\r\n    var traceHash = this.traceHash;\r\n    var traceObj, trace, i, j;\r\n\r\n    // Need to sort here by trace type here,\r\n    // in case traces with different `type` have the same\r\n    // below value, but sorting we ensure that\r\n    // e.g. choroplethmapbox traces will be below scattermapbox traces\r\n    var calcDataSorted = calcData.slice().sort(function(a, b) {\r\n        return (\r\n            traceType2orderIndex[a[0].trace.type] -\r\n            traceType2orderIndex[b[0].trace.type]\r\n        );\r\n    });\r\n\r\n    // update or create trace objects\r\n    for(i = 0; i < calcDataSorted.length; i++) {\r\n        var calcTrace = calcDataSorted[i];\r\n\r\n        trace = calcTrace[0].trace;\r\n        traceObj = traceHash[trace.uid];\r\n\r\n        var didUpdate = false;\r\n        if(traceObj) {\r\n            if(traceObj.type === trace.type) {\r\n                traceObj.update(calcTrace);\r\n                didUpdate = true;\r\n            } else {\r\n                traceObj.dispose();\r\n            }\r\n        }\r\n        if(!didUpdate && trace._module) {\r\n            traceHash[trace.uid] = trace._module.plot(this, calcTrace);\r\n        }\r\n    }\r\n\r\n    // remove empty trace objects\r\n    var ids = Object.keys(traceHash);\r\n    idLoop:\r\n    for(i = 0; i < ids.length; i++) {\r\n        var id = ids[i];\r\n\r\n        for(j = 0; j < calcData.length; j++) {\r\n            trace = calcData[j][0].trace;\r\n            if(id === trace.uid) continue idLoop;\r\n        }\r\n\r\n        traceObj = traceHash[id];\r\n        traceObj.dispose();\r\n        delete traceHash[id];\r\n    }\r\n};\r\n\r\nproto.updateLayout = function(fullLayout) {\r\n    var map = this.map;\r\n    var opts = fullLayout[this.id];\r\n\r\n    if(!this.dragging && !this.wheeling) {\r\n        map.setCenter(convertCenter(opts.center));\r\n        map.setZoom(opts.zoom);\r\n        map.setBearing(opts.bearing);\r\n        map.setPitch(opts.pitch);\r\n    }\r\n\r\n    this.updateLayers(fullLayout);\r\n    this.updateFramework(fullLayout);\r\n    this.updateFx(fullLayout);\r\n    this.map.resize();\r\n\r\n    if(this.gd._context._scrollZoom.mapbox) {\r\n        map.scrollZoom.enable();\r\n    } else {\r\n        map.scrollZoom.disable();\r\n    }\r\n};\r\n\r\nproto.resolveOnRender = function(resolve) {\r\n    var map = this.map;\r\n\r\n    map.on('render', function onRender() {\r\n        if(map.loaded()) {\r\n            map.off('render', onRender);\r\n            // resolve at end of render loop\r\n            //\r\n            // Need a 10ms delay (0ms should suffice to skip a thread in the\r\n            // render loop) to workaround mapbox-gl bug introduced in v1.3.0\r\n            setTimeout(resolve, 10);\r\n        }\r\n    });\r\n};\r\n\r\nproto.rejectOnError = function(reject) {\r\n    var map = this.map;\r\n\r\n    function handler() {\r\n        reject(new Error(constants.mapOnErrorMsg));\r\n    }\r\n\r\n    map.once('error', handler);\r\n    map.once('style.error', handler);\r\n    map.once('source.error', handler);\r\n    map.once('tile.error', handler);\r\n    map.once('layer.error', handler);\r\n};\r\n\r\nproto.createFramework = function(fullLayout) {\r\n    var self = this;\r\n\r\n    var div = self.div = document.createElement('div');\r\n    div.id = self.uid;\r\n    div.style.position = 'absolute';\r\n    self.container.appendChild(div);\r\n\r\n    // create mock x/y axes for hover routine\r\n    self.xaxis = {\r\n        _id: 'x',\r\n        c2p: function(v) { return self.project(v).x; }\r\n    };\r\n    self.yaxis = {\r\n        _id: 'y',\r\n        c2p: function(v) { return self.project(v).y; }\r\n    };\r\n\r\n    self.updateFramework(fullLayout);\r\n\r\n    // mock axis for hover formatting\r\n    self.mockAxis = {\r\n        type: 'linear',\r\n        showexponent: 'all',\r\n        exponentformat: 'B'\r\n    };\r\n    Axes.setConvert(self.mockAxis, fullLayout);\r\n};\r\n\r\nproto.initFx = function(calcData, fullLayout) {\r\n    var self = this;\r\n    var gd = self.gd;\r\n    var map = self.map;\r\n\r\n    // keep track of pan / zoom in user layout and emit relayout event\r\n    map.on('moveend', function(evt) {\r\n        if(!self.map) return;\r\n\r\n        var fullLayoutNow = gd._fullLayout;\r\n\r\n        // 'moveend' gets triggered by map.setCenter, map.setZoom,\r\n        // map.setBearing and map.setPitch.\r\n        //\r\n        // Here, we make sure that state updates amd 'plotly_relayout'\r\n        // are triggered only when the 'moveend' originates from a\r\n        // mouse target (filtering out API calls) to not\r\n        // duplicate 'plotly_relayout' events.\r\n\r\n        if(evt.originalEvent || self.wheeling) {\r\n            var optsNow = fullLayoutNow[self.id];\r\n            Registry.call('_storeDirectGUIEdit', gd.layout, fullLayoutNow._preGUI, self.getViewEdits(optsNow));\r\n\r\n            var viewNow = self.getView();\r\n            optsNow._input.center = optsNow.center = viewNow.center;\r\n            optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\r\n            optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\r\n            optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\r\n            gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\r\n        }\r\n        if(evt.originalEvent && evt.originalEvent.type === 'mouseup') {\r\n            self.dragging = false;\r\n        } else if(self.wheeling) {\r\n            self.wheeling = false;\r\n        }\r\n\r\n        if(fullLayoutNow._rehover) {\r\n            fullLayoutNow._rehover();\r\n        }\r\n    });\r\n\r\n    map.on('wheel', function() {\r\n        self.wheeling = true;\r\n    });\r\n\r\n    map.on('mousemove', function(evt) {\r\n        var bb = self.div.getBoundingClientRect();\r\n        var xy = [\r\n            evt.originalEvent.offsetX,\r\n            evt.originalEvent.offsetY\r\n        ];\r\n\r\n        evt.target.getBoundingClientRect = function() { return bb; };\r\n\r\n        self.xaxis.p2c = function() { return map.unproject(xy).lng; };\r\n        self.yaxis.p2c = function() { return map.unproject(xy).lat; };\r\n\r\n        gd._fullLayout._rehover = function() {\r\n            if(gd._fullLayout._hoversubplot === self.id && gd._fullLayout[self.id]) {\r\n                Fx.hover(gd, evt, self.id);\r\n            }\r\n        };\r\n\r\n        Fx.hover(gd, evt, self.id);\r\n        gd._fullLayout._hoversubplot = self.id;\r\n    });\r\n\r\n    function unhover() {\r\n        Fx.loneUnhover(fullLayout._hoverlayer);\r\n    }\r\n\r\n    map.on('dragstart', function() {\r\n        self.dragging = true;\r\n        unhover();\r\n    });\r\n    map.on('zoomstart', unhover);\r\n\r\n    map.on('mouseout', function() {\r\n        gd._fullLayout._hoversubplot = null;\r\n    });\r\n\r\n    function emitUpdate() {\r\n        var viewNow = self.getView();\r\n        gd.emit('plotly_relayouting', self.getViewEditsWithDerived(viewNow));\r\n    }\r\n\r\n    map.on('drag', emitUpdate);\r\n    map.on('zoom', emitUpdate);\r\n\r\n    map.on('dblclick', function() {\r\n        var optsNow = gd._fullLayout[self.id];\r\n        Registry.call('_storeDirectGUIEdit', gd.layout, gd._fullLayout._preGUI, self.getViewEdits(optsNow));\r\n\r\n        var viewInitial = self.viewInitial;\r\n        map.setCenter(convertCenter(viewInitial.center));\r\n        map.setZoom(viewInitial.zoom);\r\n        map.setBearing(viewInitial.bearing);\r\n        map.setPitch(viewInitial.pitch);\r\n\r\n        var viewNow = self.getView();\r\n        optsNow._input.center = optsNow.center = viewNow.center;\r\n        optsNow._input.zoom = optsNow.zoom = viewNow.zoom;\r\n        optsNow._input.bearing = optsNow.bearing = viewNow.bearing;\r\n        optsNow._input.pitch = optsNow.pitch = viewNow.pitch;\r\n\r\n        gd.emit('plotly_doubleclick', null);\r\n        gd.emit('plotly_relayout', self.getViewEditsWithDerived(viewNow));\r\n    });\r\n\r\n    // define event handlers on map creation, to keep one ref per map,\r\n    // so that map.on / map.off in updateFx works as expected\r\n    self.clearSelect = function() {\r\n        clearSelectionsCache(self.dragOptions);\r\n        clearSelect(self.dragOptions.gd);\r\n    };\r\n\r\n    /**\r\n     * Returns a click handler function that is supposed\r\n     * to handle clicks in pan mode.\r\n     */\r\n    self.onClickInPanFn = function(dragOptions) {\r\n        return function(evt) {\r\n            var clickMode = gd._fullLayout.clickmode;\r\n\r\n            if(clickMode.indexOf('select') > -1) {\r\n                selectOnClick(evt.originalEvent, gd, [self.xaxis], [self.yaxis], self.id, dragOptions);\r\n            }\r\n\r\n            if(clickMode.indexOf('event') > -1) {\r\n                // TODO: this does not support right-click. If we want to support it, we\r\n                // would likely need to change mapbox to use dragElement instead of straight\r\n                // mapbox event binding. Or perhaps better, make a simple wrapper with the\r\n                // right mousedown, mousemove, and mouseup handlers just for a left/right click\r\n                // pie would use this too.\r\n                Fx.click(gd, evt.originalEvent);\r\n            }\r\n        };\r\n    };\r\n};\r\n\r\nproto.updateFx = function(fullLayout) {\r\n    var self = this;\r\n    var map = self.map;\r\n    var gd = self.gd;\r\n\r\n    if(self.isStatic) return;\r\n\r\n    function invert(pxpy) {\r\n        var obj = self.map.unproject(pxpy);\r\n        return [obj.lng, obj.lat];\r\n    }\r\n\r\n    var dragMode = fullLayout.dragmode;\r\n    var fillRangeItems;\r\n\r\n    if(rectMode(dragMode)) {\r\n        fillRangeItems = function(eventData, poly) {\r\n            var ranges = eventData.range = {};\r\n            ranges[self.id] = [\r\n                invert([poly.xmin, poly.ymin]),\r\n                invert([poly.xmax, poly.ymax])\r\n            ];\r\n        };\r\n    } else {\r\n        fillRangeItems = function(eventData, poly, pts) {\r\n            var dataPts = eventData.lassoPoints = {};\r\n            dataPts[self.id] = pts.filtered.map(invert);\r\n        };\r\n    }\r\n\r\n    // Note: dragOptions is needed to be declared for all dragmodes because\r\n    // it's the object that holds persistent selection state.\r\n    // Merge old dragOptions with new to keep possibly initialized\r\n    // persistent selection state.\r\n    var oldDragOptions = self.dragOptions;\r\n    self.dragOptions = Lib.extendDeep(oldDragOptions || {}, {\r\n        dragmode: fullLayout.dragmode,\r\n        element: self.div,\r\n        gd: gd,\r\n        plotinfo: {\r\n            id: self.id,\r\n            domain: fullLayout[self.id].domain,\r\n            xaxis: self.xaxis,\r\n            yaxis: self.yaxis,\r\n            fillRangeItems: fillRangeItems\r\n        },\r\n        xaxes: [self.xaxis],\r\n        yaxes: [self.yaxis],\r\n        subplot: self.id\r\n    });\r\n\r\n    // Unregister the old handler before potentially registering\r\n    // a new one. Otherwise multiple click handlers might\r\n    // be registered resulting in unwanted behavior.\r\n    map.off('click', self.onClickInPanHandler);\r\n    if(selectMode(dragMode) || drawMode(dragMode)) {\r\n        map.dragPan.disable();\r\n        map.on('zoomstart', self.clearSelect);\r\n\r\n        self.dragOptions.prepFn = function(e, startX, startY) {\r\n            prepSelect(e, startX, startY, self.dragOptions, dragMode);\r\n        };\r\n\r\n        dragElement.init(self.dragOptions);\r\n    } else {\r\n        map.dragPan.enable();\r\n        map.off('zoomstart', self.clearSelect);\r\n        self.div.onmousedown = null;\r\n\r\n        // TODO: this does not support right-click. If we want to support it, we\r\n        // would likely need to change mapbox to use dragElement instead of straight\r\n        // mapbox event binding. Or perhaps better, make a simple wrapper with the\r\n        // right mousedown, mousemove, and mouseup handlers just for a left/right click\r\n        // pie would use this too.\r\n        self.onClickInPanHandler = self.onClickInPanFn(self.dragOptions);\r\n        map.on('click', self.onClickInPanHandler);\r\n    }\r\n};\r\n\r\nproto.updateFramework = function(fullLayout) {\r\n    var domain = fullLayout[this.id].domain;\r\n    var size = fullLayout._size;\r\n\r\n    var style = this.div.style;\r\n    style.width = size.w * (domain.x[1] - domain.x[0]) + 'px';\r\n    style.height = size.h * (domain.y[1] - domain.y[0]) + 'px';\r\n    style.left = size.l + domain.x[0] * size.w + 'px';\r\n    style.top = size.t + (1 - domain.y[1]) * size.h + 'px';\r\n\r\n    this.xaxis._offset = size.l + domain.x[0] * size.w;\r\n    this.xaxis._length = size.w * (domain.x[1] - domain.x[0]);\r\n\r\n    this.yaxis._offset = size.t + (1 - domain.y[1]) * size.h;\r\n    this.yaxis._length = size.h * (domain.y[1] - domain.y[0]);\r\n};\r\n\r\nproto.updateLayers = function(fullLayout) {\r\n    var opts = fullLayout[this.id];\r\n    var layers = opts.layers;\r\n    var layerList = this.layerList;\r\n    var i;\r\n\r\n    // if the layer arrays don't match,\r\n    // don't try to be smart,\r\n    // delete them all, and start all over.\r\n\r\n    if(layers.length !== layerList.length) {\r\n        for(i = 0; i < layerList.length; i++) {\r\n            layerList[i].dispose();\r\n        }\r\n\r\n        layerList = this.layerList = [];\r\n\r\n        for(i = 0; i < layers.length; i++) {\r\n            layerList.push(createMapboxLayer(this, i, layers[i]));\r\n        }\r\n    } else {\r\n        for(i = 0; i < layers.length; i++) {\r\n            layerList[i].update(layers[i]);\r\n        }\r\n    }\r\n};\r\n\r\nproto.destroy = function() {\r\n    if(this.map) {\r\n        this.map.remove();\r\n        this.map = null;\r\n        this.container.removeChild(this.div);\r\n    }\r\n};\r\n\r\nproto.toImage = function() {\r\n    this.map.stop();\r\n    return this.map.getCanvas().toDataURL();\r\n};\r\n\r\n// convenience wrapper to create set multiple layer\r\n// 'layout' or 'paint options at once.\r\nproto.setOptions = function(id, methodName, opts) {\r\n    for(var k in opts) {\r\n        this.map[methodName](id, k, opts[k]);\r\n    }\r\n};\r\n\r\nproto.getMapLayers = function() {\r\n    return this.map.getStyle().layers;\r\n};\r\n\r\n// convenience wrapper that first check in 'below' references\r\n// a layer that exist and then add the layer to the map,\r\nproto.addLayer = function(opts, below) {\r\n    var map = this.map;\r\n\r\n    if(typeof below === 'string') {\r\n        if(below === '') {\r\n            map.addLayer(opts, below);\r\n            return;\r\n        }\r\n\r\n        var mapLayers = this.getMapLayers();\r\n        for(var i = 0; i < mapLayers.length; i++) {\r\n            if(below === mapLayers[i].id) {\r\n                map.addLayer(opts, below);\r\n                return;\r\n            }\r\n        }\r\n\r\n        Lib.warn([\r\n            'Trying to add layer with *below* value',\r\n            below,\r\n            'referencing a layer that does not exist',\r\n            'or that does not yet exist.'\r\n        ].join(' '));\r\n    }\r\n\r\n    map.addLayer(opts);\r\n};\r\n\r\n// convenience method to project a [lon, lat] array to pixel coords\r\nproto.project = function(v) {\r\n    return this.map.project(new mapboxgl.LngLat(v[0], v[1]));\r\n};\r\n\r\n// get map's current view values in plotly.js notation\r\nproto.getView = function() {\r\n    var map = this.map;\r\n    var mapCenter = map.getCenter();\r\n    var center = { lon: mapCenter.lng, lat: mapCenter.lat };\r\n\r\n    var canvas = map.getCanvas();\r\n    var w = canvas.width;\r\n    var h = canvas.height;\r\n    return {\r\n        center: center,\r\n        zoom: map.getZoom(),\r\n        bearing: map.getBearing(),\r\n        pitch: map.getPitch(),\r\n        _derived: {\r\n            coordinates: [\r\n                map.unproject([0, 0]).toArray(),\r\n                map.unproject([w, 0]).toArray(),\r\n                map.unproject([w, h]).toArray(),\r\n                map.unproject([0, h]).toArray()\r\n            ]\r\n        }\r\n    };\r\n};\r\n\r\nproto.getViewEdits = function(cont) {\r\n    var id = this.id;\r\n    var keys = ['center', 'zoom', 'bearing', 'pitch'];\r\n    var obj = {};\r\n\r\n    for(var i = 0; i < keys.length; i++) {\r\n        var k = keys[i];\r\n        obj[id + '.' + k] = cont[k];\r\n    }\r\n\r\n    return obj;\r\n};\r\n\r\nproto.getViewEditsWithDerived = function(cont) {\r\n    var id = this.id;\r\n    var obj = this.getViewEdits(cont);\r\n    obj[id + '._derived'] = cont._derived;\r\n    return obj;\r\n};\r\n\r\nfunction getStyleObj(val) {\r\n    var styleObj = {};\r\n\r\n    if(Lib.isPlainObject(val)) {\r\n        styleObj.id = val.id;\r\n        styleObj.style = val;\r\n    } else if(typeof val === 'string') {\r\n        styleObj.id = val;\r\n\r\n        if(constants.styleValuesMapbox.indexOf(val) !== -1) {\r\n            styleObj.style = convertStyleVal(val);\r\n        } else if(constants.stylesNonMapbox[val]) {\r\n            styleObj.style = constants.stylesNonMapbox[val];\r\n        } else {\r\n            styleObj.style = val;\r\n        }\r\n    } else {\r\n        styleObj.id = constants.styleValueDflt;\r\n        styleObj.style = convertStyleVal(constants.styleValueDflt);\r\n    }\r\n\r\n    styleObj.transition = {duration: 0, delay: 0};\r\n\r\n    return styleObj;\r\n}\r\n\r\n// if style is part of the 'official' mapbox values, add URL prefix and suffix\r\nfunction convertStyleVal(val) {\r\n    return constants.styleUrlPrefix + val + '-' + constants.styleUrlSuffix;\r\n}\r\n\r\nfunction convertCenter(center) {\r\n    return [center.lon, center.lat];\r\n}\r\n\r\nmodule.exports = Mapbox;\r\n"]},"metadata":{},"sourceType":"script"}